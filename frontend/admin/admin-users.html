<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NERVE Admin - User Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #030305;
            --bg-card: rgba(8, 8, 12, 0.95);
            --bg-elevated: rgba(15, 15, 22, 0.9);
            --bg-glass: rgba(255, 255, 255, 0.02);
            --bg-input: rgba(0, 0, 0, 0.3);

            --gold-primary: #D4AF37;
            --gold-light: #F4D03F;
            --gold-dark: #B8860B;
            --gold-glow: rgba(212, 175, 55, 0.4);

            --cyan: #00E5FF;
            --purple: #BB86FC;
            --green: #00E676;
            --red: #FF5252;
            --orange: #FF9800;
            --blue: #42A5F5;

            --text-primary: #F0EDE6;
            --text-secondary: #9A9DA6;
            --text-muted: #5A5D66;

            --border-subtle: rgba(212, 175, 55, 0.12);
            --border-hover: rgba(212, 175, 55, 0.35);
            --border-input: rgba(255, 255, 255, 0.1);

            --role-admin: #42A5F5;
            --role-owner: #BB86FC;
            --role-user: #00E676;
            --role-viewer: #6B7280;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .bg-mesh {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            background:
                radial-gradient(ellipse 80% 50% at 20% -10%, rgba(212, 175, 55, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(0, 229, 255, 0.04) 0%, transparent 40%);
        }

        .grid-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            background-image:
                linear-gradient(rgba(212, 175, 55, 0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(212, 175, 55, 0.015) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(ellipse 70% 50% at 50% 20%, black 20%, transparent 70%);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 3px; }

        /* Admin Header - Same as dashboard */
        .admin-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .header-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            height: 70px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .admin-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .brand-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 800;
            color: #000;
            box-shadow: 0 4px 20px var(--gold-glow);
        }

        .brand-text { display: flex; flex-direction: column; }

        .brand-name {
            font-size: 1.35rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--gold-light), var(--gold-primary), var(--gold-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 0.05em;
            line-height: 1.1;
        }

        .brand-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .header-nav {
            display: flex;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.25s;
            position: relative;
        }

        .nav-link:hover { color: var(--text-primary); background: rgba(255, 255, 255, 0.03); }
        .nav-link.active { color: var(--gold-primary); background: rgba(212, 175, 55, 0.1); }
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background: var(--gold-primary);
            border-radius: 1px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-btn {
            padding: 10px 18px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Outfit', sans-serif;
        }

        .header-btn:hover {
            background: rgba(212, 175, 55, 0.08);
            border-color: var(--border-hover);
            color: var(--gold-primary);
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 14px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
        }

        .user-avatar {
            width: 34px;
            height: 34px;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            color: #000;
        }

        .user-info { display: flex; flex-direction: column; }
        .user-name { font-size: 0.85rem; font-weight: 600; color: var(--text-primary); line-height: 1.2; }
        .role-tag { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .role-tag.admin { color: var(--role-admin); }
        .role-tag.owner { color: var(--role-owner); }

        .breadcrumbs {
            padding: 12px 32px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }

        .breadcrumb-item { color: var(--text-muted); text-decoration: none; transition: color 0.2s; }
        .breadcrumb-item:hover { color: var(--gold-primary); }
        .breadcrumb-item.current { color: var(--text-secondary); }
        .breadcrumb-sep { color: var(--text-muted); opacity: 0.5; }

        /* Main Content */
        .admin-content {
            padding: 32px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .page-header-left h1 {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .page-header-left p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            border: none;
            font-family: 'Outfit', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--gold-glow);
        }

        .btn-secondary {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            border-color: var(--border-hover);
            color: var(--gold-primary);
        }

        .btn-danger {
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
            color: var(--red);
        }

        .btn-danger:hover {
            background: rgba(255, 82, 82, 0.2);
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 0.8rem;
        }

        /* Filters & Search */
        .filters-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 18px 12px 44px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.25s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .search-input::placeholder { color: var(--text-muted); }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1rem;
        }

        .filter-select {
            padding: 12px 36px 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%239A9DA6' d='M5 7L1 3h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            min-width: 140px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--gold-primary);
        }

        /* Data Table */
        .table-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .data-table th {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(0, 0, 0, 0.2);
        }

        .data-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .data-table th.sortable:hover {
            color: var(--gold-primary);
        }

        .data-table th.sorted {
            color: var(--gold-primary);
        }

        .data-table tbody tr {
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .user-cell-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--cyan), var(--purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 700;
            color: #000;
            flex-shrink: 0;
        }

        .user-cell-info { display: flex; flex-direction: column; }
        .user-cell-name { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; }
        .user-cell-email { font-size: 0.8rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

        .role-badge {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            display: inline-block;
        }

        .role-badge.super_admin {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .role-badge.owner {
            background: rgba(187, 134, 252, 0.15);
            color: var(--role-owner);
            border: 1px solid rgba(187, 134, 252, 0.3);
        }

        .role-badge.admin {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .role-badge.analyst {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .role-badge.company_user {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .role-badge.user {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .role-badge.demo {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .role-badge.viewer {
            background: rgba(107, 114, 128, 0.15);
            color: var(--role-viewer);
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .status-cell {
            text-align: center;
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
            cursor: help;
        }

        .status-dot.active {
            background: #10b981;
            color: #10b981;
        }

        .status-dot.locked {
            background: #ef4444;
            color: #ef4444;
        }

        .status-dot.pending {
            background: #D4AF37;
            color: #D4AF37;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 12px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Outfit', sans-serif;
        }

        .action-btn:hover {
            border-color: var(--border-hover);
            color: var(--gold-primary);
        }

        .action-btn.danger:hover {
            border-color: var(--red);
            color: var(--red);
        }

        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-top: 1px solid var(--border-subtle);
        }

        .pagination-info {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            border-color: var(--border-hover);
            color: var(--gold-primary);
        }

        .page-btn.active {
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border-color: transparent;
            color: #000;
            font-weight: 600;
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }

        .modal-overlay.active { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gold-primary);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .modal-body { padding: 28px; }

        .modal-footer {
            padding: 20px 28px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Form Elements */
        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-input);
            border: 1px solid var(--border-input);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.25s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .form-input::placeholder { color: var(--text-muted); }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239A9DA6' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .checkbox-item input { display: none; }

        .checkbox-box {
            width: 22px;
            height: 22px;
            background: var(--bg-input);
            border: 2px solid var(--border-input);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: transparent;
            font-size: 0.8rem;
        }

        .checkbox-item input:checked + .checkbox-box {
            background: var(--gold-primary);
            border-color: var(--gold-primary);
            color: #000;
        }

        .checkbox-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Activity List in Modal */
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .activity-item:last-child { border-bottom: none; }

        .activity-icon {
            width: 32px;
            height: 32px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .activity-content { flex: 1; }
        .activity-text { font-size: 0.9rem; color: var(--text-primary); margin-bottom: 4px; }
        .activity-meta { font-size: 0.75rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

        /* Reset Link Display */
        .reset-link-display {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 16px;
            margin: 16px 0;
        }

        .reset-link-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--gold-primary);
            word-break: break-all;
            padding: 12px;
            background: rgba(212, 175, 55, 0.05);
            border-radius: 6px;
            margin-bottom: 12px;
        }

        /* Impersonation Banner */
        .impersonate-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--orange), #FF5722);
            color: #000;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            font-weight: 600;
            z-index: 200;
        }

        .impersonate-banner .btn {
            padding: 6px 16px;
            background: rgba(0, 0, 0, 0.2);
            color: #000;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            padding: 16px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-left: 4px solid var(--green); }
        .toast.error { border-left: 4px solid var(--red); }
        .toast.info { border-left: 4px solid var(--cyan); }

        .toast-icon { font-size: 1.25rem; }
        .toast.success .toast-icon { color: var(--green); }
        .toast.error .toast-icon { color: var(--red); }
        .toast.info .toast-icon { color: var(--cyan); }

        .toast-message { flex: 1; font-size: 0.9rem; color: var(--text-primary); }
        .toast-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 24px;
            color: var(--text-muted);
        }

        .empty-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }

        /* Responsive */
        @media (max-width: 1200px) {
            .header-nav { display: none; }
        }

        @media (max-width: 768px) {
            .admin-content { padding: 20px; }
            .filters-bar { flex-direction: column; }
            .search-box { min-width: 100%; }
            .form-row { grid-template-columns: 1fr; }
            .data-table { display: block; overflow-x: auto; }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-in { animation: fadeIn 0.5s ease-out forwards; }

        /* Password Options */
        .password-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .radio-option:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .radio-option input[type="radio"] {
            cursor: pointer;
            accent-color: var(--gold-primary);
        }

        .radio-option span {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .password-display-box {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .password-display-box code {
            flex: 1;
            min-width: 200px;
            background: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 16px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--gold-primary);
            user-select: all;
        }

        .btn-copy {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #10b981;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.2s;
        }

        .btn-copy:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .form-note {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .form-note.warning {
            color: #f59e0b;
        }
    </style>
</head>
<body>
    <div class="bg-mesh"></div>
    <div class="grid-overlay"></div>

    <!-- Admin Header -->
    <header class="admin-header">
        <div class="header-main">
            <div class="header-left">
                <a href="/admin/dashboard" class="admin-brand">
                    <div class="brand-icon">N</div>
                    <div class="brand-text">
                        <span class="brand-name">NERVE</span>
                        <span class="brand-subtitle">Admin Console</span>
                    </div>
                </a>
                <nav class="header-nav">
                    <a href="/admin/dashboard" class="nav-link">Dashboard</a>
                    <a href="/admin/users" class="nav-link active">Users</a>
                    <a href="/admin/companies" class="nav-link">Companies</a>
                    <a href="/admin/system" class="nav-link">System</a>
                    <a href="/admin/logs" class="nav-link">Logs</a>
                    <a href="/admin/settings" class="nav-link">Settings</a>
                </nav>
            </div>
            <div class="header-right">
                <a href="/dashboard" class="header-btn"><span>&#8592;</span><span>View Site</span></a>
                <a href="/profile" class="header-btn"><span>&#128100;</span><span>Profile</span></a>
                <div class="user-badge">
                    <div class="user-avatar" id="adminAvatar">--</div>
                    <div class="user-info">
                        <span class="user-name" id="adminName">Loading...</span>
                        <span class="role-tag admin" id="adminRole">ADMIN</span>
                    </div>
                </div>
                <button class="header-btn" onclick="logout()"><span>&#9211;</span><span>Logout</span></button>
            </div>
        </div>
        <div class="breadcrumbs">
            <a href="/dashboard" class="breadcrumb-item">NERVE</a>
            <span class="breadcrumb-sep">&#8250;</span>
            <a href="/admin/dashboard" class="breadcrumb-item">Admin</a>
            <span class="breadcrumb-sep">&#8250;</span>
            <span class="breadcrumb-item current">Users</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="admin-content">
        <div class="page-header animate-in">
            <div class="page-header-left">
                <h1>User Management</h1>
                <p>Manage platform users, roles, and permissions</p>
            </div>
            <button class="btn btn-primary" onclick="openCreateUserModal()">
                <span>+</span>
                <span>Create User</span>
            </button>
        </div>

        <!-- Filters -->
        <div class="filters-bar animate-in">
            <div class="search-box">
                <span class="search-icon">&#128269;</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Search users by name or email..." oninput="debounceSearch()">
            </div>
            <select class="filter-select" id="roleFilter" onchange="loadUsers()">
                <option value="">All Roles</option>
                <option value="owner">Owner</option>
                <option value="admin">Admin</option>
                <option value="analyst">Analyst</option>
                <option value="user">User</option>
                <option value="viewer">Viewer</option>
            </select>
            <select class="filter-select" id="statusFilter" onchange="loadUsers()">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="locked">Locked</option>
                <option value="pending">Pending</option>
            </select>
            <select class="filter-select" id="companyFilter" onchange="loadUsers()">
                <option value="">All Companies</option>
            </select>
        </div>

        <!-- Users Table -->
        <div class="table-card animate-in">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="name" onclick="sortBy('name')">User</th>
                        <th class="sortable" data-sort="role" onclick="sortBy('role')">Role</th>
                        <th>Company</th>
                        <th class="sortable" data-sort="status" onclick="sortBy('status')">Status</th>
                        <th class="sortable" data-sort="last_login" onclick="sortBy('last_login')">Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-icon">&#128100;</div>
                                <p>Loading users...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination" id="pagination">
                <div class="pagination-info" id="paginationInfo">Showing 0 of 0 users</div>
                <div class="pagination-controls" id="paginationControls"></div>
            </div>
        </div>
    </main>

    <!-- Create/Edit User Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="userModalTitle">Create User</h2>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="userFullName" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="userEmail" placeholder="user@example.com" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="userRole" required>
                                <option value="">Select Role</option>
                                <option value="USER">User</option>
                                <option value="ANALYST">Analyst</option>
                                <option value="COMPANY_USER">Company User</option>
                                <option value="ADMIN" id="adminRoleOption">Admin</option>
                                <option value="SUPER_ADMIN" id="ownerRoleOption">Super Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company</label>
                            <select class="form-select" id="userCompany">
                                <option value="">No Company</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="passwordOptionsGroup">
                        <label class="form-label">Password Setup</label>
                        <div class="password-options">
                            <label class="radio-option">
                                <input type="radio" name="passwordMode" value="auto" checked onchange="togglePasswordMode()">
                                <span>Auto-generate temporary password</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="passwordMode" value="manual" onchange="togglePasswordMode()">
                                <span>Set password manually</span>
                            </label>
                        </div>

                        <!-- Manual password input (hidden by default) -->
                        <div id="manualPasswordSection" style="display: none;">
                            <input type="password" class="form-input" id="manualPassword" placeholder="Enter password (min 8 characters)">
                            <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm password" style="margin-top: 8px;">
                            <p class="form-note">Password will be shown to you after user creation</p>
                        </div>

                        <!-- Auto-generated password display area (shown after creation) -->
                        <div id="generatedPasswordDisplay" style="display: none; margin-top: 12px;">
                            <div class="password-display-box">
                                <strong style="color: var(--text-secondary);">Generated Password:</strong>
                                <code id="displayedPassword"></code>
                                <button type="button" onclick="copyPassword()" class="btn-copy">Copy</button>
                            </div>
                            <p class="form-note warning">Save this password now - it won't be shown again!</p>
                        </div>
                    </div>
                    <div class="form-group" id="sendEmailGroup">
                        <label class="checkbox-item">
                            <input type="checkbox" id="sendWelcomeEmail">
                            <span class="checkbox-box">&#10003;</span>
                            <span class="checkbox-label">Send welcome email (optional)</span>
                        </label>
                        <p class="form-note">Email system may not be configured. Manually share credentials with user.</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveUser()" id="saveUserBtn">Create User</button>
            </div>
        </div>
    </div>

    <!-- View Activity Modal -->
    <div class="modal-overlay" id="activityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">User Activity</h2>
                <button class="modal-close" onclick="closeModal('activityModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="activity-list" id="userActivityList">
                    <div class="empty-state">Loading activity...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('activityModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal-overlay" id="resetPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Password Reset Link</h2>
                <button class="modal-close" onclick="closeModal('resetPasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">A password reset link has been generated. Share this link with the user:</p>
                <div class="reset-link-display">
                    <div class="reset-link-value" id="resetLinkValue">Loading...</div>
                    <button class="btn btn-secondary btn-sm" onclick="copyResetLink()">&#128203; Copy Link</button>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-muted);">This link will expire in 24 hours.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('resetPasswordModal')">Done</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="confirmModalTitle">Confirm Action</h2>
                <button class="modal-close" onclick="closeModal('confirmModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary);" id="confirmModalText">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmModalAction">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API_URL = 'http://localhost:5000';
        let currentUser = null;
        let usersData = [];
        let currentPage = 1;
        let totalPages = 1;
        let sortField = 'name';
        let sortOrder = 'asc';
        let searchTimeout = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAdminAccess();
            await loadCompanies();
            await loadUsers();
            handleUrlParams();
        });

        async function checkAdminAccess() {
            const token = localStorage.getItem('session_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }

                currentUser = await response.json();

                if (!['admin', 'owner', 'super_admin'].includes(currentUser.role)) {
                    showToast('Access denied. Admin privileges required.', 'error');
                    setTimeout(() => window.location.href = '/dashboard', 2000);
                    return;
                }

                updateAdminHeader();
                applyRoleRestrictions();
            } catch (error) {
                window.location.href = '/login';
            }
        }

        function updateAdminHeader() {
            if (!currentUser) return;
            const initials = getInitials(currentUser.full_name || currentUser.email);
            document.getElementById('adminAvatar').textContent = initials;
            document.getElementById('adminName').textContent = currentUser.full_name || currentUser.email.split('@')[0];
            const roleTag = document.getElementById('adminRole');
            roleTag.textContent = currentUser.role.toUpperCase();
            roleTag.className = `role-tag ${currentUser.role === 'owner' ? 'owner' : 'admin'}`;
        }

        function applyRoleRestrictions() {
            // Only super admins can assign admin/super admin roles
            if (!['owner', 'SUPER_ADMIN', 'super_admin'].includes(currentUser.role)) {
                document.getElementById('adminRoleOption').disabled = true;
                document.getElementById('ownerRoleOption').disabled = true;
            }
        }

        async function loadCompanies() {
            try {
                const response = await fetch(`${API_URL}/api/admin/companies`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const data = await response.json();
                    const companies = data.companies || data || [];
                    populateCompanyDropdowns(companies);
                }
            } catch (error) {
                // Use mock companies
                populateCompanyDropdowns([
                    { id: 1, name: 'Acme Corp' },
                    { id: 2, name: 'TechStart Inc' },
                    { id: 3, name: 'GlobalSecure Ltd' }
                ]);
            }
        }

        function populateCompanyDropdowns(companies) {
            const filterSelect = document.getElementById('companyFilter');
            const formSelect = document.getElementById('userCompany');

            companies.forEach(company => {
                filterSelect.innerHTML += `<option value="${company.id}">${company.name}</option>`;
                formSelect.innerHTML += `<option value="${company.id}">${company.name}</option>`;
            });
        }

        async function loadUsers() {
            const search = document.getElementById('searchInput').value;
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;
            const company = document.getElementById('companyFilter').value;

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    sort: sortField,
                    order: sortOrder,
                    ...(search && { search }),
                    ...(role && { role }),
                    ...(status && { status }),
                    ...(company && { company_id: company })
                });

                const response = await fetch(`${API_URL}/api/admin/users?${params}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('[USERS] API response:', data);

                    // API returns {users: [...], total: N, page: N, total_pages: N}
                    usersData = data.users || [];
                    totalPages = data.total_pages || 1;

                    console.log('[USERS] Loaded', usersData.length, 'users');
                    renderUsers();
                    renderPagination();
                } else {
                    console.error('[USERS] API error:', response.status);
                    loadMockUsers();
                }
            } catch (error) {
                loadMockUsers();
            }
        }

        function loadMockUsers() {
            usersData = [
                { id: 1, full_name: 'John Smith', email: 'john@example.com', role: 'admin', company_name: 'Acme Corp', status: 'active', last_login_at: new Date(Date.now() - 3600000).toISOString() },
                { id: 2, full_name: 'Sarah Johnson', email: 'sarah@acme.com', role: 'analyst', company_name: 'Acme Corp', status: 'active', last_login_at: new Date(Date.now() - 86400000).toISOString() },
                { id: 3, full_name: 'Mike Wilson', email: 'mike@techstart.io', role: 'user', company_name: 'TechStart Inc', status: 'locked', last_login_at: new Date(Date.now() - 172800000).toISOString() },
                { id: 4, full_name: 'Emily Brown', email: 'emily@globalsec.com', role: 'owner', company_name: 'GlobalSecure Ltd', status: 'active', last_login_at: new Date(Date.now() - 7200000).toISOString() },
                { id: 5, full_name: 'David Lee', email: 'david@example.com', role: 'viewer', company_name: null, status: 'pending', last_login_at: null },
            ];
            totalPages = 1;
            renderUsers();
            renderPagination();
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');

            if (usersData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-icon">&#128100;</div>
                                <p>No users found</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = usersData.map(user => {
                const initials = getInitials(user.full_name || user.email);
                const canEdit = canEditUser(user);
                const canDelete = ['owner', 'SUPER_ADMIN', 'super_admin'].includes(currentUser.role);

                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-cell-avatar">${initials}</div>
                                <div class="user-cell-info">
                                    <span class="user-cell-name">${user.full_name || 'No name'}</span>
                                    <span class="user-cell-email">${user.email}</span>
                                </div>
                            </div>
                        </td>
                        <td>${getRoleBadge(user.role)}</td>
                        <td>${user.company_name || '<span style="color: var(--text-muted)">--</span>'}</td>
                        <td class="status-cell"><span class="status-dot ${user.status}" title="${user.status.charAt(0).toUpperCase() + user.status.slice(1)}"></span></td>
                        <td>${user.last_login_at ? formatRelativeTime(user.last_login_at) : '<span style="color: var(--text-muted)">Never</span>'}</td>
                        <td>
                            <div class="action-buttons">
                                ${canEdit ? `<button class="action-btn" onclick="editUser(${user.id})">Edit</button>` : ''}
                                <button class="action-btn" onclick="viewActivity(${user.id})">Activity</button>
                                <button class="action-btn" onclick="resetPassword(${user.id})">Reset</button>
                                ${user.status === 'locked'
                                    ? `<button class="action-btn" onclick="unlockUser(${user.id})">Unlock</button>`
                                    : `<button class="action-btn" onclick="lockUser(${user.id})">Lock</button>`
                                }
                                ${canEdit ? `<button class="action-btn" onclick="impersonateUser(${user.id})">Impersonate</button>` : ''}
                                ${canDelete ? `<button class="action-btn danger" onclick="deleteUser(${user.id})">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function canEditUser(user) {
            if (currentUser.role === 'owner') return true;
            if (currentUser.role === 'admin' && !['owner', 'admin'].includes(user.role)) return true;
            return false;
        }

        function renderPagination() {
            const info = document.getElementById('paginationInfo');
            const controls = document.getElementById('paginationControls');

            const start = (currentPage - 1) * 20 + 1;
            const end = Math.min(currentPage * 20, usersData.length);
            info.textContent = `Showing ${start}-${end} of ${usersData.length} users`;

            let html = `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lt;</button>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span style="padding: 0 8px; color: var(--text-muted);">...</span>`;
                }
            }

            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&gt;</button>`;
            controls.innerHTML = html;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadUsers();
        }

        function sortBy(field) {
            if (sortField === field) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortOrder = 'asc';
            }

            document.querySelectorAll('.data-table th').forEach(th => th.classList.remove('sorted'));
            document.querySelector(`[data-sort="${field}"]`)?.classList.add('sorted');

            loadUsers();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadUsers();
            }, 300);
        }

        // User Actions
        function openCreateUserModal() {
            document.getElementById('userModalTitle').textContent = 'Create User';
            document.getElementById('saveUserBtn').textContent = 'Create User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('passwordOptionsGroup').style.display = 'block';
            document.getElementById('sendEmailGroup').style.display = 'block';

            // Reset password mode to auto
            document.querySelector('input[name="passwordMode"][value="auto"]').checked = true;
            document.getElementById('manualPasswordSection').style.display = 'none';
            document.getElementById('generatedPasswordDisplay').style.display = 'none';
            document.getElementById('manualPassword').value = '';
            document.getElementById('confirmPassword').value = '';

            openModal('userModal');
        }

        function togglePasswordMode() {
            const mode = document.querySelector('input[name="passwordMode"]:checked').value;
            const manualSection = document.getElementById('manualPasswordSection');
            const generatedDisplay = document.getElementById('generatedPasswordDisplay');

            if (mode === 'manual') {
                manualSection.style.display = 'block';
                generatedDisplay.style.display = 'none';
            } else {
                manualSection.style.display = 'none';
                // Keep generated display if it was shown (after successful creation)
            }
        }

        function copyPassword() {
            const password = document.getElementById('displayedPassword').textContent;
            navigator.clipboard.writeText(password).then(() => {
                showToast('Password copied to clipboard', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = password;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Password copied to clipboard', 'success');
            });
        }

        function editUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('saveUserBtn').textContent = 'Save Changes';
            document.getElementById('userId').value = userId;
            document.getElementById('userFullName').value = user.full_name || '';
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userCompany').value = user.company_id || '';
            document.getElementById('passwordOptionsGroup').style.display = 'none';
            document.getElementById('sendEmailGroup').style.display = 'none';
            openModal('userModal');
        }

        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const isEditing = !!userId;

            // Get password mode (only for new users)
            const passwordMode = document.querySelector('input[name="passwordMode"]:checked')?.value || 'auto';
            let password = null;
            let autoPassword = true;

            // For new users, validate password if manual mode
            if (!isEditing && passwordMode === 'manual') {
                const manualPassword = document.getElementById('manualPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!manualPassword || manualPassword.length < 8) {
                    showToast('Password must be at least 8 characters', 'error');
                    return;
                }

                if (manualPassword !== confirmPassword) {
                    showToast('Passwords do not match', 'error');
                    return;
                }

                password = manualPassword;
                autoPassword = false;
            }

            const userData = {
                full_name: document.getElementById('userFullName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                company_id: document.getElementById('userCompany').value || null,
                auto_password: autoPassword,
                password: password,
                send_email: document.getElementById('sendWelcomeEmail').checked
            };

            try {
                const url = isEditing
                    ? `${API_URL}/api/admin/users/${userId}`
                    : `${API_URL}/api/admin/users`;
                const method = isEditing ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    if (isEditing) {
                        showToast('User updated successfully', 'success');
                        closeModal('userModal');
                        loadUsers();
                    } else {
                        // New user created
                        if (autoPassword && result.temporary_password) {
                            // Show the auto-generated password
                            document.getElementById('displayedPassword').textContent = result.temporary_password;
                            document.getElementById('generatedPasswordDisplay').style.display = 'block';
                            document.getElementById('saveUserBtn').textContent = 'Done';
                            document.getElementById('saveUserBtn').onclick = () => {
                                closeModal('userModal');
                                loadUsers();
                                // Reset button
                                document.getElementById('saveUserBtn').textContent = 'Create User';
                                document.getElementById('saveUserBtn').onclick = saveUser;
                            };
                            showToast('User created! Save the password below.', 'success');
                        } else if (!autoPassword) {
                            // Manual password was set
                            showToast('User created with your specified password', 'success');
                            closeModal('userModal');
                            loadUsers();
                        } else {
                            showToast('User created successfully', 'success');
                            closeModal('userModal');
                            loadUsers();
                        }
                    }
                } else {
                    showToast(result.error || 'Failed to save user', 'error');
                }
            } catch (error) {
                console.error('Save user error:', error);
                showToast('Connection error. Please try again.', 'error');
            }
        }

        async function viewActivity(userId) {
            openModal('activityModal');
            const activityList = document.getElementById('userActivityList');
            activityList.innerHTML = '<div class="empty-state">Loading activity...</div>';

            try {
                const response = await fetch(`${API_URL}/api/admin/users/${userId}/activity`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const activities = await response.json();
                    renderActivityList(activities);
                } else {
                    renderMockActivityList();
                }
            } catch (error) {
                renderMockActivityList();
            }
        }

        function renderMockActivityList() {
            const activities = [
                { action: 'Logged in', ip: '192.168.1.1', timestamp: new Date(Date.now() - 3600000).toISOString() },
                { action: 'Ran XASM scan', ip: '192.168.1.1', timestamp: new Date(Date.now() - 86400000).toISOString() },
                { action: 'Generated API key', ip: '192.168.1.1', timestamp: new Date(Date.now() - 172800000).toISOString() },
                { action: 'Updated profile', ip: '192.168.1.1', timestamp: new Date(Date.now() - 259200000).toISOString() },
            ];
            renderActivityList(activities);
        }

        function renderActivityList(activities) {
            const activityList = document.getElementById('userActivityList');
            if (activities.length === 0) {
                activityList.innerHTML = '<div class="empty-state">No activity recorded</div>';
                return;
            }

            activityList.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <div class="activity-icon">&#128203;</div>
                    <div class="activity-content">
                        <div class="activity-text">${a.action}</div>
                        <div class="activity-meta">${formatRelativeTime(a.timestamp)} - IP: ${a.ip || 'Unknown'}</div>
                    </div>
                </div>
            `).join('');
        }

        async function resetPassword(userId) {
            openModal('resetPasswordModal');
            document.getElementById('resetLinkValue').textContent = 'Generating...';

            try {
                const response = await fetch(`${API_URL}/api/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('resetLinkValue').textContent = data.reset_link;
                } else {
                    document.getElementById('resetLinkValue').textContent = `${window.location.origin}/auth/reset?token=mock_token_${userId}_${Date.now()}`;
                }
            } catch (error) {
                document.getElementById('resetLinkValue').textContent = `${window.location.origin}/auth/reset?token=mock_token_${userId}_${Date.now()}`;
            }
        }

        function copyResetLink() {
            const link = document.getElementById('resetLinkValue').textContent;
            navigator.clipboard.writeText(link).then(() => {
                showToast('Reset link copied to clipboard', 'success');
            });
        }

        async function lockUser(userId) {
            showConfirm('Lock User', 'Are you sure you want to lock this user? They will be unable to log in.', async () => {
                try {
                    await fetch(`${API_URL}/api/admin/users/${userId}/lock`, {
                        method: 'POST',
                        headers: getAuthHeaders()
                    });
                    showToast('User locked successfully', 'success');
                    loadUsers();
                } catch (error) {
                    showToast('Failed to lock user', 'error');
                }
            });
        }

        async function unlockUser(userId) {
            try {
                await fetch(`${API_URL}/api/admin/users/${userId}/unlock`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                showToast('User unlocked successfully', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to unlock user', 'error');
            }
        }

        async function impersonateUser(userId) {
            showConfirm('Impersonate User', 'You are about to view the platform as this user. This action will be logged.', async () => {
                try {
                    const response = await fetch(`${API_URL}/api/admin/users/${userId}/impersonate`, {
                        method: 'POST',
                        headers: getAuthHeaders()
                    });

                    if (response.ok) {
                        const data = await response.json();
                        localStorage.setItem('original_token', localStorage.getItem('session_token'));
                        localStorage.setItem('session_token', data.token);
                        localStorage.setItem('impersonating', data.impersonated_user.email);
                        window.location.href = '/dashboard';
                    } else {
                        showToast('Failed to impersonate user', 'error');
                    }
                } catch (error) {
                    showToast('Impersonation not available', 'error');
                }
            });
        }

        async function deleteUser(userId) {
            const user = usersData.find(u => u.id === userId);
            const userName = user ? (user.full_name || user.email) : 'this user';

            // First confirmation
            if (!confirm(`Are you sure you want to delete ${userName}?\n\nThis action cannot be undone.`)) {
                return;
            }

            // Second confirmation with final warning
            const finalConfirm = prompt(`FINAL WARNING: Deleting ${userName} will permanently remove:\n- User account\n- All scan history\n- All session data\n\nType DELETE to confirm:`);

            if (finalConfirm !== 'DELETE') {
                showToast('Deletion cancelled', 'info');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showToast('User deleted successfully', 'success');
                    loadUsers();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to delete user', 'error');
                }
            } catch (error) {
                showToast('Failed to delete user', 'error');
            }
        }

        // URL Params
        function handleUrlParams() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('action') === 'create') {
                openCreateUserModal();
            }
        }

        // Modal Helpers
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showConfirm(title, text, callback) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalText').textContent = text;
            document.getElementById('confirmModalAction').onclick = () => {
                closeModal('confirmModal');
                callback();
            };
            openModal('confirmModal');
        }

        // Utilities
        function getAuthHeaders() {
            const token = localStorage.getItem('session_token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        function getInitials(name) {
            if (!name) return '??';
            const parts = name.split(/[@\s]+/).filter(Boolean);
            if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
            return name.substring(0, 2).toUpperCase();
        }

        function getRoleBadge(role) {
            // Normalize role to lowercase for consistent mapping
            const normalizedRole = (role || 'user').toLowerCase().trim();

            const roleMap = {
                'super_admin': { label: 'SUPER_ADMIN', color: '#ef4444' },
                'admin': { label: 'ADMIN', color: '#f59e0b' },
                'analyst': { label: 'ANALYST', color: '#3b82f6' },
                'company_user': { label: 'COMPANY_USER', color: '#10b981' },
                'user': { label: 'USER', color: '#6b7280' },
                'demo': { label: 'DEMO', color: '#8b5cf6' },
                'owner': { label: 'OWNER', color: '#bb86fc' },
                'viewer': { label: 'VIEWER', color: '#6b7280' }
            };

            const roleInfo = roleMap[normalizedRole] || roleMap['user'];

            return `<span class="role-badge" style="background: ${roleInfo.color}20; color: ${roleInfo.color}; border: 1px solid ${roleInfo.color}40; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">${roleInfo.label}</span>`;
        }

        function formatRelativeTime(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function logout() {
            localStorage.removeItem('session_token');
            localStorage.removeItem('nerve_user');
            document.cookie = 'nerve_session=; path=/; max-age=0; SameSite=Lax';
            window.location.href = '/home';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const icons = { success: '&#10003;', error: '&#10007;', info: '&#8505;' };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;

            container.appendChild(toast);
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        // Close modals on escape
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>
