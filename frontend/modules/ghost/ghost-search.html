<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST - Credential Intelligence</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Global link styling */
        a {
            color: #ffd700;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        a:hover {
            color: #ff8c00;
            text-decoration: underline;
        }

        a:visited {
            color: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            margin-bottom: 30px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-left img {
            height: 70px;
        }

        .header-title h1 {
            font-size: 2.5em;
            color: #D4AF37;
            font-weight: 700;
            letter-spacing: 3px;
            margin: 0;
        }

        .header-title p {
            color: #D4AF37;
            font-size: 1em;
            margin-top: 5px;
        }

        .back-button {
            padding: 10px 20px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            color: #D4AF37;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .back-button:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
        }

        /* Search Bar */
        .search-container {
            max-width: 1000px;
            margin: 0 auto 40px;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 16px 140px 16px 24px;
            background: rgba(0,0,0,0.4);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255,215,0,0.1);
        }

        .search-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-examples {
            text-align: center;
            margin-top: 12px;
            font-size: 0.85em;
            color: #666;
        }

        .search-examples span {
            margin: 0 8px;
            padding: 4px 10px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-examples span:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #D4AF37;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            display: none;
        }

        .spinner {
            border: 3px solid rgba(212, 175, 55, 0.1);
            border-radius: 50%;
            border-top: 3px solid #D4AF37;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,215,0,0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results Container */
        .results-container {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #000000;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 20px 25px;
            margin-bottom: 25px;
        }

        .results-stats {
            display: flex;
            gap: 40px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #D4AF37;
        }

        .stat-label {
            font-size: 0.85em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 3px;
        }

        /* HIBP Stat Color Coding */
        .stat-value.hibp-safe {
            color: #10b981;
        }

        .stat-value.hibp-low {
            color: #fbbf24;
        }

        .stat-value.hibp-medium {
            color: #fb923c;
        }

        .stat-value.hibp-critical {
            color: #ef4444;
        }

        .hibp-info {
            text-align: center;
            margin-top: 10px;
            font-size: 0.8em;
            color: #888;
            font-style: italic;
        }

        .query-display {
            text-align: right;
        }

        .query-type {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .query-text {
            font-size: 1.1em;
            color: #D4AF37;
            margin-top: 3px;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .export-btn {
            padding: 10px 20px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            color: #D4AF37;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
        }

        /* FILTER SECTION - NEW */
        .filter-container {
            background: #000000;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 15px 25px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .filter-label {
            color: #D4AF37;
            font-weight: 600;
            font-size: 0.9em;
        }

        .filter-select {
            padding: 8px 15px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-select:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
        }

        .filter-select:focus {
            outline: none;
            border-color: #D4AF37;
        }

        .filter-clear {
            padding: 8px 20px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            color: #ef4444;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        }

        .filter-clear:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        /* Data Sections */
        .data-section {
            background: #000000;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .data-section.filtered-out {
            display: none;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #D4AF37;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-count {
            padding: 4px 12px;
            background: rgba(212, 175, 55, 0.2);
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            color: #D4AF37;
        }

        /* Data Items */
        .data-item {
            padding: 15px;
            background: rgba(212, 175, 55, 0.05);
            border-left: 2px solid #D4AF37;
            border-radius: 4px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .data-item:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .item-primary {
            font-size: 1em;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .item-details {
            font-size: 0.9em;
            color: #aaa;
            line-height: 1.6;
        }

        .item-meta {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(212, 175, 55, 0.1);
            font-size: 0.8em;
            color: #666;
        }

        .source-tag {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(212, 175, 55, 0.15);
            border-radius: 3px;
            margin-right: 8px;
            color: #D4AF37;
        }

        .severity-critical {
            color: #ef4444;
            font-weight: 600;
        }

        .severity-high {
            color: #f59e0b;
            font-weight: 600;
        }

        /* Attack Path Section */
        .attack-path-section {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(0, 0, 0, 0.5) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .attack-phase {
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .phase-number {
            display: inline-block;
            width: 22px;
            height: 22px;
            background: #D4AF37;
            border-radius: 50%;
            text-align: center;
            line-height: 22px;
            margin-right: 10px;
            font-weight: 600;
            font-size: 0.85em;
            color: #000;
        }

        .probability {
            float: right;
            padding: 2px 10px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 4px;
            font-size: 0.8em;
            color: #ef4444;
        }

        /* Expand Button */
        .expand-button {
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 4px;
            color: #D4AF37;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85em;
        }

        .expand-button:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: #D4AF37;
        }

        .empty-section {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 0.9em;
        }

        /* Upload Breach Button */
        .upload-breach-button {
            width: 100%;
            padding: 12px 20px;
            margin-top: 15px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: #D4AF37;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-breach-button:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
        }

        /* Search Mode Toggle */
        .search-mode-toggle {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 10px;
            justify-content: center;
        }

        .mode-toggle-btn {
            padding: 10px 30px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-toggle-btn:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: rgba(212, 175, 55, 0.5);
        }

        .mode-toggle-btn.active {
            background: #D4AF37;
            border-color: #D4AF37;
            color: #000;
            font-weight: 600;
        }

        /* Upload Modal */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #0a0a0a;
            border: 2px solid #D4AF37;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        }

        .modal-header h2 {
            color: #D4AF37;
            font-size: 1.4em;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: #D4AF37;
            font-size: 2em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: #fff;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
        }

        .beta-warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 6px;
            padding: 12px 15px;
            color: #eab308;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .file-input-container {
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: block;
            padding: 40px 20px;
            background: rgba(212, 175, 55, 0.05);
            border: 2px dashed rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            text-align: center;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-input-label:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #D4AF37;
        }

        .file-input-label.has-file {
            border-color: #D4AF37;
            color: #D4AF37;
        }

        .upload-file-btn {
            width: 100%;
            padding: 14px 20px;
            background: #D4AF37;
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-file-btn:hover:not(:disabled) {
            background: #C4A037;
        }

        .upload-file-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .upload-progress {
            margin-bottom: 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #000000;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #D4AF37 0%, #C4A037 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #D4AF37;
            font-size: 0.9em;
            font-weight: 600;
        }

        .upload-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-success p {
            color: #22c55e;
            font-size: 1em;
            margin: 0;
        }

        /* ===== ENTERPRISE UI POLISH ===== */

        /* Better Typography */
        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            letter-spacing: -0.01em;
        }

        /* Improved Card Styling */
        .card,
        [style*="background: rgba(0,0,0,0.3)"] {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .card:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 24px rgba(255,215,0,0.15) !important;
        }

        /* Better Buttons */
        button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            font-weight: 600 !important;
        }

        button:hover {
            transform: translateY(-1px) !important;
        }

        button:active {
            transform: translateY(0px) !important;
        }

        /* Input Focus States */
        input:focus,
        textarea:focus,
        select:focus {
            outline: none !important;
            border-color: #ffd700 !important;
            box-shadow: 0 0 0 3px rgba(255,215,0,0.1) !important;
        }

        /* Better Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,215,0,0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,215,0,0.5);
        }

        /* Fade In Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img src="ghost-logo.png" alt="GHOST">
            <div class="header-title">
                <h1>GHOST</h1>
                <p>Credential Intelligence</p>
            </div>
        </div>
        <a href="ghost.html" class="back-button">‚Üê Back to Dashboard</a>
    </div>

        <div class="search-container">
            <div style="display: flex; gap: 0; margin-bottom: 20px; align-items: stretch;">
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search email, domain, password, username, IP address, or keyword..."
                    style="
                        flex: 1;
                        padding: 16px 24px;
                        background: rgba(0,0,0,0.4);
                        border: 2px solid rgba(255,215,0,0.5);
                        border-right: none;
                        border-radius: 8px 0 0 8px;
                        color: #fff;
                        font-size: 15px;
                        outline: none;
                    "
                    onkeypress="if(event.key === 'Enter') performSearch()"
                    autofocus
                />
                <button
                    onclick="performSearch()"
                    style="
                        background: #ffd700;
                        border: none;
                        padding: 16px 48px;
                        border-radius: 0 8px 8px 0;
                        color: #000;
                        font-size: 15px;
                        font-weight: 700;
                        cursor: pointer;
                        transition: background 0.2s ease;
                    "
                    onmouseover="this.style.background='#e6c200'"
                    onmouseout="this.style.background='#ffd700'"
                >
                    Search
                </button>
            </div>

            <!-- Upload Button -->
            <button id="uploadButton" class="upload-breach-button">
                üìÅ Upload Your Own Breach File
            </button>

            <!-- Search Mode Toggle (hidden until file uploaded) -->
            <div id="searchModeToggle" class="search-mode-toggle" style="display: none;">
                <button id="globalModeBtn" class="mode-toggle-btn active" onclick="toggleSearchMode('global')">
                    Global Search
                </button>
                <button id="uploadedModeBtn" class="mode-toggle-btn" onclick="toggleSearchMode('uploaded')">
                    Search My File
                </button>
            </div>

            <div class="search-examples">
                <strong>Examples:</strong>
                    <span onclick="exampleSearch('test@example.com')">Email</span>
                    <span onclick="exampleSearch('example.com')">Domain</span>
                    <span onclick="exampleSearch('john_doe')">Username</span>
                    <span onclick="exampleSearch('192.168.1.1')">IP Address</span>
                    <span onclick="exampleSearch('Password123!')">Password</span>
                    <span onclick="exampleSearch('banking')">Keyword</span>
            </div>

            <!-- HIBP Info Note (shown for password queries only) -->
            <div id="hibpInfo" class="hibp-info" style="display: none;">
                Password breach count via Have I Been Pwned
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin: 32px 0;">

    <!-- LEFT: EMAIL MONITORING CARD -->
    <div id="monitoring-card" style="
        background: rgba(0,0,0,0.3);
        border: 2px solid rgba(255,215,0,0.3);
        border-radius: 12px;
        padding: 24px;
    ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h3 style="color: #ffd700; margin: 0 0 8px 0; font-size: 20px;">üìß Email Monitoring</h3>
                <p style="color: #aaa; margin: 0; font-size: 13px;">Automatically check for new breaches weekly</p>
            </div>
            <div style="
                background: rgba(255,215,0,0.2);
                color: #ffd700;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
            ">Companies Only</div>
        </div>

        <!-- Add Email Input -->
        <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <input
                    type="email"
                    id="monitor-email-input"
                    placeholder="Enter email to monitor..."
                    style="
                        flex: 1;
                        padding: 10px 14px;
                        background: rgba(255,255,255,0.05);
                        border: 1px solid rgba(255,215,0,0.3);
                        border-radius: 6px;
                        color: #fff;
                        font-size: 14px;
                    "
                />
                <button onclick="addMonitoredEmail()" style="
                    background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    color: #000;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                ">Add</button>
            </div>

            <div style="display: flex; gap: 8px;">
                <button onclick="document.getElementById('csv-upload').click()" style="
                    flex: 1;
                    background: rgba(255,215,0,0.1);
                    border: 1px solid rgba(255,215,0,0.3);
                    padding: 8px;
                    border-radius: 6px;
                    color: #ffd700;
                    cursor: pointer;
                    font-size: 13px;
                ">üìÇ Upload CSV</button>
                <input type="file" id="csv-upload" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)" />
            </div>
        </div>

        <!-- Monitored Emails List -->
        <div id="monitored-emails-list" style="
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
        ">
            <p style="color: #888; font-style: italic; font-size: 13px; text-align: center; padding: 20px;">
                No emails monitored yet. Add up to 15 emails above.
            </p>
        </div>

        <!-- Monitoring Status -->
        <div style="
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
        ">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #aaa;">Last Check:</span>
                <span style="color: #fff;" id="last-check-date">Never</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #aaa;">Next Check:</span>
                <span style="color: #ffd700;" id="next-check-date">--</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #aaa;">Alert Frequency:</span>
                <select id="alert-frequency" onchange="updateAlertFrequency()" style="
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,215,0,0.3);
                    color: #fff;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                ">
                    <option value="weekly">Weekly</option>
                    <option value="biweekly">Bi-weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>
        </div>
    </div>

    <!-- RIGHT: BREACH TIMELINE -->
    <div style="
        background: rgba(0,0,0,0.3);
        border: 2px solid rgba(255,215,0,0.3);
        border-radius: 12px;
        padding: 24px;
    ">
        <div style="margin-bottom: 20px;">
            <h3 style="color: #ffd700; margin: 0 0 8px 0; font-size: 20px;">üìä Breach Timeline</h3>
            <p style="color: #aaa; margin: 0; font-size: 13px;">Breach history for monitored emails</p>
        </div>

        <!-- Timeline Visualization -->
        <div id="breach-timeline-container" style="position: relative; height: 280px;">
            <p style="color: #888; font-style: italic; font-size: 13px; text-align: center; padding: 80px 20px;">
                Add monitored emails to see breach timeline
            </p>
        </div>
    </div>

</div>

        <div id="loadingIndicator" class="loading">
            <div class="loading-spinner"></div>
            <h3 style="color: #ffd700; margin-top: 24px;">Searching across all sources...</h3>
            <p style="color: #aaa; margin-top: 12px; font-size: 14px;">
                Querying LeakInsight, HIBP, Hudson Rock, and more...
            </p>
        </div>

        <div id="results" class="results-container">
            <div class="results-header">
                <div class="results-stats">
                    <div class="stat">
                        <div class="stat-value" id="totalFindings">0</div>
                        <div class="stat-label">Total Findings</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="credentialsCount">0</div>
                        <div class="stat-label">Credentials</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="machinesCount">0</div>
                        <div class="stat-label">Machines</div>
                    </div>
                    <!-- HIBP Pwned Passwords Stat (shown for password queries only) -->
                    <div class="stat" id="hibpStat" style="display: none;">
                        <div class="stat-value" id="hibpCount">0</div>
                        <div class="stat-label">Times Seen in Breaches</div>
                    </div>
                </div>
                <div class="query-display">
                    <div class="query-type" id="queryType">EMAIL</div>
                    <div class="query-text" id="queryText">searching...</div>
                    <div class="export-buttons">
                        <button class="export-btn" onclick="exportToJSON()">
                            <span>üì•</span> Export JSON
                        </button>
                        <button class="export-btn" onclick="exportToPDF()">
                            <span>üìÑ</span> Export PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- NEW FILTER SECTION -->
            <div class="filter-container">
                <div class="filter-label">Filter by:</div>
                <select id="filterType" class="filter-select">
                    <option value="all">All Results</option>
                    <option value="credentials">Credentials Only</option>
                    <option value="machines">Infected Machines Only</option>
                    <option value="breaches">Breach History Only</option>
                    <option value="attack">Attack Path Only</option>
                </select>
                <select id="filterSource" class="filter-select">
                    <option value="all">All Sources</option>
                    <option value="Infostealer Logs">Infostealer Logs</option>
                    <option value="Public Breach Database">Public Breach Database</option>
                    <option value="Dark Web Channels">Dark Web Channels</option>
                </select>
                <button id="clearFilters" class="filter-clear">Clear Filters</button>
            </div>

            <div id="resultsContent">
                <!-- Results populated by JavaScript -->
            </div>
        </div>

        <!-- Upload Modal -->
        <div id="uploadModal" class="upload-modal" style="display: none;">
            <div class="modal-overlay" onclick="closeUploadModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Upload Breach File (Beta)</h2>
                    <button class="modal-close" onclick="closeUploadModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="beta-warning">
                        ‚ö†Ô∏è Files are automatically deleted after 24 hours. Permanent storage coming soon.
                    </div>
                    <div class="file-input-container">
                        <input type="file" id="breachFileInput" accept=".txt,.csv" class="file-input">
                        <label for="breachFileInput" class="file-input-label">
                            <span id="fileInputText">Choose a file (.txt, .csv) - Max 2GB</span>
                        </label>
                    </div>
                    <div id="uploadProgress" class="upload-progress" style="display: none;">
                        <div class="progress-bar-container">
                            <div id="progressBar" class="progress-bar"></div>
                        </div>
                        <div id="progressText" class="progress-text">0%</div>
                    </div>
                    <div id="uploadSuccess" class="upload-success" style="display: none;">
                        <p id="uploadSuccessMessage"></p>
                    </div>
                    <button id="uploadFileButton" class="upload-file-btn" disabled onclick="uploadFile()">
                        Upload File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        let currentResults = null;
        let uploadedFileId = null;
        let currentSearchMode = 'global'; // 'global' or 'uploaded'

        // Check for query parameter from dashboard
        const urlParams = new URLSearchParams(window.location.search);
        const queryParam = urlParams.get('q');
        if (queryParam) {
            document.getElementById('search-input').value = queryParam;
            setTimeout(() => performSearch(), 500);
        }

        // Upload button event listener
        document.getElementById('uploadButton').addEventListener('click', () => {
            document.getElementById('uploadModal').style.display = 'block';
        });

        // File input change listener
        document.getElementById('breachFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const uploadBtn = document.getElementById('uploadFileButton');
            const fileLabel = document.querySelector('.file-input-label');
            const fileInputText = document.getElementById('fileInputText');

            if (file) {
                const maxSize = 2 * 1024 * 1024 * 1024; // 2GB in bytes
                if (file.size > maxSize) {
                    alert('File is too large. Maximum size is 2GB.');
                    e.target.value = '';
                    return;
                }

                const validTypes = ['.txt', '.csv'];
                const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                if (!validTypes.includes(fileExt)) {
                    alert('Invalid file type. Please upload a .txt or .csv file.');
                    e.target.value = '';
                    return;
                }

                fileInputText.textContent = file.name;
                fileLabel.classList.add('has-file');
                uploadBtn.disabled = false;
            } else {
                fileInputText.textContent = 'Choose a file (.txt, .csv) - Max 2GB';
                fileLabel.classList.remove('has-file');
                uploadBtn.disabled = true;
            }
        });

        // FILTER EVENT LISTENERS - NEW
        document.getElementById('filterType').addEventListener('change', applyFilters);
        document.getElementById('filterSource').addEventListener('change', applyFilters);
        document.getElementById('clearFilters').addEventListener('click', clearFilters);

        function exampleSearch(query) {
            document.getElementById('search-input').value = query;
            performSearch();
        }

        // Close upload modal
        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            // Reset modal state
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadSuccess').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
        }

        // Upload file function
        async function uploadFile() {
            const fileInput = document.getElementById('breachFileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const uploadBtn = document.getElementById('uploadFileButton');
            const progressDiv = document.getElementById('uploadProgress');
            const successDiv = document.getElementById('uploadSuccess');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            uploadBtn.disabled = true;
            progressDiv.style.display = 'block';
            successDiv.style.display = 'none';

            try {
                const xhr = new XMLHttpRequest();

                // Progress tracking
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percentComplete + '%';
                        progressText.textContent = percentComplete + '%';
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);

                        if (response.success) {
                            // Store upload ID
                            uploadedFileId = response.upload_id;

                            // Show success message
                            const successMsg = document.getElementById('uploadSuccessMessage');
                            successMsg.textContent = `‚úì Uploaded! Found ${response.total_credentials} credentials in ${response.total_lines} lines`;
                            successDiv.style.display = 'block';
                            progressDiv.style.display = 'none';

                            // Show search mode toggle
                            document.getElementById('searchModeToggle').style.display = 'flex';

                            // Auto-close modal after 2 seconds
                            setTimeout(() => {
                                closeUploadModal();
                            }, 2000);
                        } else {
                            alert('Upload failed: ' + (response.error || 'Unknown error'));
                            progressDiv.style.display = 'none';
                        }
                    } else {
                        alert('Upload failed. Server returned status: ' + xhr.status);
                        progressDiv.style.display = 'none';
                    }
                    uploadBtn.disabled = false;
                });

                xhr.addEventListener('error', () => {
                    alert('Upload failed. Please check your connection.');
                    progressDiv.style.display = 'none';
                    uploadBtn.disabled = false;
                });

                xhr.open('POST', `${API_URL}/api/ghost/upload-breach-file`);
                xhr.send(formData);

            } catch (error) {
                alert('Upload error: ' + error.message);
                progressDiv.style.display = 'none';
                uploadBtn.disabled = false;
            }
        }

        // Toggle search mode
        function toggleSearchMode(mode) {
            currentSearchMode = mode;

            const globalBtn = document.getElementById('globalModeBtn');
            const uploadedBtn = document.getElementById('uploadedModeBtn');

            if (mode === 'global') {
                globalBtn.classList.add('active');
                uploadedBtn.classList.remove('active');
            } else if (mode === 'uploaded') {
                if (!uploadedFileId) {
                    alert('Please upload a file first');
                    return;
                }
                globalBtn.classList.remove('active');
                uploadedBtn.classList.add('active');
            }
        }

        async function performSearch() {
            const input = document.getElementById('search-input');
            const query = input ? input.value.trim() : '';

            if (!query) {
                alert('Please enter a search query');
                return;
            }

            console.log('[SEARCH] Starting search for:', query);

            // Show loading state
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div class="loading-spinner"></div>
                        <h3 style="color: #ffd700; margin-top: 24px;">Searching across all sources...</h3>
                        <p style="color: #aaa; margin-top: 12px; font-size: 14px;">This may take a few moments</p>
                    </div>
                `;
            }

            try {
                const response = await fetch('http://localhost:5000/api/search/unified', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        search_type: 'auto'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('[SEARCH] Results received:', data);

                // Display results using existing display function
                if (typeof displayResults === 'function') {
                    displayResults(data);
                } else {
                    // Fallback: show raw data if display function missing
                    if (resultsDiv) {
                        resultsDiv.innerHTML = `
                            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px;">
                                <h3 style="color: #ffd700; margin-bottom: 16px;">
                                    Found ${data.total_results || 0} results from ${data.sources_searched?.length || 0} sources
                                </h3>
                                <div style="color: #aaa; font-size: 14px; margin-bottom: 12px;">
                                    Sources: ${data.sources_searched?.join(', ') || 'None'}
                                </div>
                                <pre style="color: #fff; overflow-x: auto; font-size: 12px;">
${JSON.stringify(data.results?.slice(0, 5) || [], null, 2)}
                                </pre>
                            </div>
                        `;
                    }
                }

            } catch (error) {
                console.error('[SEARCH] Error:', error);
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                            <h3 style="color: #dc3545; margin-bottom: 12px;">Search Failed</h3>
                            <p style="color: #aaa; margin-bottom: 8px;">${error.message}</p>
                            <p style="color: #888; font-size: 13px;">Check console (F12) for details</p>
                        </div>
                    `;
                }
            }
        }

        // Helper to extract domain from email
        function extractDomain(email) {
            if (!email) return 'Unknown';
            const parts = email.split('@');
            return parts.length > 1 ? parts[1] : 'Unknown';
        }

        // Toggle password visibility
        function togglePassword(uniqueId, password) {
            const element = document.getElementById(`pwd-${uniqueId}`);
            const button = event.target;

            if (!element) return;

            if (element.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                element.textContent = password;
                button.textContent = 'Hide';
            } else {
                element.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                button.textContent = 'Show';
            }
        }

        // Display results from uploaded file
        function displayUploadedResults(result) {
            currentResults = result;

            document.getElementById('queryType').textContent = 'USER FILE';
            document.getElementById('queryText').textContent = result.query;
            document.getElementById('totalFindings').textContent = result.total_findings;

            // Hide HIBP elements for uploaded file searches
            document.getElementById('hibpStat').style.display = 'none';
            document.getElementById('hibpInfo').style.display = 'none';

            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = '';

            // Build credentials section from uploaded file data
            const uploadData = result.results.user_upload.data;
            document.getElementById('credentialsCount').textContent = uploadData.length;
            document.getElementById('machinesCount').textContent = 0;

            if (uploadData.length > 0) {
                const credSection = buildUploadedCredentialsSection(uploadData);
                credSection.setAttribute('data-section-type', 'credentials');
                resultsContent.appendChild(credSection);
            } else {
                resultsContent.innerHTML = '<div class="empty-section">No matches found in uploaded file</div>';
            }

            document.getElementById('results').style.display = 'block';
        }

        // Build credentials section for uploaded file results
        function buildUploadedCredentialsSection(credentials) {
            const section = document.createElement('div');
            section.className = 'data-section fade-in';
            section.style.marginBottom = '32px';

            const showCount = 5;
            const hasMore = credentials.length > showCount;

            section.innerHTML = `
                <div class="section-header">
                    <span class="section-title">Found in Your File</span>
                    <span class="section-count">${credentials.length} found</span>
                </div>
            `;

            const itemsContainer = document.createElement('div');

            credentials.slice(0, showCount).forEach(cred => {
                const item = document.createElement('div');
                item.className = 'data-item';

                item.innerHTML = `
                    <div class="item-primary">${cred.email || cred.username || 'N/A'}</div>
                    <div class="item-details">
                        ${cred.email ? `Email: <strong>${cred.email}</strong><br>` : ''}
                        ${cred.username ? `Username: <strong>${cred.username}</strong><br>` : ''}
                        ${cred.password ? `Password: <strong class="severity-critical">${cred.password}</strong>` : ''}
                    </div>
                `;
                itemsContainer.appendChild(item);
            });

            section.appendChild(itemsContainer);

            if (hasMore) {
                const hiddenContainer = document.createElement('div');
                hiddenContainer.style.display = 'none';
                hiddenContainer.id = 'hidden-uploaded-creds';

                credentials.slice(showCount).forEach(cred => {
                    const item = document.createElement('div');
                    item.className = 'data-item';

                    item.innerHTML = `
                        <div class="item-primary">${cred.email || cred.username || 'N/A'}</div>
                        <div class="item-details">
                            ${cred.email ? `Email: <strong>${cred.email}</strong><br>` : ''}
                            ${cred.username ? `Username: <strong>${cred.username}</strong><br>` : ''}
                            ${cred.password ? `Password: <strong class="severity-critical">${cred.password}</strong>` : ''}
                        </div>
                    `;
                    hiddenContainer.appendChild(item);
                });

                section.appendChild(hiddenContainer);

                const expandBtn = document.createElement('div');
                expandBtn.className = 'expand-button';
                expandBtn.innerHTML = `Show ${credentials.length - showCount} more credentials`;
                expandBtn.onclick = () => {
                    const hidden = document.getElementById('hidden-uploaded-creds');
                    if (hidden.style.display === 'none') {
                        hidden.style.display = 'block';
                        expandBtn.innerHTML = 'Show less';
                    } else {
                        hidden.style.display = 'none';
                        expandBtn.innerHTML = `Show ${credentials.length - showCount} more credentials`;
                    }
                };
                section.appendChild(expandBtn);
            }

            return section;
        }

        function displayResults(data) {
            console.log('[DISPLAY] Processing results:', data);

            const resultsDiv = document.getElementById('results');
            console.log('[DISPLAY] Results div found:', resultsDiv);
            console.log('[DISPLAY] Results div visible:', resultsDiv ? window.getComputedStyle(resultsDiv).display : 'N/A');

            // Hide monitoring and timeline cards when results appear
            const monitoringCard = document.querySelector('#monitoring-card') ||
                                   document.querySelector('[style*="Email Monitoring"]')?.closest('div');
            const timelineCard = document.querySelector('[style*="Breach Timeline"]')?.closest('div');

            if (monitoringCard) monitoringCard.style.display = 'none';
            if (timelineCard) timelineCard.style.display = 'none';

            if (!resultsDiv) {
                console.error('[DISPLAY] Results div not found!');
                return;
            }

            resultsDiv.style.display = 'block';

            if (!data.results || data.total_findings === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <h3 style="color: #22c55e; margin-bottom: 12px;">No Results Found</h3>
                        <p style="color: #888;">No breaches or exposures found for this query.</p>
                    </div>
                `;
                return;
            }

            // Flatten results - API returns {source: {data: [], count: N}}
            let allResults = [];

            Object.keys(data.results).forEach(sourceName => {
                const sourceData = data.results[sourceName];

                // Check if this source has data
                if (sourceData && sourceData.data && Array.isArray(sourceData.data)) {
                    sourceData.data.forEach(result => {
                        allResults.push({
                            ...result,
                            source: sourceName,
                            data_type: sourceData.type // Add type from source metadata
                        });
                    });
                }
            });

            console.log('[DISPLAY] Flattened results:', allResults);
            console.log('[DISPLAY] Total flattened:', allResults.length);

            console.log('[DISPLAY] About to render HTML for', allResults.length, 'results');

            // Display header
            let html = `
                <div style="margin-bottom: 24px; padding: 20px; background: rgba(220,53,69,0.1); border-left: 4px solid #dc3545; border-radius: 8px;">
                    <h3 style="color: #dc3545; margin: 0 0 8px 0;">‚ö†Ô∏è ${data.total_findings} Results Found</h3>
                    <p style="color: #aaa; margin: 0; font-size: 14px;">
                        Found across ${data.sources_queried?.length || 0} sources
                    </p>
                </div>
            `;

            // Group by data type
            const stealerLogs = allResults.filter(r => r.data_type === 'stealer_log' || r.computer_name);
            const credentials = allResults.filter(r => r.data_type === 'credential' || r.email || r.username);
            const breaches = allResults.filter(r => r.data_type === 'breach');

            // Display Stealer Logs (Infected Machines)
            console.log('[DISPLAY] Rendering', stealerLogs.length, 'stealer logs');
            if (stealerLogs.length > 0) {
                const displayCount = 10;

                html += `
                    <div class="fade-in" style="margin-bottom: 32px;" id="infected-machines-section">
                        <h3 style="color: #ffd700; margin-bottom: 16px;">
                            ü¶† Infected Machines (${stealerLogs.length})
                        </h3>
                `;

                stealerLogs.forEach((log, index) => {
                    const isHidden = index >= displayCount;
                    const displayStyle = isHidden ? 'display: none;' : '';
                    const hiddenClass = isHidden ? 'hidden-machine' : '';

                    html += `
                        <div class="${hiddenClass}" style="${displayStyle} background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 20px; margin-bottom: 12px;">
                            <div style="color: #ffd700; font-weight: 600; margin-bottom: 8px;">
                                ${log.computer_name || 'Unknown Computer'}
                            </div>
                            <div style="color: #aaa; font-size: 13px;">
                                Stealer: ${log.malware_family || log.malware_path || 'Unknown'}<br>
                                Infected: ${log.infection_date || log.date_compromised || 'Unknown'}
                            </div>
                        </div>
                    `;
                });

                if (stealerLogs.length > displayCount) {
                    html += `
                        <div id="show-more-machines-btn" style="text-align: center; margin-top: 16px;">
                            <button onclick="showMoreResults('stealer_logs')" style="
                                background: rgba(255,215,0,0.2);
                                border: 1px solid #ffd700;
                                color: #ffd700;
                                padding: 10px 24px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 600;
                            ">
                                Show ${stealerLogs.length - displayCount} More Infected Machines
                            </button>
                        </div>
                    `;
                }

                html += '</div>';
            }

            // Display Credentials
            if (credentials.length > 0) {
                // Group by breach name
                const byBreach = {};
                credentials.forEach(c => {
                    const breach = c.breach_name || c.source || 'Data Breach';
                    if (!byBreach[breach]) byBreach[breach] = [];
                    byBreach[breach].push(c);
                });

                html += `
                    <div class="fade-in" style="margin-bottom: 32px;">
                        <h3 style="color: #ffd700; margin-bottom: 16px;">
                            üîë Compromised Credentials (${credentials.length} found in ${Object.keys(byBreach).length} breaches)
                        </h3>
                `;

                // Show only first 10 credentials total
                const displayCount = 10;
                let shownCount = 0;

                for (const [breach, items] of Object.entries(byBreach)) {
                    if (shownCount >= displayCount) break;

                    html += `
                        <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 20px; margin-bottom: 12px;">
                            <div style="margin-bottom: 12px;">
                                <h4 style="color: #ffd700; margin: 0;">${breach}</h4>
                                <span style="color: #888; font-size: 13px;">${items.length} credential${items.length > 1 ? 's' : ''}</span>
                            </div>
                    `;

                    // Show only first 3 credentials per breach
                    const itemsToShow = items.slice(0, Math.min(3, displayCount - shownCount));

                    itemsToShow.forEach((item, idx) => {
                        const uniqueId = `${breach.replace(/\s/g, '_')}_${shownCount}_${idx}`;

                        html += `
                            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                                <div style="color: #ffd700;">${item.email || item.username || 'N/A'}</div>
                                ${item.password && item.password !== 'premium' && item.password !== 'You must have a premium subscription to view this password.' ? `
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 6px;">
                                        <span style="color: #aaa; font-size: 12px;">Password:</span>
                                        <span id="pwd-${uniqueId}" style="color: #fff; font-family: monospace;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                        <button onclick="togglePassword('${uniqueId}', '${item.password.replace(/'/g, "\\'")}')" style="
                                            background: rgba(255,215,0,0.2);
                                            border: 1px solid #ffd700;
                                            color: #ffd700;
                                            padding: 4px 12px;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-size: 11px;
                                        ">Show</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        shownCount++;
                    });

                    if (items.length > 3) {
                        html += `<div style="color: #888; font-size: 12px; margin-top: 8px;">+${items.length - 3} more in this breach</div>`;
                    }

                    html += '</div>';
                }

                if (credentials.length > displayCount) {
                    html += `
                        <div style="text-align: center; margin-top: 16px;">
                            <button onclick="showMoreResults('credentials')" style="
                                background: rgba(255,215,0,0.2);
                                border: 1px solid #ffd700;
                                color: #ffd700;
                                padding: 10px 24px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 600;
                            ">
                                Show ${credentials.length - displayCount} More Credentials
                            </button>
                        </div>
                    `;
                }

                html += '</div>';
            }

            // Extract unique breach sources
            const breachServices = [...new Set(credentials.map(c => c.breach_name || c.source).filter(Boolean))];

            if (breachServices.length > 0) {
                html += `
                    <div class="fade-in" style="margin-bottom: 32px;">
                        <h3 style="color: #ffd700; margin-bottom: 16px;">
                            üè¢ Services Where Credentials Were Breached (${breachServices.length})
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                `;

                breachServices.slice(0, 12).forEach(service => {
                    html += `
                        <div style="
                            background: rgba(0,0,0,0.3);
                            border: 1px solid rgba(255,215,0,0.2);
                            padding: 12px;
                            border-radius: 8px;
                            text-align: center;
                        ">
                            <div style="color: #ffd700; font-weight: 600;">${service}</div>
                        </div>
                    `;
                });

                html += '</div>';

                if (breachServices.length > 12) {
                    html += `
                        <div style="text-align: center; margin-top: 16px;">
                            <span style="color: #888; font-size: 13px;">+${breachServices.length - 12} more services</span>
                        </div>
                    `;
                }

                html += '</div>';
            }

            resultsDiv.innerHTML = html;

            // Debug visibility and positioning
            console.log('[DISPLAY] HTML set, length:', html.length);
            console.log('[DISPLAY] resultsDiv after update:', resultsDiv);
            console.log('[DISPLAY] resultsDiv offsetHeight:', resultsDiv.offsetHeight);
            console.log('[DISPLAY] resultsDiv scrollHeight:', resultsDiv.scrollHeight);
            console.log('[DISPLAY] resultsDiv parent:', resultsDiv.parentElement);
            console.log('[DISPLAY] resultsDiv parent display:', window.getComputedStyle(resultsDiv.parentElement).display);
            console.log('[DISPLAY] First child in results:', resultsDiv.firstElementChild);

            // Force scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showMoreResults(category) {
            if (category === 'stealer_logs') {
                // Show all hidden machines
                const hiddenMachines = document.querySelectorAll('.hidden-machine');
                hiddenMachines.forEach(machine => {
                    machine.style.display = 'block';
                    machine.classList.remove('hidden-machine');
                });

                // Hide the "Show More" button
                const showMoreBtn = document.getElementById('show-more-machines-btn');
                if (showMoreBtn) {
                    showMoreBtn.style.display = 'none';
                }
            } else if (category === 'credentials') {
                alert(`Show more ${category} - functionality coming soon!`);
                // TODO: Implement pagination or expand to show all results
            }
        }

        // NEW FILTER FUNCTIONS
        function applyFilters() {
            const typeFilter = document.getElementById('filterType').value;
            const sourceFilter = document.getElementById('filterSource').value;
            
            const sections = document.querySelectorAll('.data-section');
            
            sections.forEach(section => {
                let showSection = true;
                
                // Type filter
                const sectionType = section.getAttribute('data-section-type');
                if (typeFilter !== 'all' && sectionType !== typeFilter) {
                    showSection = false;
                }
                
                // Source filter
                if (sourceFilter !== 'all') {
                    const sourceTags = section.querySelectorAll('.source-tag');
                    let hasMatchingSource = false;
                    sourceTags.forEach(tag => {
                        if (tag.textContent.toLowerCase().includes(sourceFilter.toLowerCase())) {
                            hasMatchingSource = true;
                        }
                    });
                    if (!hasMatchingSource && sectionType !== 'attack') {
                        showSection = false;
                    }
                }
                
                // Apply filter
                if (showSection) {
                    section.classList.remove('filtered-out');
                } else {
                    section.classList.add('filtered-out');
                }
            });
        }

        function clearFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterSource').value = 'all';
            applyFilters();
        }

        // Map actual API source names to branded display names
        function mapSourceName(source) {
            const sourceMap = {
                'hudson_rock': 'Infostealer Logs',
                'Hudson Rock': 'Infostealer Logs',
                'leakcheck': 'Public Breach Database',
                'LeakCheck': 'Public Breach Database',
                'telegram': 'Dark Web Channels',
                'Telegram': 'Dark Web Channels',
                'leakbase': 'Dark Web Channels',
                'breachdirectory': 'Public Breach Database',
                'BreachDirectory': 'Public Breach Database'
            };
            return sourceMap[source] || source;
        }

        function categorizeData(results) {
            console.log('Results received:', results);
            const categorized = {
                credentials: [],
                machines: [],
                breaches: [],
                companies: []
            };

            for (const [source, data] of Object.entries(results)) {
                console.log('Processing source:', source, 'Data:', data);

                if (!data.found || !data.data) continue;

                const items = Array.isArray(data.data) ? data.data : [data.data];
                console.log('Items to process:', items);

                if (data.type === 'infostealer_logs') {
                    console.log('Processing infostealer logs');
                    items.forEach(item => {
                        console.log('Processing item:', item);
                        // FREE API: Use total_credentials from API (not credentials.length)
                        const totalCreds = item.total_credentials || 0;
                        const sampleCreds = item.credentials || [];
                        const stealerFamily = item.stealer_family || 'Infostealer';

                        // Display format: "364+ credentials" for large counts
                        const credDisplay = totalCreds > 10 ? `${totalCreds}+ credentials` : `${totalCreds} credentials`;

                        categorized.machines.push({
                            source: `${stealerFamily} (${credDisplay})`,
                            stealer: stealerFamily,
                            computer: item.computer_name,
                            os: item.operating_system,
                            ip: item.ip,
                            date: item.date_compromised,
                            cred_count: totalCreds,  // Actual count from API
                            sample_count: sampleCreds.length,  // Sample credentials available
                            credentials: sampleCreds,
                            is_sample: totalCreds > sampleCreds.length  // Mark if we're showing samples
                        });

                        // Add sample credentials to the credentials list
                        if (sampleCreds && sampleCreds.length > 0) {
                            sampleCreds.forEach(cred => {
                                categorized.credentials.push({
                                    source: `${stealerFamily} (Sample)`,
                                    stealer_family: stealerFamily,
                                    url: cred.url,
                                    domain: cred.domain,
                                    username: cred.username,
                                    password: cred.password,
                                    date: item.date_compromised,
                                    is_sample: true,
                                    total_available: totalCreds
                                });
                            });
                        }
                    });
                }

                if (data.type === 'breach_data') {
                    items.forEach(item => {
                        // Check if this is LeakInsight format (has email/password fields)
                        if (item.email || item.password) {
                            // LeakInsight credential format - add to credentials
                            categorized.credentials.push({
                                source: item.source || 'LeakInsight',
                                domain: item.email ? item.email.split('@')[1] : 'Unknown',
                                username: item.username || item.email || 'N/A',
                                password: item.password || '[Hidden]',
                                date: item.breach_date || item.date || 'Unknown'
                            });
                            // Also add to breaches for history
                            if (item.breach_name) {
                                categorized.breaches.push({
                                    source: item.source || 'LeakInsight',
                                    name: item.breach_name,
                                    date: item.breach_date || 'Unknown',
                                    data_types: 'Email, Password'
                                });
                            }
                        } else {
                            // Standard breach format
                            categorized.breaches.push({
                                source: mapSourceName(source),
                                name: item.name,
                                date: item.date,
                                data_types: item.data_types
                            });
                        }
                    });
                }

                if (data.type === 'github_exposure') {
                    items.forEach(item => {
                        categorized.credentials.push({
                            source: 'GitHub Exposure',
                            url: item.url,
                            domain: item.filename || 'GitHub Gist',
                            username: item.credential_type || 'N/A',
                            password: item.credential_value || '[Redacted]',
                            date: item.date
                        });
                    });
                }

                if (data.type === 'paste_exposure') {
                    items.forEach(item => {
                        categorized.credentials.push({
                            source: 'Paste Exposure',
                            url: item.url,
                            domain: item.title || 'PasteBin',
                            username: item.source || 'N/A',
                            password: item.credential_value || '[Redacted]',
                            date: item.date
                        });
                    });
                }
            }

            return categorized;
        }

        function buildCredentialsSection(credentials) {
            const section = document.createElement('div');
            section.className = 'data-section fade-in';
            section.style.marginBottom = '32px';
            
            const showCount = 5;
            const hasMore = credentials.length > showCount;
            
            section.innerHTML = `
                <div class="section-header">
                    <span class="section-title">Compromised Credentials</span>
                    <span class="section-count">${credentials.length} found</span>
                </div>
            `;

            const itemsContainer = document.createElement('div');
            
            credentials.slice(0, showCount).forEach(cred => {
                const item = document.createElement('div');
                item.className = 'data-item';

                const domain = cred.domain || cred.url || 'Unknown';
                const date = cred.date ? new Date(cred.date).toLocaleDateString() : 'Unknown';

                // Check if this is sample data from Hudson Rock free API
                const isSample = cred.is_sample || cred.source?.includes('(Sample)');
                const totalAvailable = cred.total_available || 0;
                const sampleNote = isSample && totalAvailable > 0 ?
                    `<div style="font-size: 0.85em; color: #D4AF37; margin-top: 5px;">Sample from ${totalAvailable}+ total credentials</div>` : '';

                item.innerHTML = `
                    <div class="item-primary">${domain}</div>
                    <div class="item-details">
                        Username: <strong>${cred.username || 'N/A'}</strong><br>
                        Password: <strong class="severity-critical">${cred.password || '[Hidden]'}</strong>
                        ${sampleNote}
                    </div>
                    <div class="item-meta">
                        <span style="
                            background: ${cred.source === 'LeakInsight' ?
                                'linear-gradient(135deg, #ffd700 0%, #ff8c00 100%)' :
                                'rgba(212, 175, 55, 0.15)'};
                            color: ${cred.source === 'LeakInsight' ? '#000' : '#D4AF37'};
                            padding: 4px 12px;
                            border-radius: 6px;
                            font-size: 12px;
                            font-weight: 600;
                            display: inline-block;
                            margin-right: 8px;
                        ">${cred.source}</span>
                        <span>Compromised: ${date}</span>
                    </div>
                `;
                itemsContainer.appendChild(item);
            });

            section.appendChild(itemsContainer);

            if (hasMore) {
                const hiddenContainer = document.createElement('div');
                hiddenContainer.style.display = 'none';
                hiddenContainer.id = 'hidden-creds';
                
                credentials.slice(showCount).forEach(cred => {
                    const item = document.createElement('div');
                    item.className = 'data-item';

                    const domain = cred.domain || cred.url || 'Unknown';
                    const date = cred.date ? new Date(cred.date).toLocaleDateString() : 'Unknown';

                    // Check if this is sample data from Hudson Rock free API
                    const isSample = cred.is_sample || cred.source?.includes('(Sample)');
                    const totalAvailable = cred.total_available || 0;
                    const sampleNote = isSample && totalAvailable > 0 ?
                        `<div style="font-size: 0.85em; color: #D4AF37; margin-top: 5px;">Sample from ${totalAvailable}+ total credentials</div>` : '';

                    item.innerHTML = `
                        <div class="item-primary">${domain}</div>
                        <div class="item-details">
                            Username: <strong>${cred.username || 'N/A'}</strong><br>
                            Password: <strong class="severity-critical">${cred.password || '[Hidden]'}</strong>
                            ${sampleNote}
                        </div>
                        <div class="item-meta">
                            <span style="
                                background: ${cred.source === 'LeakInsight' ?
                                    'linear-gradient(135deg, #ffd700 0%, #ff8c00 100%)' :
                                    'rgba(212, 175, 55, 0.15)'};
                                color: ${cred.source === 'LeakInsight' ? '#000' : '#D4AF37'};
                                padding: 4px 12px;
                                border-radius: 6px;
                                font-size: 12px;
                                font-weight: 600;
                                display: inline-block;
                                margin-right: 8px;
                            ">${cred.source}</span>
                            <span>Compromised: ${date}</span>
                        </div>
                    `;
                    hiddenContainer.appendChild(item);
                });
                
                section.appendChild(hiddenContainer);
                
                const expandBtn = document.createElement('div');
                expandBtn.className = 'expand-button';
                expandBtn.innerHTML = `Show ${credentials.length - showCount} more credentials`;
                expandBtn.onclick = () => {
                    const hidden = document.getElementById('hidden-creds');
                    if (hidden.style.display === 'none') {
                        hidden.style.display = 'block';
                        expandBtn.innerHTML = 'Show less';
                    } else {
                        hidden.style.display = 'none';
                        expandBtn.innerHTML = `Show ${credentials.length - showCount} more credentials`;
                    }
                };
                section.appendChild(expandBtn);
            }

            return section;
        }

        function buildMachinesSection(machines) {
            const section = document.createElement('div');
            section.className = 'data-section fade-in';
            section.style.marginBottom = '32px';
            
            const showCount = 3;
            
            section.innerHTML = `
                <div class="section-header">
                    <span class="section-title">Infected Machines</span>
                    <span class="section-count">${machines.length} found</span>
                </div>
            `;

            machines.slice(0, showCount).forEach(machine => {
                const item = document.createElement('div');
                item.className = 'data-item';

                const date = machine.date ? new Date(machine.date).toLocaleDateString() : 'Unknown';

                // Display credential count properly (from free API total_credentials)
                const credCount = machine.cred_count || 0;
                const sampleCount = machine.sample_count || 0;
                const credDisplay = credCount > 10 ? `${credCount}+ credentials exposed` : `${credCount} credentials exposed`;

                // Add sample note if we have sample data
                const sampleNote = machine.is_sample && sampleCount > 0 ?
                    `<div style="font-size: 0.85em; color: #D4AF37; margin-top: 3px;">(${sampleCount} sample credentials available)</div>` : '';

                item.innerHTML = `
                    <div class="item-primary">${machine.computer || 'Unknown Computer'}</div>
                    <div class="item-details">
                        Stealer: <strong>${machine.stealer || 'Unknown'}</strong><br>
                        OS: ${machine.os || 'Unknown'}<br>
                        IP: ${machine.ip || 'Unknown'}<br>
                        <span class="severity-critical">${credDisplay}</span>
                        ${sampleNote}
                    </div>
                    <div class="item-meta">
                        <span>Compromised: ${date}</span>
                    </div>
                `;
                section.appendChild(item);
            });

            if (machines.length > showCount) {
                const expandBtn = document.createElement('div');
                expandBtn.className = 'expand-button';
                expandBtn.innerHTML = `Show ${machines.length - showCount} more machines`;
                section.appendChild(expandBtn);
            }

            return section;
        }

        function buildBreachesSection(breaches) {
            const section = document.createElement('div');
            section.className = 'data-section fade-in';
            section.style.marginBottom = '32px';
            
            section.innerHTML = `
                <div class="section-header">
                    <span class="section-title">Breach History</span>
                    <span class="section-count">${breaches.length} breaches</span>
                </div>
            `;

            breaches.forEach(breach => {
                const item = document.createElement('div');
                item.className = 'data-item';
                
                const dataTypes = Array.isArray(breach.data_types) ? breach.data_types.join(', ') : breach.data_types;
                
                item.innerHTML = `
                    <div class="item-primary">${breach.name}</div>
                    <div class="item-details">
                        Date: ${breach.date || 'Unknown'}<br>
                        Exposed: ${dataTypes || 'Unknown'}
                    </div>
                    <div class="item-meta">
                        <span style="
                            background: ${breach.source === 'LeakInsight' ?
                                'linear-gradient(135deg, #ffd700 0%, #ff8c00 100%)' :
                                'rgba(212, 175, 55, 0.15)'};
                            color: ${breach.source === 'LeakInsight' ? '#000' : '#D4AF37'};
                            padding: 4px 12px;
                            border-radius: 6px;
                            font-size: 12px;
                            font-weight: 600;
                            display: inline-block;
                        ">${breach.source}</span>
                    </div>
                `;
                section.appendChild(item);
            });

            return section;
        }

        function buildAttackPathSection(data) {
            const section = document.createElement('div');
            section.className = 'data-section attack-path-section fade-in';
            section.style.marginBottom = '32px';
            
            const credCount = data.credentials.length;
            const machineCount = data.machines.length;
            const hasPasswords = data.credentials.some(c => c.password);
            
            let probability = 60;
            if (credCount > 10) probability += 15;
            if (hasPasswords) probability += 20;
            if (machineCount > 1) probability += 10;
            probability = Math.min(probability, 95);
            
            section.innerHTML = `
                <div class="section-header">
                    <span class="section-title">Attack Path Analysis</span>
                    <span class="section-count severity-critical">${probability}% Risk</span>
                </div>
                <div class="attack-phase">
                    <span class="phase-number">1</span>
                    <strong>Initial Access</strong>
                    <span class="probability">${probability}%</span><br>
                    <div style="margin-left: 32px; margin-top: 8px; color: #aaa; font-size: 0.95em;">
                        ${credCount} credentials available for account takeover<br>
                        ${hasPasswords ? 'Plaintext passwords exposed' : 'Hashed passwords only'}<br>
                        Likely works on: Email, Social Media, Corporate Accounts
                    </div>
                </div>
                <div class="attack-phase">
                    <span class="phase-number">2</span>
                    <strong>Lateral Movement</strong>
                    <span class="probability">${Math.max(probability - 20, 40)}%</span><br>
                    <div style="margin-left: 32px; margin-top: 8px; color: #aaa; font-size: 0.95em;">
                        Password reuse across ${Math.min(credCount, 10)} services detected<br>
                        ${machineCount} infected machines provide additional entry points<br>
                        High probability of corporate account access
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 4px; font-size: 0.9em;">
                    <strong>Time to Compromise:</strong> 2-4 hours &nbsp;|&nbsp;
                    <strong>Black Market Value:</strong> $${Math.min(credCount * 15, 2000)}-$${Math.min(credCount * 25, 3500)} &nbsp;|&nbsp;
                    <strong>Recommended Action:</strong> Immediate password reset
                </div>
            `;

            return section;
        }

        // Export to JSON
        function exportToJSON() {
            if (!currentResults) {
                alert('No results to export');
                return;
            }

            const exportData = {
                query: currentResults.query,
                query_type: currentResults.query_type,
                timestamp: new Date().toISOString(),
                total_findings: currentResults.total_findings,
                results: currentResults.results
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ghost-search-${currentResults.query}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Export to PDF
        function exportToPDF() {
            if (!currentResults) {
                alert('No results to export');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yPos = 20;
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;

            // Helper function to check if we need a new page
            function checkPageBreak(additionalHeight = lineHeight) {
                if (yPos + additionalHeight > pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                    return true;
                }
                return false;
            }

            // Title
            doc.setFontSize(20);
            doc.setTextColor(212, 175, 55);
            doc.text('GHOST - Credential Intelligence Report', margin, yPos);
            yPos += 15;

            // Query Info
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Query: ${currentResults.query} (${currentResults.query_type})`, margin, yPos);
            yPos += lineHeight;
            doc.text(`Date: ${new Date().toLocaleString()}`, margin, yPos);
            yPos += lineHeight;
            doc.text(`Total Findings: ${currentResults.total_findings}`, margin, yPos);
            yPos += 15;

            const categorized = categorizeData(currentResults.results);

            // Credentials Section
            if (categorized.credentials.length > 0) {
                checkPageBreak(20);
                doc.setFontSize(14);
                doc.setTextColor(212, 175, 55);
                doc.text(`Compromised Credentials (${categorized.credentials.length})`, margin, yPos);
                yPos += 10;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                categorized.credentials.forEach((cred, index) => {
                    checkPageBreak(30);

                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${cred.domain || cred.url || 'Unknown'}`, margin + 5, yPos);
                    yPos += lineHeight;

                    doc.setFont(undefined, 'normal');
                    doc.text(`   Username: ${cred.username || 'N/A'}`, margin + 5, yPos);
                    yPos += lineHeight;
                    doc.text(`   Password: ${cred.password || '[Hidden]'}`, margin + 5, yPos);
                    yPos += lineHeight;
                    doc.text(`   Source: ${cred.source}`, margin + 5, yPos);
                    yPos += lineHeight;
                    doc.text(`   Date: ${cred.date ? new Date(cred.date).toLocaleDateString() : 'Unknown'}`, margin + 5, yPos);
                    yPos += lineHeight + 2;
                });
                yPos += 5;
            }

            // Machines Section
            if (categorized.machines.length > 0) {
                checkPageBreak(20);
                doc.setFontSize(14);
                doc.setTextColor(212, 175, 55);
                doc.text(`Infected Machines (${categorized.machines.length})`, margin, yPos);
                yPos += 10;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                categorized.machines.forEach((machine, index) => {
                    checkPageBreak(35);

                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${machine.computer || 'Unknown Computer'}`, margin + 5, yPos);
                    yPos += lineHeight;

                    doc.setFont(undefined, 'normal');
                    doc.text(`   Stealer: ${machine.stealer || 'Unknown'}`, margin + 5, yPos);
                    yPos += lineHeight;
                    doc.text(`   OS: ${machine.os || 'Unknown'}`, margin + 5, yPos);
                    yPos += lineHeight;
                    doc.text(`   IP: ${machine.ip || 'Unknown'}`, margin + 5, yPos);
                    yPos += lineHeight;
                    doc.text(`   Credentials Exposed: ${machine.cred_count}`, margin + 5, yPos);
                    yPos += lineHeight;
                    doc.text(`   Source: ${machine.source}`, margin + 5, yPos);
                    yPos += lineHeight;
                    doc.text(`   Date: ${machine.date ? new Date(machine.date).toLocaleDateString() : 'Unknown'}`, margin + 5, yPos);
                    yPos += lineHeight + 2;
                });
                yPos += 5;
            }

            // Breaches Section
            if (categorized.breaches.length > 0) {
                checkPageBreak(20);
                doc.setFontSize(14);
                doc.setTextColor(212, 175, 55);
                doc.text(`Breach History (${categorized.breaches.length})`, margin, yPos);
                yPos += 10;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                categorized.breaches.forEach((breach, index) => {
                    checkPageBreak(25);

                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${breach.name}`, margin + 5, yPos);
                    yPos += lineHeight;

                    doc.setFont(undefined, 'normal');
                    doc.text(`   Date: ${breach.date || 'Unknown'}`, margin + 5, yPos);
                    yPos += lineHeight;
                    const dataTypes = Array.isArray(breach.data_types) ? breach.data_types.join(', ') : breach.data_types;
                    doc.text(`   Exposed: ${dataTypes || 'Unknown'}`, margin + 5, yPos);
                    yPos += lineHeight;
                    doc.text(`   Source: ${breach.source}`, margin + 5, yPos);
                    yPos += lineHeight + 2;
                });
            }

            // Footer
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i} of ${totalPages}`, doc.internal.pageSize.width / 2, pageHeight - 10, { align: 'center' });
                doc.text('Generated by NERVE GHOST System', doc.internal.pageSize.width / 2, pageHeight - 5, { align: 'center' });
            }

            doc.save(`ghost-search-${currentResults.query}-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // ==================== EMAIL MONITORING FUNCTIONS ====================

        // Load monitored emails from localStorage
        let monitoredEmails = JSON.parse(localStorage.getItem('monitored_emails') || '[]');
        const MAX_MONITORED_EMAILS = 15;

        function addMonitoredEmail() {
            const input = document.getElementById('monitor-email-input');
            const email = input.value.trim().toLowerCase();

            if (!email) {
                alert('Please enter an email address');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            if (monitoredEmails.length >= MAX_MONITORED_EMAILS) {
                alert(`Maximum ${MAX_MONITORED_EMAILS} emails allowed`);
                return;
            }

            if (monitoredEmails.includes(email)) {
                alert('This email is already being monitored');
                return;
            }

            monitoredEmails.push(email);
            localStorage.setItem('monitored_emails', JSON.stringify(monitoredEmails));

            input.value = '';
            displayMonitoredEmails();
            updateTimeline();

            console.log('[MONITORING] Added email:', email);
        }

        function removeMonitoredEmail(email) {
            if (confirm(`Stop monitoring ${email}?`)) {
                monitoredEmails = monitoredEmails.filter(e => e !== email);
                localStorage.setItem('monitored_emails', JSON.stringify(monitoredEmails));
                displayMonitoredEmails();
                updateTimeline();

                console.log('[MONITORING] Removed email:', email);
            }
        }

        function displayMonitoredEmails() {
            const container = document.getElementById('monitored-emails-list');

            if (monitoredEmails.length === 0) {
                container.innerHTML = `
                    <p style="color: #888; font-style: italic; font-size: 13px; text-align: center; padding: 20px;">
                        No emails monitored yet. Add up to 15 emails above.
                    </p>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <span style="color: #aaa; font-size: 12px;">Monitored Emails (${monitoredEmails.length}/${MAX_MONITORED_EMAILS}):</span>
                </div>
                ${monitoredEmails.map(email => `
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 12px;
                        background: rgba(255,255,255,0.05);
                        border-radius: 6px;
                        margin-bottom: 6px;
                    ">
                        <span style="color: #ffd700; font-size: 13px;">${email}</span>
                        <button onclick="removeMonitoredEmail('${email}')" style="
                            background: rgba(220,53,69,0.2);
                            border: 1px solid #dc3545;
                            color: #dc3545;
                            padding: 4px 10px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 11px;
                        ">Remove</button>
                    </div>
                `).join('')}
            `;
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');

                let addedCount = 0;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                for (const line of lines) {
                    const email = line.trim().toLowerCase();

                    if (emailRegex.test(email) &&
                        !monitoredEmails.includes(email) &&
                        monitoredEmails.length < MAX_MONITORED_EMAILS) {
                        monitoredEmails.push(email);
                        addedCount++;
                    }
                }

                if (addedCount > 0) {
                    localStorage.setItem('monitored_emails', JSON.stringify(monitoredEmails));
                    displayMonitoredEmails();
                    updateTimeline();
                    alert(`Added ${addedCount} email(s) to monitoring`);
                } else {
                    alert('No valid emails found in CSV or limit reached');
                }
            };

            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        function updateAlertFrequency() {
            const frequency = document.getElementById('alert-frequency').value;
            localStorage.setItem('alert_frequency', frequency);
            updateNextCheckDate();
            console.log('[MONITORING] Alert frequency updated to:', frequency);
        }

        function updateNextCheckDate() {
            const frequency = localStorage.getItem('alert_frequency') || 'weekly';
            const lastCheck = localStorage.getItem('last_check_date');

            if (!lastCheck) {
                document.getElementById('next-check-date').textContent = 'After first check';
                return;
            }

            const lastCheckDate = new Date(lastCheck);
            let nextCheck = new Date(lastCheckDate);

            switch(frequency) {
                case 'weekly':
                    nextCheck.setDate(nextCheck.getDate() + 7);
                    break;
                case 'biweekly':
                    nextCheck.setDate(nextCheck.getDate() + 14);
                    break;
                case 'monthly':
                    nextCheck.setMonth(nextCheck.getMonth() + 1);
                    break;
            }

            document.getElementById('next-check-date').textContent = nextCheck.toLocaleDateString();
        }

        function loadMonitoringStatus() {
            const lastCheck = localStorage.getItem('last_check_date');
            if (lastCheck) {
                const date = new Date(lastCheck);
                document.getElementById('last-check-date').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                updateNextCheckDate();
            }

            const frequency = localStorage.getItem('alert_frequency') || 'weekly';
            document.getElementById('alert-frequency').value = frequency;
        }

        async function updateTimeline() {
            const container = document.getElementById('breach-timeline-container');

            if (monitoredEmails.length === 0) {
                container.innerHTML = `
                    <p style="color: #888; font-style: italic; font-size: 13px; text-align: center; padding: 80px 20px;">
                        Add monitored emails to see breach timeline
                    </p>
                `;
                return;
            }

            // Fetch breach history for monitored emails
            container.innerHTML = `
                <p style="color: #888; font-size: 13px; text-align: center; padding: 80px 20px;">
                    Loading breach timeline...
                </p>
            `;

            try {
                // Get breach history from backend
                const response = await fetch(`${API_URL}/api/ghost/monitoring/timeline`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({emails: monitoredEmails})
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch timeline');
                }

                const data = await response.json();

                if (!data.breaches || data.breaches.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                            <h4 style="color: #22c55e; margin: 0 0 8px 0;">No Breaches Found</h4>
                            <p style="color: #888; font-size: 13px; margin: 0;">
                                Monitored emails are not in any known breaches
                            </p>
                        </div>
                    `;
                    return;
                }

                // Render timeline
                renderTimeline(data.breaches);

            } catch (error) {
                console.error('[TIMELINE] Error:', error);
                container.innerHTML = `
                    <p style="color: #dc3545; font-size: 13px; text-align: center; padding: 80px 20px;">
                        Error loading timeline. Please try again.
                    </p>
                `;
            }
        }

        function renderTimeline(breaches) {
            const container = document.getElementById('breach-timeline-container');

            // Group breaches by year
            const byYear = {};
            breaches.forEach(breach => {
                const year = breach.date ? breach.date.substring(0, 4) : 'Unknown';
                if (!byYear[year]) byYear[year] = [];
                byYear[year].push(breach);
            });

            const years = Object.keys(byYear).sort();
            const totalCredentials = breaches.reduce((sum, b) => sum + (b.count || 1), 0);

            // Create timeline visualization
            let html = `
                <div style="margin-bottom: 24px; text-align: center;">
                    <div style="font-size: 32px; font-weight: 700; color: #dc3545;">${totalCredentials}</div>
                    <div style="color: #aaa; font-size: 13px;">Total Credentials Exposed</div>
                </div>

                <div style="position: relative; height: 150px; margin: 0 20px;">
                    <!-- Timeline Line -->
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 0;
                        right: 0;
                        height: 2px;
                        background: rgba(255,215,0,0.3);
                    "></div>

                    <!-- Year Markers -->
                    ${years.map((year, index) => {
                        const position = (index / (years.length - 1)) * 100;
                        const breachCount = byYear[year].length;

                        return `
                            <div style="
                                position: absolute;
                                left: ${position}%;
                                top: 50%;
                                transform: translate(-50%, -50%);
                            ">
                                <div onclick="showBreachDetails('${year}')" style="
                                    width: ${Math.min(40 + breachCount * 5, 60)}px;
                                    height: ${Math.min(40 + breachCount * 5, 60)}px;
                                    background: ${breachCount > 5 ? '#dc3545' : breachCount > 2 ? '#ff8c00' : '#ffd700'};
                                    border: 3px solid #000;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: 700;
                                    color: #000;
                                    font-size: 14px;
                                ">${breachCount}</div>
                                <div style="
                                    position: absolute;
                                    top: -30px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    color: #ffd700;
                                    font-size: 12px;
                                    font-weight: 600;
                                    white-space: nowrap;
                                ">${year}</div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div style="margin-top: 40px;">
                    <div style="color: #aaa; font-size: 12px; margin-bottom: 8px;">Recent Breaches:</div>
                    ${breaches.slice(0, 3).map(breach => `
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            padding: 6px 12px;
                            background: rgba(255,255,255,0.05);
                            border-radius: 4px;
                            margin-bottom: 4px;
                            font-size: 12px;
                        ">
                            <span style="color: #ffd700;">${breach.name}</span>
                            <span style="color: #888;">${breach.date || 'Unknown'}</span>
                        </div>
                    `).join('')}
                    ${breaches.length > 3 ? `
                        <div style="text-align: center; margin-top: 8px;">
                            <span style="color: #888; font-size: 11px;">+${breaches.length - 3} more breaches</span>
                        </div>
                    ` : ''}
                </div>
            `;

            container.innerHTML = html;

            // Store breach data for detail view
            window.breachTimelineData = byYear;
        }

        function showBreachDetails(year) {
            const breaches = window.breachTimelineData[year];
            if (!breaches) return;

            alert(`Breaches in ${year}:\n\n${breaches.map(b => `‚Ä¢ ${b.name} (${b.count || 1} credentials)`).join('\n')}`);
        }

        function runManualCheck() {
            alert('Manual breach check functionality will be implemented in the backend. This will query all monitored emails and update the timeline.');
            // TODO: Implement backend API call to check all monitored emails
            // Update last_check_date after successful check
            localStorage.setItem('last_check_date', new Date().toISOString());
            loadMonitoringStatus();
        }

        // Initialize monitoring UI on page load
        document.addEventListener('DOMContentLoaded', function() {
            displayMonitoredEmails();
            loadMonitoringStatus();
            updateTimeline();
        });

        // Also run initialization if DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // DOMContentLoaded has not fired yet
        } else {
            // DOMContentLoaded has already fired
            displayMonitoredEmails();
            loadMonitoringStatus();
            updateTimeline();
        }
    </script>
</body>
</html>