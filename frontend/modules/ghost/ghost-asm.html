<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST - Attack Surface Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Global link styling */
        a {
            color: #ffd700;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        a:hover {
            color: #ff8c00;
            text-decoration: underline;
        }

        a:visited {
            color: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            margin-bottom: 30px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-left img {
            height: 70px;
        }

        .header-title h1 {
            font-size: 2.5em;
            color: #D4AF37;
            font-weight: 700;
            letter-spacing: 3px;
            margin: 0;
        }

        .header-title p {
            color: #D4AF37;
            font-size: 1em;
            margin-top: 5px;
        }

        .back-button {
            padding: 10px 20px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            color: #D4AF37;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .back-button:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
        }

        /* Search Section */
        .search-section {
            max-width: 800px;
            margin: 0 auto 40px;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 18px 150px 18px 20px;
            background: #000000;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
        }

        .search-input:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }

        .scan-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            padding: 12px 30px;
            background: #D4AF37;
            border: none;
            border-radius: 6px;
            color: #000;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scan-button:hover {
            background: #C4A037;
        }

        .scan-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-examples {
            text-align: center;
            margin-top: 12px;
            font-size: 0.85em;
            color: #666;
        }

        .search-examples span {
            margin: 0 8px;
            padding: 4px 10px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-examples span:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #D4AF37;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            display: none;
        }

        .spinner {
            border: 3px solid rgba(212, 175, 55, 0.1);
            border-radius: 50%;
            border-top: 3px solid #D4AF37;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Results Container */
        .results-container {
            display: none;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 12px 24px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-simulate {
            background: linear-gradient(135deg, #D4AF37, #C4A037);
            color: #000;
            border: none;
        }

        .btn-simulate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .btn-export {
            background: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
        }

        .btn-export:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
        }

        /* Risk Score Banner */
        .risk-banner {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(0, 0, 0, 0.5) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
        }

        .risk-score {
            font-size: 3em;
            font-weight: bold;
            color: #D4AF37;
            margin-bottom: 10px;
        }

        .risk-label {
            font-size: 1.1em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .risk-level-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 10px;
            text-transform: uppercase;
        }

        .risk-critical {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .risk-high {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .risk-medium {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
            border: 1px solid rgba(234, 179, 8, 0.4);
        }

        .risk-low {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .risk-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
        }

        .risk-stat {
            text-align: center;
        }

        .risk-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #D4AF37;
        }

        .risk-stat-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        /* Section */
        .results-section {
            background: #000000;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: rgba(212, 175, 55, 0.05);
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .section-header:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .section-title {
            font-size: 1.3em;
            color: #D4AF37;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-count {
            padding: 4px 12px;
            background: rgba(212, 175, 55, 0.2);
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            color: #D4AF37;
        }

        .section-content {
            padding: 20px 25px;
            max-height: 600px;
            overflow-y: auto;
        }

        .section-content.collapsed {
            display: none;
        }

        .expand-icon {
            transition: transform 0.3s;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        /* Asset Item */
        .asset-item {
            padding: 15px;
            background: rgba(212, 175, 55, 0.05);
            border-left: 3px solid #D4AF37;
            border-radius: 4px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .asset-item:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateX(5px);
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .asset-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #fff;
        }

        .asset-name a {
            color: #D4AF37;
            text-decoration: none;
            transition: all 0.2s;
        }

        .asset-name a:hover {
            color: #fff;
            text-decoration: underline;
        }

        .asset-details {
            font-size: 0.9em;
            color: #aaa;
            line-height: 1.6;
        }

        .asset-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 5px;
        }

        .badge-critical {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-high {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-medium {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
            border: 1px solid rgba(234, 179, 8, 0.4);
        }

        .badge-low {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            max-width: 1000px;
            margin: 50px auto;
            background: #000;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 40px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .modal-title {
            font-size: 2em;
            color: #D4AF37;
            font-weight: 600;
        }

        .modal-close {
            font-size: 2em;
            color: #666;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0 10px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: #D4AF37;
        }

        .modal-body {
            color: #e0e0e0;
            line-height: 1.8;
            font-size: 0.95em;
        }

        .modal-body h1, .modal-body h2, .modal-body h3 {
            color: #D4AF37;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .modal-body ul, .modal-body ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }

        .modal-body code {
            background: rgba(212, 175, 55, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            color: #D4AF37;
        }

        .modal-body pre {
            background: rgba(212, 175, 55, 0.05);
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 15px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Error Message */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            padding: 20px;
            color: #f87171;
            margin: 20px 0;
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            padding-bottom: 0;
        }

        .tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #D4AF37;
            background: rgba(212, 175, 55, 0.05);
        }

        .tab.active {
            color: #D4AF37;
            border-bottom-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ============================================
           COMPLIANCE TAB STYLES
           ============================================ */

        /* Typography imports */
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500;600&display=swap');

        /* CSS Variables for Compliance Tab */
        .compliance-container {
            --gold: #D4AF37;
            --gold-light: #E5C76B;
            --gold-dark: #B8942E;
            --gold-glow: rgba(212, 175, 55, 0.15);
            --gold-border: rgba(212, 175, 55, 0.3);

            --status-compliant: #10B981;
            --status-compliant-bg: rgba(16, 185, 129, 0.12);
            --status-non-compliant: #EF4444;
            --status-non-compliant-bg: rgba(239, 68, 68, 0.12);
            --status-partial: #F59E0B;
            --status-partial-bg: rgba(245, 158, 11, 0.12);
            --status-not-tested: #6B7280;
            --status-not-tested-bg: rgba(107, 114, 128, 0.12);

            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-elevated: #1a1a1a;
            --bg-card: linear-gradient(145deg, #141414 0%, #0d0d0d 100%);

            --text-primary: #F5F5F5;
            --text-secondary: #A0A0A0;
            --text-muted: #666666;

            --font-display: 'JetBrains Mono', monospace;
            --font-body: 'DM Sans', sans-serif;

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;

            --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.03);
            --shadow-glow: 0 0 40px rgba(212, 175, 55, 0.08);
        }

        .compliance-container {
            font-family: var(--font-body);
            color: var(--text-primary);
            padding: 32px;
            min-height: 80vh;
        }

        .compliance-container * {
            box-sizing: border-box;
        }

        /* Compliance Header */
        .compliance-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .compliance-header h2 {
            font-family: var(--font-display);
            font-size: 28px;
            font-weight: 600;
            color: var(--gold);
            letter-spacing: -0.5px;
            margin: 0 0 12px 0;
        }

        .compliance-header p {
            font-size: 15px;
            color: var(--text-secondary);
            margin: 0;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Framework Grid */
        .frameworks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .framework-card {
            background: var(--bg-card);
            border: 1px solid var(--gold-border);
            border-radius: var(--radius-lg);
            padding: 28px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: pointer;
        }

        .framework-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .framework-card:hover {
            transform: translateY(-4px);
            border-color: var(--gold);
            box-shadow: var(--shadow-card), var(--shadow-glow);
        }

        .framework-card:hover::before {
            opacity: 1;
        }

        .framework-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .framework-icon {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: var(--gold-glow);
            border: 1px solid var(--gold-border);
            border-radius: var(--radius-md);
        }

        .framework-badge {
            font-family: var(--font-display);
            font-size: 11px;
            font-weight: 500;
            padding: 6px 12px;
            background: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
        }

        .framework-card-body {
            position: relative;
            z-index: 1;
        }

        .framework-name {
            font-family: var(--font-display);
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 4px 0;
            letter-spacing: -0.3px;
        }

        .framework-version {
            font-size: 13px;
            color: var(--gold);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .framework-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .framework-stats {
            display: flex;
            gap: 24px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            margin-bottom: 20px;
        }

        .framework-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .framework-stat-value {
            font-family: var(--font-display);
            font-size: 20px;
            font-weight: 600;
            color: var(--gold);
        }

        .framework-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .framework-card-footer {
            position: relative;
            z-index: 1;
        }

        .framework-progress {
            margin-bottom: 16px;
        }

        .framework-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .framework-progress-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .framework-progress-value {
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 600;
            color: var(--gold);
        }

        .framework-progress-bar {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
        }

        .framework-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-dark), var(--gold-light));
            border-radius: 3px;
            transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .btn-framework {
            width: 100%;
            padding: 14px 24px;
            font-family: var(--font-body);
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-framework-primary {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: #000;
        }

        .btn-framework-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
        }

        .btn-framework-secondary {
            background: var(--gold-glow);
            color: var(--gold);
            border: 1px solid var(--gold-border);
        }

        .btn-framework-secondary:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--gold);
        }

        /* Assessment Dashboard */
        .assessment-view {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }

        .assessment-view.active {
            display: block;
            animation: complianceFadeIn 0.4s ease;
        }

        @keyframes complianceFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .assessment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .assessment-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .btn-back {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-back:hover {
            background: var(--gold-glow);
            border-color: var(--gold-border);
            color: var(--gold);
        }

        .assessment-title-group h3 {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }

        .assessment-title-group p {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0;
        }

        .assessment-header-right {
            display: flex;
            gap: 12px;
        }

        .btn-export {
            padding: 12px 24px;
            font-family: var(--font-body);
            font-size: 13px;
            font-weight: 600;
            background: var(--bg-elevated);
            border: 1px solid var(--gold-border);
            border-radius: var(--radius-md);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export:hover {
            background: var(--gold-glow);
            transform: translateY(-1px);
        }

        /* Progress Overview */
        .assessment-overview {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .progress-circle-card {
            background: var(--bg-card);
            border: 1px solid var(--gold-border);
            border-radius: var(--radius-lg);
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .progress-circle {
            position: relative;
            width: 180px;
            height: 180px;
            margin-bottom: 20px;
        }

        .progress-circle svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-circle-bg {
            fill: none;
            stroke: var(--bg-elevated);
            stroke-width: 12;
        }

        .progress-circle-fill {
            fill: none;
            stroke: url(#goldGradient);
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 502;
            stroke-dashoffset: 502;
            transition: stroke-dashoffset 1s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .progress-circle-text {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .progress-circle-value {
            font-family: var(--font-display);
            font-size: 42px;
            font-weight: 600;
            color: var(--gold);
            line-height: 1;
        }

        .progress-circle-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .progress-circle-card h4 {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin: 0;
            text-align: center;
        }

        /* Status Cards */
        .status-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .status-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-md);
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .status-card.compliant::before { background: var(--status-compliant); }
        .status-card.non-compliant::before { background: var(--status-non-compliant); }
        .status-card.partial::before { background: var(--status-partial); }
        .status-card.not-tested::before { background: var(--status-not-tested); }

        .status-card-value {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .status-card.compliant .status-card-value { color: var(--status-compliant); }
        .status-card.non-compliant .status-card-value { color: var(--status-non-compliant); }
        .status-card.partial .status-card-value { color: var(--status-partial); }
        .status-card.not-tested .status-card-value { color: var(--status-not-tested); }

        .status-card-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Controls List */
        .controls-section {
            margin-top: 32px;
        }

        .controls-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .controls-header h4 {
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .controls-search {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-md);
            width: 280px;
        }

        .controls-search input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 13px;
            outline: none;
        }

        .controls-search input::placeholder {
            color: var(--text-muted);
        }

        .controls-search svg {
            color: var(--text-muted);
            width: 16px;
            height: 16px;
        }

        /* Category Accordion */
        .category-accordion {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .category-group {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .category-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .category-header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .category-chevron {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            transition: transform 0.3s ease;
        }

        .category-group.expanded .category-chevron {
            transform: rotate(180deg);
        }

        .category-name {
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .category-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-progress-bar {
            width: 120px;
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            overflow: hidden;
        }

        .category-progress-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .category-progress-text {
            font-family: var(--font-display);
            font-size: 12px;
            color: var(--text-secondary);
            min-width: 36px;
        }

        .category-count {
            font-size: 12px;
            color: var(--text-muted);
            padding: 4px 10px;
            background: var(--bg-elevated);
            border-radius: 12px;
        }

        .category-content {
            display: none;
            padding: 0 24px 20px;
        }

        .category-group.expanded .category-content {
            display: block;
        }

        /* Control Row */
        .control-row {
            display: grid;
            grid-template-columns: 100px 1fr 140px 140px 100px;
            gap: 16px;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .control-row:last-child {
            border-bottom: none;
        }

        .control-id {
            font-family: var(--font-display);
            font-size: 12px;
            font-weight: 600;
            color: var(--gold);
            background: var(--gold-glow);
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .control-info h5 {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0 0 4px 0;
            line-height: 1.4;
        }

        .control-info p {
            font-size: 12px;
            color: var(--text-muted);
            margin: 0;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .control-status-select {
            position: relative;
        }

        .control-status-select select {
            width: 100%;
            padding: 10px 32px 10px 12px;
            font-family: var(--font-body);
            font-size: 12px;
            font-weight: 500;
            background: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
            outline: none;
            transition: all 0.2s ease;
        }

        .control-status-select select:hover {
            border-color: var(--gold-border);
        }

        .control-status-select select:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px var(--gold-glow);
        }

        .control-status-select::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--text-muted);
            pointer-events: none;
        }

        select.status-compliant { color: var(--status-compliant); }
        select.status-non-compliant { color: var(--status-non-compliant); }
        select.status-partial { color: var(--status-partial); }
        select.status-not-tested { color: var(--status-not-tested); }

        .control-notes {
            position: relative;
        }

        .control-notes input {
            width: 100%;
            padding: 10px 12px;
            font-family: var(--font-body);
            font-size: 12px;
            background: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            outline: none;
            transition: all 0.2s ease;
        }

        .control-notes input::placeholder {
            color: var(--text-muted);
        }

        .control-notes input:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px var(--gold-glow);
        }

        .btn-evidence {
            padding: 10px 14px;
            font-family: var(--font-body);
            font-size: 11px;
            font-weight: 600;
            background: transparent;
            border: 1px solid var(--gold-border);
            border-radius: var(--radius-sm);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-evidence:hover {
            background: var(--gold-glow);
            border-color: var(--gold);
        }

        .btn-evidence .evidence-count {
            background: var(--gold);
            color: #000;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
        }

        /* Scan Integration Badges */
        .scan-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .scan-badge-finding {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .scan-badge-manual {
            background: rgba(234, 179, 8, 0.15);
            color: #eab308;
            border: 1px solid rgba(234, 179, 8, 0.4);
        }

        .scan-badge-verified {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .scan-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-left: 8px;
        }

        .scan-info-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scan-domain {
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Import from Scans Button */
        .btn-import-scans {
            padding: 10px 18px;
            font-family: var(--font-body);
            font-size: 12px;
            font-weight: 600;
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: var(--radius-md);
            color: #3b82f6;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-import-scans:hover {
            background: rgba(59, 130, 246, 0.25);
            border-color: #3b82f6;
        }

        .btn-import-scans:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Re-scan to Verify Button */
        .btn-rescan {
            padding: 6px 12px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.4);
            border-radius: var(--radius-sm);
            color: #22c55e;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .btn-rescan:hover {
            background: rgba(34, 197, 94, 0.25);
            border-color: #22c55e;
        }

        .btn-rescan:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Scan Summary Card */
        .scan-summary-card {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-lg);
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .scan-summary-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .scan-summary-icon {
            font-size: 24px;
        }

        .scan-summary-text h5 {
            font-size: 13px;
            font-weight: 600;
            color: #3b82f6;
            margin: 0 0 4px 0;
        }

        .scan-summary-text p {
            font-size: 12px;
            color: var(--text-muted);
            margin: 0;
        }

        .scan-summary-stats {
            display: flex;
            gap: 20px;
        }

        .scan-stat {
            text-align: center;
        }

        .scan-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #ef4444;
        }

        .scan-stat-value.verified {
            color: #22c55e;
        }

        .scan-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Control row with scan info */
        .control-row.scan-flagged {
            border-left: 3px solid #ef4444;
            padding-left: 17px;
        }

        .control-row.scan-verified {
            border-left: 3px solid #22c55e;
            padding-left: 17px;
        }

        /* Evidence Modal */
        .evidence-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .evidence-modal-overlay.active {
            display: flex;
            animation: complianceFadeIn 0.3s ease;
        }

        .evidence-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--gold-border);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 640px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: complianceSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes complianceSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .evidence-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 28px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .evidence-modal-header h3 {
            font-family: var(--font-display);
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .btn-modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-modal-close:hover {
            background: var(--status-non-compliant-bg);
            border-color: var(--status-non-compliant);
            color: var(--status-non-compliant);
        }

        .evidence-modal-body {
            padding: 28px;
            overflow-y: auto;
            flex: 1;
        }

        .evidence-control-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            margin-bottom: 24px;
        }

        .evidence-control-id {
            font-family: var(--font-display);
            font-size: 12px;
            font-weight: 600;
            color: var(--gold);
            background: var(--gold-glow);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
        }

        .evidence-control-name {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .evidence-form-group {
            margin-bottom: 20px;
        }

        .evidence-form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .evidence-form-group input,
        .evidence-form-group textarea,
        .evidence-form-group select {
            width: 100%;
            padding: 14px 16px;
            font-family: var(--font-body);
            font-size: 14px;
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            outline: none;
            transition: all 0.2s ease;
        }

        .evidence-form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .evidence-form-group input:focus,
        .evidence-form-group textarea:focus,
        .evidence-form-group select:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px var(--gold-glow);
        }

        .file-upload-area {
            border: 2px dashed var(--gold-border);
            border-radius: var(--radius-md);
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-primary);
        }

        .file-upload-area:hover {
            border-color: var(--gold);
            background: var(--gold-glow);
        }

        .file-upload-icon {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .file-upload-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .file-upload-hint {
            font-size: 12px;
            color: var(--text-muted);
        }

        .evidence-list {
            margin-top: 24px;
        }

        .evidence-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .evidence-list-header h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
        }

        .evidence-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .evidence-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .evidence-item-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gold-glow);
            border-radius: var(--radius-sm);
            font-size: 16px;
        }

        .evidence-item-info h5 {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0 0 2px 0;
        }

        .evidence-item-info p {
            font-size: 11px;
            color: var(--text-muted);
            margin: 0;
        }

        .btn-evidence-delete {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-evidence-delete:hover {
            background: var(--status-non-compliant-bg);
            border-color: var(--status-non-compliant);
            color: var(--status-non-compliant);
        }

        .evidence-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .btn-modal-cancel {
            padding: 12px 24px;
            font-family: var(--font-body);
            font-size: 13px;
            font-weight: 600;
            background: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-modal-cancel:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .btn-modal-save {
            padding: 12px 24px;
            font-family: var(--font-body);
            font-size: 13px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            border: none;
            border-radius: var(--radius-md);
            color: #000;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-modal-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(212, 175, 55, 0.3);
        }

        /* Loading State */
        .compliance-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 40px;
            grid-column: 1 / -1;
        }

        .compliance-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--bg-elevated);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: complianceSpin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes complianceSpin {
            to { transform: rotate(360deg); }
        }

        .compliance-loading p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .assessment-overview {
                grid-template-columns: 1fr;
            }

            .progress-circle-card {
                flex-direction: row;
                justify-content: flex-start;
                gap: 32px;
            }

            .progress-circle {
                margin-bottom: 0;
            }
        }

        @media (max-width: 900px) {
            .status-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .control-row {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 20px 0;
            }

            .control-id {
                width: fit-content;
            }

            .assessment-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
        }

        @media (max-width: 640px) {
            .compliance-container {
                padding: 20px;
            }

            .frameworks-grid {
                grid-template-columns: 1fr;
            }

            .status-cards {
                grid-template-columns: 1fr;
            }

            .evidence-modal {
                margin: 20px;
                max-height: calc(100vh - 40px);
            }
        }

        /* Risk Score Gauge */
        .risk-gauge-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(0, 0, 0, 0.5) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
        }

        .risk-gauge {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .gauge-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #22c55e 0deg,
                #22c55e 108deg,
                #eab308 108deg,
                #eab308 216deg,
                #ef4444 216deg,
                #ef4444 360deg
            );
            transform: rotate(-90deg);
        }

        .gauge-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            background: #000;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2;
        }

        .gauge-value {
            font-size: 3em;
            font-weight: bold;
            color: #D4AF37;
        }

        .gauge-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .gauge-description {
            text-align: center;
            margin-left: 40px;
        }

        .gauge-description h2 {
            font-size: 1.8em;
            color: #D4AF37;
            margin-bottom: 10px;
        }

        .gauge-description p {
            color: #aaa;
            line-height: 1.6;
        }

        /* Heat Map Table */
        .heat-map-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #000;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        .heat-map-table thead {
            background: rgba(212, 175, 55, 0.1);
        }

        .heat-map-table th {
            padding: 15px;
            text-align: left;
            color: #D4AF37;
            font-weight: 600;
            font-size: 0.95em;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .heat-map-table th:hover {
            background: rgba(212, 175, 55, 0.15);
        }

        .heat-map-table th .sort-icon {
            margin-left: 5px;
            opacity: 0.5;
        }

        .heat-map-table tbody tr {
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .heat-map-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .heat-map-table td {
            padding: 15px;
            color: #e0e0e0;
        }

        .heat-map-table .asset-cell {
            font-weight: 600;
            color: #D4AF37;
        }

        .heat-map-table .severity-cell {
            text-align: center;
        }

        .heat-map-table .vuln-count {
            text-align: center;
            font-weight: 600;
        }

        .heat-map-table .status-cell {
            text-align: center;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-exposed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .status-protected {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .status-monitored {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
            border: 1px solid rgba(234, 179, 8, 0.4);
        }

        /* Severity Category Sections */
        .severity-category {
            background: #000000;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .severity-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .severity-category-header:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .severity-category.critical .severity-category-header {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
        }

        .severity-category.high .severity-category-header {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
        }

        .severity-category.medium .severity-category-header {
            background: rgba(234, 179, 8, 0.1);
            border-left: 4px solid #eab308;
        }

        .severity-category.low .severity-category-header {
            background: rgba(34, 197, 94, 0.1);
            border-left: 4px solid #22c55e;
        }

        .severity-category-title {
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .severity-category.critical .severity-category-title {
            color: #ef4444;
        }

        .severity-category.high .severity-category-title {
            color: #f59e0b;
        }

        .severity-category.medium .severity-category-title {
            color: #eab308;
        }

        .severity-category.low .severity-category-title {
            color: #22c55e;
        }

        .severity-category-content {
            padding: 20px 25px;
            display: none;
        }

        .severity-category-content.expanded {
            display: block;
        }

        /* Dashboard Card Styles */
        .dashboard-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            border-color: rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            background: rgba(255, 215, 0, 0.03);
        }

        .card-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #ffd700;
            letter-spacing: 0.5px;
        }

        .card-header .badge {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .card-content {
            padding: 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .card-content::-webkit-scrollbar {
            width: 6px;
        }

        .card-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .card-content::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.3);
            border-radius: 3px;
        }

        /* Risk Category Styles */
        .risk-category {
            margin-bottom: 12px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .risk-category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background 0.2s;
        }

        .risk-category-header:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .risk-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .risk-label {
            flex: 1;
            font-weight: 600;
            font-size: 14px;
        }

        .risk-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .expand-btn.expanded {
            transform: rotate(180deg);
        }

        .risk-assets-list {
            padding: 12px 16px 12px 40px;
            background: rgba(0, 0, 0, 0.15);
        }

        .risk-asset-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 13px;
            color: #ccc;
        }

        .risk-asset-item:last-child {
            border-bottom: none;
        }

        /* Lightbox Test Category Cards */
        .test-category-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .findings-clickable:hover {
            opacity: 0.8;
        }

        .findings-clickable:hover span:last-child {
            transform: translateX(4px);
            opacity: 1;
        }

        .test-category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ffd700, #ff8c00);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .test-category-card:hover {
            border-color: rgba(255, 215, 0, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .test-category-card:hover::before {
            opacity: 1;
        }

        .test-card-icon {
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .test-card-title {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
            color: #ffd700;
        }

        .test-card-description {
            margin: 0 0 20px 0;
            font-size: 13px;
            color: #888;
            line-height: 1.5;
        }

        .test-card-stats {
            display: flex;
            gap: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 215, 0, 0.1);
        }

        .stat-item {
            flex: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stat-label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            display: block;
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            line-height: 1.2;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,215,0,0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* Lightbox Display Control Classes */
        #lightbox-findings-display {
            display: none; /* Hidden by default */
        }

        #lightbox-findings-display.show {
            display: block !important; /* Force show when needed */
        }

        #lightbox-results-view {
            display: none;
        }

        #lightbox-results-view.active {
            display: block;
        }

        #lightbox-dashboard {
            display: block;
        }

        #lightbox-dashboard.hidden {
            display: none;
        }
        /* XASM Tab Redesign Styles */
        .xasm-empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 80px 40px; text-align: center;
            background: linear-gradient(180deg, rgba(212, 175, 55, 0.03) 0%, transparent 100%);
            border: 2px dashed rgba(212, 175, 55, 0.2); border-radius: 24px; margin: 40px 0;
        }
        .xasm-empty-icon { font-size: 80px; margin-bottom: 24px; animation: xasmFloat 3s ease-in-out infinite; }
        @keyframes xasmFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .xasm-empty-state h2 { font-size: 28px; font-weight: 700; color: #ffd700; margin: 0 0 12px 0; }
        .xasm-empty-state p { font-size: 16px; color: #888; max-width: 500px; margin: 0 0 32px 0; line-height: 1.6; }

        .xasm-scanning-container {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.08) 0%, rgba(0, 0, 0, 0.4) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 20px; padding: 48px; margin: 24px 0;
        }
        .xasm-progress-bar-container { background: rgba(0, 0, 0, 0.4); border-radius: 12px; height: 24px; overflow: hidden; border: 1px solid rgba(212, 175, 55, 0.2); }
        .xasm-progress-bar-fill { height: 100%; background: linear-gradient(90deg, #D4AF37, #ffd700, #D4AF37); background-size: 200% 100%; animation: xasmShimmer 2s linear infinite; border-radius: 12px; transition: width 0.5s ease; }
        @keyframes xasmShimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .xasm-scan-steps { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 24px; }
        .xasm-scan-step { display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        .xasm-scan-step.completed { border-color: rgba(34, 197, 94, 0.3); background: rgba(34, 197, 94, 0.08); }
        .xasm-scan-step.active { border-color: rgba(212, 175, 55, 0.5); background: rgba(212, 175, 55, 0.1); }
        .xasm-step-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .xasm-scan-step.completed .xasm-step-icon { background: #22c55e; color: #fff; }
        .xasm-scan-step.active .xasm-step-icon { background: #ffd700; color: #000; }
        .xasm-scan-step.pending .xasm-step-icon { background: rgba(255, 255, 255, 0.1); color: #666; }
        .xasm-step-text { font-size: 13px; color: #aaa; }
        .xasm-scan-step.completed .xasm-step-text { color: #22c55e; }
        .xasm-scan-step.active .xasm-step-text { color: #ffd700; font-weight: 500; }

        .xasm-executive-summary { background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(212, 175, 55, 0.05) 100%); border: 1px solid rgba(212, 175, 55, 0.25); border-radius: 24px; padding: 40px; margin-bottom: 32px; }
        .xasm-summary-content { display: grid; grid-template-columns: 320px 1fr; gap: 48px; align-items: center; }
        .xasm-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .xasm-stat-card { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 24px; text-align: center; transition: all 0.3s ease; }
        .xasm-stat-card:hover { border-color: rgba(212, 175, 55, 0.3); transform: translateY(-2px); }
        .xasm-stat-value { font-size: 42px; font-weight: 800; line-height: 1; margin-bottom: 8px; }
        .xasm-stat-value.critical { color: #ef4444; }
        .xasm-stat-value.high { color: #f59e0b; }
        .xasm-stat-value.medium { color: #eab308; }
        .xasm-stat-value.low { color: #22c55e; }
        .xasm-stat-value.gold { color: #ffd700; }
        .xasm-stat-label { font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        .xasm-filter-bar { display: flex; justify-content: space-between; align-items: center; gap: 20px; padding: 20px 24px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; margin-bottom: 24px; }
        .xasm-filter-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .xasm-filter-btn { padding: 10px 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #888; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .xasm-filter-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
        .xasm-filter-btn.active { background: rgba(212, 175, 55, 0.2); border-color: rgba(212, 175, 55, 0.5); color: #ffd700; }
        .xasm-search-input { padding: 10px 16px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 13px; width: 220px; }
        .xasm-search-input:focus { outline: none; border-color: rgba(212, 175, 55, 0.5); }

        .xasm-severity-badge { padding: 6px 14px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .xasm-severity-badge.critical { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.4); }
        .xasm-severity-badge.high { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.4); }
        .xasm-severity-badge.medium { background: rgba(234, 179, 8, 0.2); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.4); }
        .xasm-severity-badge.low { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.4); }
        .xasm-severity-badge.info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.4); }

        .xasm-export-panel { display: flex; justify-content: space-between; align-items: center; padding: 20px 28px; background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(0, 0, 0, 0.4) 100%); border: 1px solid rgba(212, 175, 55, 0.25); border-radius: 16px; margin-top: 32px; }
        .xasm-export-buttons { display: flex; gap: 12px; }
        .xasm-export-btn { padding: 12px 24px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; }
        .xasm-export-btn.pdf { background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; }
        .xasm-export-btn.csv { background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.4); color: #22c55e; }
        .xasm-export-btn.json { background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4); color: #3b82f6; }
        .xasm-export-btn:hover { transform: translateY(-2px); }

        .xasm-cache-banner { display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(0, 0, 0, 0.3) 100%); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; margin-bottom: 24px; }

        @media (max-width: 1200px) { .xasm-summary-content { grid-template-columns: 1fr; } .xasm-scan-steps { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .xasm-filter-bar { flex-direction: column; align-items: stretch; } .xasm-export-panel { flex-direction: column; gap: 20px; text-align: center; } .xasm-stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <img src="ghost-logo.png" alt="GHOST">
                <div class="header-title">
                    <h1>GHOST</h1>
                    <p>Attack Surface Management</p>
                </div>
            </div>
            <a href="ghost.html" class="back-button"> Back to Dashboard</a>
        </div>

        <!-- Quick Navigation -->
        <div style="display: flex; gap: 12px; justify-content: center; padding: 16px 30px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(212,175,55,0.15); margin-bottom: 20px;">
            <a href="ghost-search.html" style="padding: 8px 16px; background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 6px; color: #D4AF37; text-decoration: none; font-size: 0.85rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(212,175,55,0.2)'" onmouseout="this.style.background='rgba(212,175,55,0.1)'">Global Search</a>
            <a href="ghost-adversary.html" style="padding: 8px 16px; background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 6px; color: #D4AF37; text-decoration: none; font-size: 0.85rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(212,175,55,0.2)'" onmouseout="this.style.background='rgba(212,175,55,0.1)'">Adversary Matching</a>
            <a href="ghost-roadmap.html" style="padding: 8px 16px; background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05)); border: 1px solid rgba(212,175,55,0.4); border-radius: 6px; color: #ffd700; text-decoration: none; font-size: 0.85rem; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(212,175,55,0.25)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05))'">Security Roadmap</a>
        </div>

        <!-- Search Section with History Icon -->
        <div class="search-section">
            <div style="display: flex; gap: 0; align-items: stretch; margin-bottom: 12px;">
                <!-- History Icon -->
                <button
                    onclick="toggleXASMHistory()"
                    title="View scan history"
                    style="
                        background: rgba(255,215,0,0.2);
                        border: 2px solid rgba(255,215,0,0.5);
                        border-right: none;
                        border-radius: 8px 0 0 8px;
                        padding: 0 16px;
                        cursor: pointer;
                        color: #ffd700;
                        font-size: 20px;
                        transition: background 0.2s;
                    "
                    onmouseover="this.style.background='rgba(255,215,0,0.3)'"
                    onmouseout="this.style.background='rgba(255,215,0,0.2)'"
                >
                    &#128340;
                </button>

                <!-- Search Input -->
                <input
                    type="text"
                    id="domainInput"
                    placeholder="Enter domain to scan (e.g., stripe.com, tesla.com)..."
                    style="
                        flex: 1;
                        padding: 16px 24px;
                        background: rgba(0,0,0,0.4);
                        border: 2px solid rgba(255,215,0,0.5);
                        border-left: none;
                        border-right: none;
                        color: #fff;
                        font-size: 15px;
                        outline: none;
                    "
                    onfocus="this.parentElement.style.boxShadow='0 0 15px rgba(212,175,55,0.2)'"
                    onblur="this.parentElement.style.boxShadow='none'"
                    autofocus
                />

                <!-- Scan Button -->
                <button
                    id="scanButton"
                    style="
                        background: #ffd700;
                        border: 2px solid #ffd700;
                        border-radius: 0 8px 8px 0;
                        padding: 16px 32px;
                        color: #000;
                        font-weight: 700;
                        cursor: pointer;
                        transition: background 0.2s;
                    "
                    onmouseover="this.style.background='#e6c200'"
                    onmouseout="this.style.background='#ffd700'"
                >
                    Scan Surface
                </button>
            </div>

            <!-- History Dropdown (hidden by default) -->
            <div id="xasm-history-dropdown" style="
                display: none;
                background: rgba(0,0,0,0.95);
                border: 2px solid rgba(255,215,0,0.5);
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                max-height: 500px;
                overflow-y: auto;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="color: #ffd700; margin: 0;">Scan History</h3>
                    <button onclick="toggleXASMHistory()" style="
                        background: transparent;
                        border: none;
                        color: #888;
                        cursor: pointer;
                        font-size: 20px;
                    "></button>
                </div>
                <div id="xasm-history-list"></div>
            </div>

            <div class="search-examples">
                <strong>Examples:</strong>
                <span onclick="exampleScan('stripe.com')">stripe.com</span>
                <span onclick="exampleScan('tesla.com')">tesla.com</span>
                <span onclick="exampleScan('github.com')">github.com</span>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <button class="tab active" onclick="switchTab('asm')"> Attack Surface</button>
            <button class="tab" onclick="switchTab('lightbox')"> Lightbox Testing</button>
            <button class="tab" onclick="switchTab('compliance')"> Compliance Mapping</button>
            <button class="tab" id="tab-vulnerability" onclick="switchTab('vulnerability')"> Vulnerability Report</button>
        </div>

        <!-- ASM Tab Content -->
        <div id="asmTab" class="tab-content active">
        <!-- Empty State (shown when no scan has been run) -->
        <div id="xasmEmptyState" class="xasm-empty-state">
            <div class="xasm-empty-icon"></div>
            <h2>Discover Your Attack Surface</h2>
            <p>Run an XASM scan to identify exposed assets, vulnerable services, and potential security risks across your external infrastructure.</p>
            <button onclick="document.getElementById('domainInput').focus()" style="padding: 16px 40px; background: linear-gradient(135deg, #D4AF37 0%, #B8960C 100%); border: none; border-radius: 12px; color: #000; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 24px rgba(212, 175, 55, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(212, 175, 55, 0.3)'">
                Start Your First Scan
            </button>
            <div style="margin-top: 24px; font-size: 14px; color: #666;">
                Try scanning: <span onclick="exampleScan('stripe.com')" style="color: #ffd700; cursor: pointer; font-weight: 600;">stripe.com</span> or <span onclick="exampleScan('github.com')" style="color: #ffd700; cursor: pointer; font-weight: 600;">github.com</span>
            </div>
        </div>

        <!-- Loading Indicator with Enhanced Progress -->
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="xasm-scanning-container">
                <div style="text-align: center; margin-bottom: 40px;">
                    <h2 style="font-size: 24px; color: #ffd700; margin: 0 0 8px 0;">Scanning Attack Surface</h2>
                    <p id="scanningMessage" style="font-size: 16px; color: #888; margin: 0;">Initializing scan...</p>
                </div>

                <div style="max-width: 600px; margin: 0 auto;">
                    <div class="xasm-progress-bar-container">
                        <div id="progressBar" class="xasm-progress-bar-fill" style="width: 0%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                        <p id="progressText" style="font-size: 14px; color: #ffd700; margin: 0;">Starting scan...</p>
                        <span id="progressPercent" style="font-size: 18px; color: #fff; font-weight: 700;">0%</span>
                    </div>

                    <div class="xasm-scan-steps">
                        <div id="step-dns" class="xasm-scan-step pending">
                            <div class="xasm-step-icon"></div>
                            <span class="xasm-step-text">DNS Enumeration</span>
                        </div>
                        <div id="step-certs" class="xasm-scan-step pending">
                            <div class="xasm-step-icon"></div>
                            <span class="xasm-step-text">Certificate Analysis</span>
                        </div>
                        <div id="step-ports" class="xasm-scan-step pending">
                            <div class="xasm-step-icon"></div>
                            <span class="xasm-step-text">Port Scanning</span>
                        </div>
                        <div id="step-cloud" class="xasm-scan-step pending">
                            <div class="xasm-step-icon"></div>
                            <span class="xasm-step-text">Cloud Asset Discovery</span>
                        </div>
                        <div id="step-intel" class="xasm-scan-step pending">
                            <div class="xasm-step-icon"></div>
                            <span class="xasm-step-text">Threat Intelligence</span>
                        </div>
                        <div id="step-risk" class="xasm-scan-step pending">
                            <div class="xasm-step-icon"></div>
                            <span class="xasm-step-text">Risk Assessment</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Container -->
        <div id="errorContainer"></div>

        <!-- Results Container -->
        <div id="resultsContainer" class="results-container">
            <!-- Cache Info Banner -->
            <div id="cacheInfo" class="xasm-cache-banner" style="display: none;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 20px;"></span>
                    <span id="cacheInfoText" style="font-size: 14px; color: #3b82f6;"></span>
                </div>
                <button id="rescanButton" style="padding: 10px 20px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; color: #3b82f6; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(59, 130, 246, 0.3)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.2)'">
                     Re-scan Now
                </button>
            </div>
            <!-- Export Panel -->
            <div class="xasm-export-panel">
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: #fff; margin: 0 0 4px 0;">Export Scan Results</h4>
                    <p style="font-size: 13px; color: #888; margin: 0;">Download your attack surface analysis</p>
                </div>
                <div class="xasm-export-buttons">
                    <button class="xasm-export-btn pdf" onclick="exportAsPDF()">
                         PDF Report
                    </button>
                    <button class="xasm-export-btn csv" onclick="exportAsCSV()">
                         CSV Data
                    </button>
                    <button class="xasm-export-btn json" onclick="exportAsTXT()">
                         TXT Export
                    </button>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="xasm-filter-bar" style="margin-bottom: 24px;">
                <div class="xasm-filter-buttons">
                    <button class="xasm-filter-btn active" onclick="filterFindings('all')" data-filter="all">All Findings</button>
                    <button class="xasm-filter-btn" onclick="filterFindings('critical')" data-filter="critical" style="border-color: rgba(239, 68, 68, 0.3);">Critical</button>
                    <button class="xasm-filter-btn" onclick="filterFindings('high')" data-filter="high" style="border-color: rgba(245, 158, 11, 0.3);">High</button>
                    <button class="xasm-filter-btn" onclick="filterFindings('medium')" data-filter="medium" style="border-color: rgba(234, 179, 8, 0.3);">Medium</button>
                    <button class="xasm-filter-btn" onclick="filterFindings('low')" data-filter="low" style="border-color: rgba(34, 197, 94, 0.3);">Low</button>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="text" class="xasm-search-input" placeholder="Search findings..." oninput="searchFindings(this.value)" style="background-image: url(\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'16\' height=\'16\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23888888\' stroke-width=\'2\'%3E%3Ccircle cx=\'11\' cy=\'11\' r=\'8\'/%3E%3Cpath d=\'m21 21-4.35-4.35\'/%3E%3C/svg%3E\'); background-repeat: no-repeat; background-position: 12px center; padding-left: 40px;">
                    <select onchange="sortFindings(this.value)" style="padding: 10px 36px 10px 16px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer;">
                        <option value="severity">Sort by Severity</option>
                        <option value="category">Sort by Category</option>
                        <option value="name">Sort by Name</option>
                    </select>
                </div>
            </div>

            <!-- Enhanced 3D Risk Score Display -->
            <div style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 40px; border: 1px solid rgba(255,215,0,0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.3); margin-bottom: 25px;">
                <h2 style="text-align: center; margin-bottom: 30px; font-size: 28px; letter-spacing: 1px;">Attack Surface Risk Score</h2>

                <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 30px;">
                    <!-- 3D Risk Score Circle -->
                    <div style="position: relative; width: 280px; height: 280px;">
                        <svg width="280" height="280" style="transform: rotate(-90deg);">
                            <!-- Background circle -->
                            <circle cx="140" cy="140" r="120" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="24"/>

                            <!-- Risk score arc (will be updated dynamically) -->
                            <circle id="risk-score-arc" cx="140" cy="140" r="120" fill="none"
                                    stroke="url(#riskGradient)" stroke-width="24"
                                    stroke-dasharray="754" stroke-dashoffset="754"
                                    stroke-linecap="round"
                                    style="filter: drop-shadow(0 0 12px rgba(255,215,0,0.6)); transition: stroke-dashoffset 2s ease;">
                            </circle>

                            <!-- Gradient definition -->
                            <defs>
                                <linearGradient id="riskGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#4ade80;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#fbbf24;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#ef4444;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                        </svg>

                        <!-- Center content -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div id="risk-score-number" style="font-size: 72px; font-weight: 700; line-height: 1; background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                --
                            </div>
                            <div style="font-size: 16px; color: #888; margin-top: 8px;">/ 100</div>
                        </div>
                    </div>

                    <!-- Stats beside circle -->
                    <div style="margin-left: 60px;">
                        <div id="risk-level-badge" style="background: #dc3545; color: white; padding: 8px 24px; border-radius: 24px; font-weight: 600; font-size: 18px; margin-bottom: 30px; text-align: center; box-shadow: 0 4px 12px rgba(220,53,69,0.4);">
                            CRITICAL
                        </div>

                        <div style="display: flex; gap: 40px;">
                            <div style="text-align: center;">
                                <div id="subdomain-count" style="font-size: 42px; font-weight: 700; color: #4ade80;">0</div>
                                <div style="font-size: 14px; color: #888; margin-top: 4px;">Subdomains</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="services-count" style="font-size: 42px; font-weight: 700; color: #fbbf24;">0</div>
                                <div style="font-size: 14px; color: #888; margin-top: 4px;">Services</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="critical-services-count" style="font-size: 42px; font-weight: 700; color: #dc3545;">0</div>
                                <div style="font-size: 14px; color: #888; margin-top: 4px;">Critical Services</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Score Explanation -->
                <div style="background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; padding: 16px; margin-top: 20px;">
                    <p style="margin: 0; font-size: 13px; color: #aaa; line-height: 1.6;">
                        <strong style="color: #ffd700;">Risk Score Factors:</strong>
                        Critical CVEs (3), High CVEs (1), Public Exploits (1), CISA KEV (+15), Open Ports, Database Exposure (+10), SSH/RDP Access, and Subdomain Count.
                        <a href="#" style="color: #ffd700; text-decoration: none; margin-left: 8px;">Learn more </a>
                    </p>
                </div>
            </div>

            <!-- Visualization Charts -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 25px;">
                <!-- Asset Network Map -->
                <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 24px; border: 1px solid rgba(255,215,0,0.15);">
                    <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #ffd700;">
                        <span style="margin-right: 8px;"></span> Asset Network Map
                    </h3>
                    <div id="network-diagram" style="width: 100%; height: 400px; background: rgba(0,0,0,0.2); border-radius: 8px; position: relative;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #888;">
                            <p>Network visualization will appear here</p>
                            <p style="font-size: 12px; margin-top: 8px;">Showing relationships between discovered assets</p>
                        </div>
                    </div>
                </div>

                <!-- Vulnerability Severity Breakdown -->
                <div class="results-section">
                    <div class="section-header">
                        <div class="section-title"> Vulnerability Severity</div>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #888; font-weight: 400;">
                            CVE severity distribution (CVSS-based)
                        </p>
                    </div>
                    <div class="section-content" style="display: block; padding: 30px;">
                        <div id="vulnerability-severity-chart" style="width: 100%; height: 450px; display: flex; align-items: center; justify-content: center;">
                            <!-- Chart will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Grid Container -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-top: 30px;">

                <!-- Row 1: Critical Services + Risk Assets -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div>
                            <h3>Critical Services</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #888; font-weight: 400;">
                                Services with critical/high vulnerabilities
                            </p>
                        </div>
                        <span id="heatmapCount" class="badge">0</span>
                    </div>
                    <div id="heatmapContent" class="card-content">
                        <!-- Heat map content -->
                    </div>
                </div>

                <!-- Row 2: Critical Findings + Discovered Subdomains -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div>
                            <h3>Critical Findings</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #888; font-weight: 400;">
                                Top critical issues requiring immediate action
                            </p>
                        </div>
                        <span id="criticalFindingsCount" class="badge">0</span>
                    </div>
                    <div id="criticalContent" class="card-content">
                        <!-- Critical findings list -->
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <div>
                            <h3>Discovered Subdomains</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #888; font-weight: 400;">
                                DNS hostnames discovered during enumeration
                            </p>
                        </div>
                        <span id="subdomainCount" class="badge">0</span>
                    </div>
                    <div id="subdomainsContent" class="card-content">
                        <!-- Subdomains list -->
                    </div>
                </div>

                <!-- Row 3: Cloud Assets + Open Ports -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div>
                            <h3>Cloud Assets</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #888; font-weight: 400;">
                                S3 buckets, Azure blobs, GCP storage discovered
                            </p>
                        </div>
                        <span id="cloudCount" class="badge">0</span>
                    </div>
                    <div id="cloudContent" class="card-content">
                        <div style="text-align: center; padding: 40px 20px; color: #888;">
                            <p>No cloud assets detected</p>
                            <p style="font-size: 12px; margin-top: 8px;">AWS, Azure, GCP resources will appear here</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <div>
                            <h3>Open Ports</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #888; font-weight: 400;">
                                Network services exposed to internet
                            </p>
                        </div>
                        <span id="portsCount" class="badge">0</span>
                    </div>
                    <div id="portsContent" class="card-content">
                        <!-- Open ports list -->
                    </div>
                </div>

                <!-- Row 4: DNS Records (full width) -->
                <div class="dashboard-card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <h3>DNS Records</h3>
                        <span id="dnsCount" class="badge">0</span>
                    </div>
                    <div id="dnsContent" class="card-content">
                        <!-- DNS records table -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Attack Simulation Modal -->
    <div id="attackModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"> AI Attack Simulation</div>
                <button class="modal-close" onclick="closeAttackModal()">&times;</button>
            </div>
            <div class="modal-body" id="attackPlanContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Generating attack simulation with Gemini AI...</p>
                </div>
            </div>
        </div>
    </div>
        </div>
        <!-- End ASM Tab -->

        <!-- Lightbox Testing Tab Content -->
        <div id="lightboxTab" class="tab-content">
            <!-- Lightbox Dashboard -->
            <div id="lightbox-dashboard">
                <!-- Legal Authorization Warning Banner -->
                <div id="lightbox-legal-warning" style="background: linear-gradient(135deg, rgba(220,53,69,0.15) 0%, rgba(255,140,0,0.15) 100%); border: 2px solid #dc3545; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(220,53,69,0.2);">
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="font-size: 36px; line-height: 1;"></div>
                        <div style="flex: 1;">
                            <h3 style="color: #ff6b6b; margin: 0 0 12px 0; font-size: 18px; font-weight: 700;">
                                 LEGAL AUTHORIZATION REQUIRED
                            </h3>
                            <p style="color: #ffaa99; margin: 0 0 16px 0; font-size: 14px; line-height: 1.6;">
                                <strong style="color: #ff6b6b;">IMPORTANT:</strong> Only test domains you own or have explicit written authorization to test.
                                Unauthorized security testing may violate computer crime laws in your jurisdiction, including but not limited to the
                                Computer Fraud and Abuse Act (CFAA), Computer Misuse Act, or equivalent legislation.
                                <strong>You are solely responsible for ensuring you have proper authorization.</strong>
                            </p>
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px 16px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,107,107,0.3); transition: all 0.2s;" onmouseover="this.style.borderColor='#ff6b6b'" onmouseout="this.style.borderColor='rgba(255,107,107,0.3)'">
                                <input type="checkbox" id="lightbox-auth-checkbox" style="width: 20px; height: 20px; cursor: pointer; accent-color: #4caf50;">
                                <span style="color: #fff; font-size: 14px; font-weight: 500;">
                                    I confirm I have legal authorization to perform security testing on the target domain
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Header Section -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: rgba(255,215,0,0.05); border-radius: 12px; border: 1px solid rgba(255,215,0,0.2);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div>
                            <h2 style="margin: 0 0 8px 0; font-size: 24px; color: #ffd700;">Lightbox Security Testing</h2>
                            <p style="margin: 0; font-size: 14px; color: #aaa;">Deep vulnerability scanning with active testing</p>
                        </div>
                        <button id="lightbox-info-btn" style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; height: fit-content;" onmouseover="this.style.background='rgba(255,215,0,0.3)'" onmouseout="this.style.background='rgba(255,215,0,0.2)'">
                             What is Lightbox?
                        </button>
                    </div>
                    <button id="run-lightbox-scan" class="btn-primary" disabled style="padding: 14px 28px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #666 0%, #444 100%); border: none; border-radius: 8px; color: #999; cursor: not-allowed; box-shadow: none; transition: all 0.3s; opacity: 0.6;">
                         Authorization Required
                    </button>
                </div>

                <!-- Progress Container (hidden by default) - Hourglass Only -->
                <div id="lightbox-progress-container" style="display: none; margin-top: 20px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 30px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 64px; animation: pulse 2s ease-in-out infinite;">&#9203;</div>
                        <div style="color: #ffd700; font-size: 18px; margin-top: 16px; font-weight: 600;">
                            Testing in Progress
                        </div>
                        <div style="color: #888; font-size: 14px; margin-top: 8px;">
                            This may take 15-20 minutes
                        </div>
                    </div>
                </div>

                <style>
                    @keyframes pulse {
                        0%, 100% { opacity: 1; transform: scale(1); }
                        50% { opacity: 0.7; transform: scale(1.1); }
                    }
                </style>

                <!-- Test Category Cards Grid -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">

                    <!-- HTTP Security Testing Card -->
                    <div class="test-category-card">
                        <div class="test-card-icon" style="font-size: 32px;"></div>
                        <h3 class="test-card-title">HTTP Security</h3>
                        <p class="test-card-description">Security headers, SSL/TLS, cookies</p>
                        <div class="test-card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Tests Run</span>
                                <span id="http-tests-count" class="stat-value">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Findings</span>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; margin-top: 6px;" class="findings-clickable" data-category="http">
                                    <span id="http-findings-count" class="stat-value" style="margin: 0;">--</span>
                                    <span style="font-size: 18px; opacity: 0.6; transition: all 0.2s; line-height: 1;"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Authentication Testing Card -->
                    <div class="test-category-card">
                        <div class="test-card-icon" style="font-size: 32px;"></div>
                        <h3 class="test-card-title">Authentication</h3>
                        <p class="test-card-description">Default credentials, login security</p>
                        <div class="test-card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Panels Tested</span>
                                <span id="auth-tests-count" class="stat-value">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Findings</span>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; margin-top: 6px;" class="findings-clickable" data-category="auth">
                                    <span id="auth-findings-count" class="stat-value" style="margin: 0;">--</span>
                                    <span style="font-size: 18px; opacity: 0.6; transition: all 0.2s; line-height: 1;"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Injection Testing Card -->
                    <div class="test-category-card">
                        <div class="test-card-icon" style="font-size: 32px;"></div>
                        <h3 class="test-card-title">Injection Attacks</h3>
                        <p class="test-card-description">XXE, SSRF, file upload</p>
                        <div class="test-card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Tests Run</span>
                                <span id="injection-tests-count" class="stat-value">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Findings</span>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; margin-top: 6px;" class="findings-clickable" data-category="injection">
                                    <span id="injection-findings-count" class="stat-value" style="margin: 0;">--</span>
                                    <span style="font-size: 18px; opacity: 0.6; transition: all 0.2s; line-height: 1;"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sensitive Data Card -->
                    <div class="test-category-card">
                        <div class="test-card-icon" style="font-size: 32px;"></div>
                        <h3 class="test-card-title">Data Exposure</h3>
                        <p class="test-card-description">Config files, backups, info disclosure</p>
                        <div class="test-card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Files Checked</span>
                                <span id="data-tests-count" class="stat-value">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Findings</span>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; margin-top: 6px;" class="findings-clickable" data-category="data">
                                    <span id="data-findings-count" class="stat-value" style="margin: 0;">--</span>
                                    <span style="font-size: 18px; opacity: 0.6; transition: all 0.2s; line-height: 1;"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Network Services Card -->
                    <div class="test-category-card">
                        <div class="test-card-icon" style="font-size: 32px;"></div>
                        <h3 class="test-card-title">Network Services</h3>
                        <p class="test-card-description">SSH, databases, open ports</p>
                        <div class="test-card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Services</span>
                                <span id="network-tests-count" class="stat-value">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Findings</span>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; margin-top: 6px;" class="findings-clickable" data-category="network">
                                    <span id="network-findings-count" class="stat-value" style="margin: 0;">--</span>
                                    <span style="font-size: 18px; opacity: 0.6; transition: all 0.2s; line-height: 1;"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Security Card -->
                    <div class="test-category-card">
                        <div class="test-card-icon" style="font-size: 32px;"></div>
                        <h3 class="test-card-title">API Security</h3>
                        <p class="test-card-description">GraphQL, REST, Swagger, auth tests</p>
                        <div class="test-card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Tests Run</span>
                                <span id="api-tests-count" class="stat-value">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Findings</span>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; margin-top: 6px;" class="findings-clickable" data-category="api">
                                    <span id="api-findings-count" class="stat-value" style="margin: 0;">--</span>
                                    <span style="font-size: 18px; opacity: 0.6; transition: all 0.2s; line-height: 1;"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Business Logic Card -->
                    <div class="test-category-card">
                        <div class="test-card-icon" style="font-size: 32px;"></div>
                        <h3 class="test-card-title">Business Logic</h3>
                        <p class="test-card-description">Rate limits, IDOR, auth bypass</p>
                        <div class="test-card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Tests Run</span>
                                <span id="logic-tests-count" class="stat-value">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Findings</span>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; margin-top: 6px;" class="findings-clickable" data-category="logic">
                                    <span id="logic-findings-count" class="stat-value" style="margin: 0;">--</span>
                                    <span style="font-size: 18px; opacity: 0.6; transition: all 0.2s; line-height: 1;"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Scans Card -->
                    <div class="test-category-card">
                        <div class="test-card-icon" style="font-size: 32px;"></div>
                        <h3 class="test-card-title">Advanced Scans</h3>
                        <p class="test-card-description" id="nuclei-description">Curated vulnerability templates (CVEs, exposures, misconfigs)</p>
                        <div class="test-card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Templates</span>
                                <span id="nuclei-tests-count" class="stat-value">500+</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Findings</span>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; margin-top: 6px;" class="findings-clickable" data-category="nuclei">
                                    <span id="nuclei-findings-count" class="stat-value" style="margin: 0;">--</span>
                                    <span style="font-size: 18px; opacity: 0.6; transition: all 0.2s; line-height: 1;"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Recent Scan History Section -->
                <div style="margin-top: 40px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-size: 18px; color: #ffd700;">Recent Scans</h3>
                        <p style="margin: 0; font-size: 12px; color: #888;">
                            Scans auto-delete after 30 days
                        </p>
                    </div>
                    <div id="lightbox-recent-scans-list">
                        <div style="text-align: center; padding: 40px; color: #888;">
                            Loading scan history...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results View (hidden by default) -->
            <div id="lightbox-results-view">
                <button id="back-to-lightbox-dashboard" style="margin-bottom: 20px; padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.3); color: #ffd700; border-radius: 6px; cursor: pointer;">
                     Back to Dashboard
                </button>
                <div id="lightbox-findings-display"></div>
            </div>
        </div>
        <!-- End Lightbox Tab -->

        <!-- Compliance Mapping Tab Content -->
        <div id="complianceTab" class="tab-content">
            <!-- Compliance Container -->
            <div class="compliance-container">
                <!-- SVG Gradient Definition -->
                <svg width="0" height="0" style="position: absolute;">
                    <defs>
                        <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#B8942E"/>
                            <stop offset="50%" stop-color="#D4AF37"/>
                            <stop offset="100%" stop-color="#E5C76B"/>
                        </linearGradient>
                    </defs>
                </svg>

                <!-- FRAMEWORK SELECTION VIEW -->
                <div id="frameworksView" class="frameworks-view">
                    <div class="compliance-header">
                        <h2>Compliance Management</h2>
                        <p>Select a compliance framework to begin your assessment. Track controls, upload evidence, and monitor your organization's compliance posture.</p>
                    </div>

                    <div class="frameworks-grid" id="frameworksGrid">
                        <!-- Framework cards will be populated by JavaScript -->
                        <div class="compliance-loading">
                            <div class="compliance-spinner"></div>
                            <p>Loading frameworks...</p>
                        </div>
                    </div>
                </div>

                <!-- ASSESSMENT DASHBOARD VIEW -->
                <div id="assessmentView" class="assessment-view">
                    <div class="assessment-header">
                        <div class="assessment-header-left">
                            <button class="btn-back" onclick="ComplianceManager.showFrameworks()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                                </svg>
                            </button>
                            <div class="assessment-title-group">
                                <h3 id="assessmentTitle">SOC 2 Assessment</h3>
                                <p id="assessmentSubtitle">Started on January 5, 2026</p>
                            </div>
                        </div>
                        <div class="assessment-header-right">
                            <button class="btn-import-scans" onclick="ComplianceManager.openImportModal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                                Import from Scans
                            </button>
                            <button class="btn-export" onclick="ComplianceManager.exportReport()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                </svg>
                                Export Report
                            </button>
                        </div>
                    </div>

                    <!-- Scan Summary Card (hidden by default) -->
                    <div id="scanSummaryCard" class="scan-summary-card" style="display: none;">
                        <div class="scan-summary-info">
                            <div class="scan-summary-icon"></div>
                            <div class="scan-summary-text">
                                <h5>Scan Integration Active</h5>
                                <p id="scanSummaryText">Controls have been auto-flagged based on XASM/Lightbox scan findings</p>
                            </div>
                        </div>
                        <div class="scan-summary-stats">
                            <div class="scan-stat">
                                <div class="scan-stat-value" id="scanFlaggedCount">0</div>
                                <div class="scan-stat-label">Flagged</div>
                            </div>
                            <div class="scan-stat">
                                <div class="scan-stat-value verified" id="scanVerifiedCount">0</div>
                                <div class="scan-stat-label">Verified</div>
                            </div>
                        </div>
                    </div>

                    <div class="assessment-overview">
                        <div class="progress-circle-card">
                            <div class="progress-circle">
                                <svg viewBox="0 0 180 180">
                                    <circle class="progress-circle-bg" cx="90" cy="90" r="80"/>
                                    <circle class="progress-circle-fill" id="progressCircle" cx="90" cy="90" r="80"/>
                                </svg>
                                <div class="progress-circle-text">
                                    <span class="progress-circle-value" id="progressValue">0%</span>
                                    <span class="progress-circle-label">Complete</span>
                                </div>
                            </div>
                            <h4>Overall Assessment Progress</h4>
                        </div>

                        <div class="status-cards">
                            <div class="status-card compliant">
                                <div class="status-card-value" id="statCompliant">0</div>
                                <div class="status-card-label">Compliant</div>
                            </div>
                            <div class="status-card partial">
                                <div class="status-card-value" id="statPartial">0</div>
                                <div class="status-card-label">In Progress</div>
                            </div>
                            <div class="status-card non-compliant">
                                <div class="status-card-value" id="statNonCompliant">0</div>
                                <div class="status-card-label">Non-Compliant</div>
                            </div>
                            <div class="status-card not-tested">
                                <div class="status-card-value" id="statNotTested">0</div>
                                <div class="status-card-label">Not Tested</div>
                            </div>
                        </div>
                    </div>

                    <div class="controls-section">
                        <div class="controls-header">
                            <h4>Control Requirements</h4>
                            <div class="controls-search">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35"/>
                                </svg>
                                <input type="text" placeholder="Search controls..." id="controlsSearch" oninput="ComplianceManager.filterControls(this.value)">
                            </div>
                        </div>

                        <div class="category-accordion" id="categoriesContainer">
                            <!-- Categories will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- EVIDENCE MODAL -->
            <div class="evidence-modal-overlay" id="evidenceModal">
                <div class="evidence-modal">
                    <div class="evidence-modal-header">
                        <h3>Manage Evidence</h3>
                        <button class="btn-modal-close" onclick="ComplianceManager.closeEvidenceModal()">&times;</button>
                    </div>
                    <div class="evidence-modal-body">
                        <div class="evidence-control-info">
                            <span class="evidence-control-id" id="evidenceControlId">CC1.1.a</span>
                            <span class="evidence-control-name" id="evidenceControlName">Sets the Tone at the Top</span>
                        </div>

                        <div class="evidence-form-group">
                            <label>Evidence Type</label>
                            <select id="evidenceType">
                                <option value="document">Document / Policy</option>
                                <option value="screenshot">Screenshot</option>
                                <option value="scan">Security Scan Result</option>
                                <option value="log">System Log</option>
                                <option value="note">Text Note</option>
                            </select>
                        </div>

                        <div class="evidence-form-group">
                            <label>Title</label>
                            <input type="text" id="evidenceTitle" placeholder="e.g., Information Security Policy v2.1">
                        </div>

                        <div class="evidence-form-group">
                            <label>Description / Notes</label>
                            <textarea id="evidenceDescription" placeholder="Add details about this evidence..."></textarea>
                        </div>

                        <div class="evidence-form-group">
                            <label>Upload File (Optional)</label>
                            <div class="file-upload-area" onclick="document.getElementById('evidenceFile').click()">
                                <div class="file-upload-icon"></div>
                                <div class="file-upload-text">Click to upload or drag and drop</div>
                                <div class="file-upload-hint">PDF, PNG, JPG, DOCX up to 10MB</div>
                                <input type="file" id="evidenceFile" style="display: none" accept=".pdf,.png,.jpg,.jpeg,.doc,.docx">
                            </div>
                        </div>

                        <div class="evidence-list" id="evidenceList">
                            <div class="evidence-list-header">
                                <h4>Uploaded Evidence</h4>
                            </div>
                            <!-- Evidence items will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="evidence-modal-footer">
                        <button class="btn-modal-cancel" onclick="ComplianceManager.closeEvidenceModal()">Cancel</button>
                        <button class="btn-modal-save" onclick="ComplianceManager.saveEvidence()">Save Evidence</button>
                    </div>
                </div>
            </div>

            <!-- IMPORT FROM SCANS MODAL -->
            <div class="evidence-modal-overlay" id="importScanModal">
                <div class="evidence-modal" style="max-width: 700px;">
                    <div class="evidence-modal-header">
                        <h3>Import Findings from Scans</h3>
                        <button class="btn-modal-close" onclick="ComplianceManager.closeImportModal()">&times;</button>
                    </div>
                    <div class="evidence-modal-body">
                        <p style="color: var(--text-muted); margin-bottom: 20px;">
                            Select a domain to analyze XASM and Lightbox scan findings and auto-flag relevant compliance controls.
                        </p>

                        <div class="evidence-form-group">
                            <label>Domain / Asset</label>
                            <select id="importDomainSelect" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--gold-border); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 14px;">
                                <option value="">Loading domains...</option>
                            </select>
                        </div>

                        <div id="importPreview" style="display: none; margin-top: 20px;">
                            <div style="background: rgba(59, 130, 246, 0.08); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: var(--radius-md); padding: 16px;">
                                <h4 style="color: #3b82f6; margin: 0 0 12px 0; font-size: 14px;">Scan Analysis Preview</h4>
                                <div id="importPreviewContent" style="color: var(--text-muted); font-size: 13px;">
                                    <!-- Preview content will be populated -->
                                </div>
                            </div>
                        </div>

                        <div id="importResults" style="display: none; margin-top: 20px;">
                            <div style="background: rgba(34, 197, 94, 0.08); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: var(--radius-md); padding: 16px;">
                                <h4 style="color: #22c55e; margin: 0 0 8px 0; font-size: 14px;"> Import Complete</h4>
                                <p id="importResultsText" style="color: var(--text-muted); font-size: 13px; margin: 0;"></p>
                            </div>
                        </div>
                    </div>
                    <div class="evidence-modal-footer">
                        <button class="btn-modal-cancel" onclick="ComplianceManager.closeImportModal()">Cancel</button>
                        <button class="btn-modal-save" id="importAnalyzeBtn" onclick="ComplianceManager.analyzeDomain()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35"/>
                            </svg>
                            Analyze Scans
                        </button>
                        <button class="btn-modal-save" id="importConfirmBtn" onclick="ComplianceManager.confirmImport()" style="display: none; background: #22c55e;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/>
                                <polyline points="15 3 21 3 21 9"/>
                                <line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                            Import & Flag Controls
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Compliance Mapping Tab -->

        <!-- VULNERABILITY REPORT TAB -->
        <div id="vulnerabilityTab" class="tab-content">
            <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #ffd700; margin-bottom: 8px;"> Vulnerability Assessment Report</h2>
                <p style="color: #888; margin-bottom: 32px;">
                    Comprehensive security analysis combining XASM and Lightbox scan results with advanced risk prioritization
                </p>

                <!-- STATE 1: No Scans Available -->
                <div id="vuln-state-no-scans" style="display: none;">
                    <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 60px 40px; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 20px;"></div>
                        <h2 style="color: #ffd700; margin-bottom: 16px;">No Recent Scans Available</h2>
                        <p style="color: #888; max-width: 600px; margin: 0 auto 24px;">
                            Run XASM and Lightbox scans first to generate a vulnerability report.
                            Both scan types are required for comprehensive analysis.
                        </p>
                        <div style="display: flex; gap: 16px; justify-content: center;">
                            <button onclick="switchTab('asm')" style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                 Go to XASM Scanner
                            </button>
                            <button onclick="switchTab('lightbox')" style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                 Go to Lightbox Scanner
                            </button>
                        </div>
                    </div>
                </div>

                <!-- STATE 2: Select Company -->
                <div id="vuln-state-select" style="display: none;">
                    <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 40px;">
                        <h3 style="color: #ffd700; margin-bottom: 24px;">Select Company to Analyze</h3>

                        <input
                            type="text"
                            id="vuln-company-search"
                            placeholder=" Search companies..."
                            style="width: 100%; padding: 12px 20px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: #fff; font-size: 15px; margin-bottom: 24px; box-sizing: border-box;"
                            oninput="filterVulnCompanies()"
                        />

                        <div id="vuln-companies-list"></div>
                    </div>
                </div>

                <!-- STATE 3: Generating Report -->
                <div id="vuln-state-generating" style="display: none;">
                    <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 60px 40px; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 24px;"></div>
                        <h2 style="color: #ffd700; margin-bottom: 16px;">Generating Vulnerability Assessment...</h2>
                        <p id="vuln-generating-company" style="color: #888; font-size: 18px; margin-bottom: 32px;"></p>

                        <div style="max-width: 500px; margin: 0 auto; text-align: left;">
                            <div id="vuln-step-1" style="color: #4caf50; margin-bottom: 8px;"> Loading XASM scan results</div>
                            <div id="vuln-step-2" style="color: #4caf50; margin-bottom: 8px;"> Loading Lightbox scan results</div>
                            <div id="vuln-step-3" style="color: #888; margin-bottom: 8px;"> AI analyzing vulnerabilities...</div>
                            <div id="vuln-step-4" style="color: #666; margin-bottom: 8px;"> Prioritizing by business risk...</div>
                            <div id="vuln-step-5" style="color: #666; margin-bottom: 8px;"> Generating attack scenarios...</div>
                            <div id="vuln-step-6" style="color: #666; margin-bottom: 8px;"> Creating remediation plan...</div>
                        </div>

                        <p style="color: #666; margin-top: 32px; font-size: 13px;">This may take 30-60 seconds...</p>
                    </div>
                </div>

                <!-- STATE 4: Report Display -->
                <div id="vuln-state-report" style="display: none;">
                    <!-- Report will be rendered here -->
                </div>
            </div>
        </div>
        <!-- End Vulnerability Report Tab -->
    </div>

    <script>
        // Debugging
        console.log('Lightbox module loaded');
        console.log('Button exists:', document.getElementById('run-lightbox-scan'));

        const API_URL = 'http://localhost:5000';
        let currentResults = null;
        let progressPollInterval = null;
        let currentProgressInterval = null; // Lightbox progress interval
        let currentScanKey = null; // Global scan key for progress tracking
        let latestLightboxFindings = []; // Store latest findings for card filtering

        // Store current scan info globally for Lightbox to use
        let currentScanDomain = null;
        let currentASMScanId = null;

        // Event listeners
        document.getElementById('scanButton').addEventListener('click', () => performScan(false));
        document.getElementById('domainInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performScan(false);
        });

        function exampleScan(domain) {
            document.getElementById('domainInput').value = domain;
            performScan(false);
        }

        function formatTimeAgo(hours) {
            if (hours < 1) {
                const minutes = Math.floor(hours * 60);
                return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            } else if (hours < 24) {
                return `${Math.floor(hours)} hour${Math.floor(hours) !== 1 ? 's' : ''} ago`;
            } else {
                const days = Math.floor(hours / 24);
                return `${days} day${days !== 1 ? 's' : ''} ago`;
            }
        }

        async function pollProgress(domain) {
            try {
                const response = await fetch(`${API_URL}/api/ghost/asm/scan-progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain: domain })
                });

                const data = await response.json();

                if (data.success) {
                    const progress = data.progress || 0;
                    const total = data.total || 100;
                    const message = data.message || 'Scanning...';
                    const currentStep = data.current_step || 'Processing';

                    // Update progress bar with animation
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = `${progress}%`;

                    // Add pulse animation when actively scanning
                    if (progress < 100 && data.status === 'scanning') {
                        progressBar.style.animation = 'pulse 2s infinite';
                    } else {
                        progressBar.style.animation = 'none';
                    }

                    // Format progress text with icons and detailed info based on step
                    let stepIcon = '';
                    let stepDetails = '';

                    if (currentStep.includes('Subdomain')) {
                        stepIcon = '';
                        stepDetails = 'Discovering subdomains...';
                    } else if (currentStep.includes('Certificate')) {
                        stepIcon = '';
                        stepDetails = 'Querying Certificate Transparency logs...';
                    } else if (currentStep.includes('Subfinder')) {
                        stepIcon = '';
                        stepDetails = 'Discovering additional subdomains...';
                    } else if (currentStep.includes('Cloud')) {
                        stepIcon = '';
                        stepDetails = 'Scanning cloud storage assets...';
                    } else if (currentStep.includes('DNS')) {
                        stepIcon = '';
                        stepDetails = 'Enumerating DNS records...';
                    } else if (currentStep.includes('Port')) {
                        stepIcon = '';
                        stepDetails = 'Scanning open ports...';
                    } else if (currentStep.includes('Censys')) {
                        stepIcon = '';
                        stepDetails = 'Gathering threat intelligence...';
                    } else if (currentStep.includes('Threat')) {
                        stepIcon = '';
                        stepDetails = 'Analyzing threat data...';
                    } else if (currentStep.includes('Risk')) {
                        stepIcon = '';
                        stepDetails = 'Calculating risk score...';
                    } else if (currentStep.includes('Complete')) {
                        stepIcon = '';
                        stepDetails = 'Scan complete!';
                    } else {
                        stepDetails = currentStep;
                    }

                    // Build progress text with step name and percentage
                    const progressPercentage = Math.round(progress);
                    document.getElementById('progressText').textContent = `${stepIcon} ${currentStep} - ${progressPercentage}%`;

                    // Enhanced message display with counts and current item
                    let enhancedMessage = message;

                    // Extract counts from message if present
                    const foundMatch = message.match(/Found (\d+)/i);
                    const scanningMatch = message.match(/Scanning IP (\d+)\/(\d+)|Testing asset (\d+)\/(\d+)|Testing ports on IP (\d+)\/(\d+)/i);

                    if (foundMatch) {
                        // Highlight the count
                        const count = foundMatch[1];
                        enhancedMessage = message.replace(/(\d+)/, `<strong style="color: #D4AF37;">${count}</strong>`);
                    }

                    if (scanningMatch) {
                        // Highlight the progress ratio
                        enhancedMessage = message.replace(/(\d+\/\d+)/, `<strong style="color: #D4AF37;">$1</strong>`);
                    }

                    // Display the enhanced message with HTML
                    const scanningMessageEl = document.getElementById('scanningMessage');
                    scanningMessageEl.innerHTML = `${stepDetails}<br><span style="font-size: 0.9em; opacity: 0.9;">${enhancedMessage}</span>`;

                    // Stop polling if complete or failed
                    if (data.status === 'complete' || data.status === 'failed') {
                        if (progressPollInterval) {
                            clearInterval(progressPollInterval);
                            progressPollInterval = null;
                        }
                    }
                }
            } catch (error) {
                console.error('[PROGRESS] Error polling progress:', error);
            }
        }

        async function performScan(forceRescan = false) {
            const domain = document.getElementById('domainInput').value.trim();

            if (!domain) {
                alert('Please enter a domain to scan');
                return;
            }

            if (!/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(domain)) {
                alert('Please enter a valid domain (e.g., example.com)');
                return;
            }

            // DOMAIN CHANGE DETECTION: Clear Lightbox state when domain changes
            const previousDomain = window.lastScannedDomain || '';
            if (domain !== previousDomain && previousDomain !== '') {
                console.log('[LIGHTBOX] Domain changed from', previousDomain, 'to', domain, '- clearing Lightbox results');
                clearLightboxState();
            }
            window.lastScannedDomain = domain;

            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultsContainer = document.getElementById('resultsContainer');
            const errorContainer = document.getElementById('errorContainer');
            const scanButton = document.getElementById('scanButton');

            loadingIndicator.style.display = 'block';

            // Hide empty state when scan starts
            const emptyState = document.getElementById('xasmEmptyState');
            if (emptyState) emptyState.style.display = 'none';
            resultsContainer.style.display = 'none';
            errorContainer.innerHTML = '';
            scanButton.disabled = true;

            // Reset progress
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = 'Starting scan...';
            document.getElementById('scanningMessage').textContent = 'Initializing scan...';

            // Start polling progress every 2 seconds
            if (progressPollInterval) {
                clearInterval(progressPollInterval);
            }
            progressPollInterval = setInterval(() => pollProgress(domain), 2000);

            try {
                console.log(`[ASM] Starting scan for: ${domain} (force_rescan=${forceRescan})`);

                const response = await fetch(`${API_URL}/api/ghost/asm/scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain: domain, force_rescan: forceRescan })
                });

                const data = await response.json();
                console.log('[ASM] Scan response:', data);

                // Check for error response
                if (data.success === false || data.error) {
                    throw new Error(data.error || 'Scan failed');
                }

                // Store results (data is at top level, not nested in 'results')
                currentResults = data;
                displayResults(data);

                // CRITICAL: Store BOTH domain and scan ID for Lightbox
                currentScanDomain = data.domain || domain;
                currentASMScanId = data.id;  // THIS MUST BE SET

                // Also store in window for global access
                window.currentDomain = currentScanDomain;
                window.currentASMScanId = currentASMScanId;

                // SAVE TO LOCALSTORAGE for persistence across page refresh
                localStorage.setItem('nerve_current_domain', currentScanDomain);
                localStorage.setItem('nerve_current_scan_id', currentASMScanId);
                localStorage.setItem('nerve_last_tab', 'asm');

                console.log('[ASM] Stored - Domain:', currentScanDomain, 'Scan ID:', currentASMScanId);
                console.log('[ASM] Saved to localStorage for persistence');

                if (!currentASMScanId) {
                    console.error('[ASM] WARNING: Scan ID is null! Backend did not return scan ID.');
                    console.error('[ASM] Response data:', data);
                }

                // Show cache info if cached
                const cacheInfo = document.getElementById('cacheInfo');
                const cacheInfoText = document.getElementById('cacheInfoText');
                if (data.cached) {
                    const cacheAgeHours = data.cache_age_hours || 0;
                    cacheInfoText.textContent = `Last scanned: ${formatTimeAgo(cacheAgeHours)}`;
                    cacheInfo.style.display = 'block';
                } else {
                    cacheInfo.style.display = 'none';
                }

                console.log('[ASM] Scan complete:', currentResults);

            } catch (error) {
                // Stop progress polling on error
                if (progressPollInterval) {
                    clearInterval(progressPollInterval);
                    progressPollInterval = null;
                }
                console.error('[ASM] Error:', error);
                errorContainer.innerHTML = `
                    <div class="error-message">
                        <strong>Scan Error:</strong> ${error.message}
                        <br><br>
                        Please ensure the backend is running and try again.
                    </div>
                `;
            } finally {
                loadingIndicator.style.display = 'none';
                scanButton.disabled = false;

                // Stop progress polling
                if (progressPollInterval) {
                    clearInterval(progressPollInterval);
                    progressPollInterval = null;
                }
            }
        }

        // Re-scan button handler
        document.addEventListener('DOMContentLoaded', () => {
            const rescanButton = document.getElementById('rescanButton');
            if (rescanButton) {
                rescanButton.addEventListener('click', () => {
                    console.log('[ASM] Force re-scan requested');
                    performScan(true);
                });
            }
        });

        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}Content`);
            const icon = document.getElementById(`${sectionId}-icon`);

            content.classList.toggle('collapsed');
            icon.classList.toggle('expanded');
        }

        function getRiskBadgeClass(riskLevel) {
            const level = riskLevel ? riskLevel.toLowerCase() : 'low';
            return `badge-${level}`;
        }

        function displayResults(data) {
            console.log("Raw data received:", data);

            if (!data) {
                alert("No data received from backend");
                return;
            }

            const results = data;
            const subdomains = results.subdomains || [];
            const crtSubdomains = results.crt_subdomains || [];
            const cloudAssets = results.cloud_assets || [];
            const shodanResults = results.shodan_results || results.port_scan_results || [];
            const criticalFindings = results.critical_findings || [];
            const dnsRecords = results.dns_records || {};
            const risk = results.risk_score || 0;
            const riskLevel = results.risk_level || 'low';
            const vulnCount = results.vulnerabilities_found || 0;

            console.log("Parsed:", {
                subdomains: subdomains.length,
                ports: shodanResults.length,
                risk: risk
            });

            // Update risk score gauge
            updateRiskGauge(risk, riskLevel);

            // Build safe data object for all display functions
            const domain = document.getElementById('domainInput').value.trim();
            const safeResults = {
                domain: domain,
                subdomains: subdomains,
                crt_subdomains: crtSubdomains,
                cloud_assets: cloudAssets,
                shodan_results: shodanResults,
                port_scan_results: shodanResults,  // Alias for banner function
                critical_findings: criticalFindings,
                dns_records: dnsRecords,
                risk_score: risk,
                risk_level: riskLevel,
                vulnerabilities_found: vulnCount
            };

            // Update top banner statistics
            updateTopBanner(safeResults);

            buildHeatMap(safeResults);
            buildSeverityCategories(safeResults);

            // Display each section
            displayCriticalFindings(criticalFindings);
            displaySubdomains(subdomains, crtSubdomains);
            displayCloudAssets(cloudAssets);
            displayPorts(shodanResults);
            displayDNS(dnsRecords);

            // Create visualization charts
            createRiskScoreChart(risk, riskLevel);
            createVulnerabilitySeverityChart(safeResults);
            createNetworkDiagram(safeResults);

            // Show results container
            document.getElementById('resultsContainer').style.display = 'block';

            // Keep empty state hidden when results are shown
            const emptyStateEl = document.getElementById('xasmEmptyState');
            if (emptyStateEl) emptyStateEl.style.display = 'none';
        }

        // Chart.js instances (store globally to destroy on re-render)
        let riskScoreChartInstance = null;

        function createRiskScoreChart(score, level) {
            const ctx = document.getElementById('riskScoreChart');
            if (!ctx) return;

            // Destroy existing chart
            if (riskScoreChartInstance) {
                riskScoreChartInstance.destroy();
            }

            // Calculate remaining score (out of 100)
            const remaining = 100 - score;

            // Determine color based on risk level
            let riskColor = '#22c55e'; // green (low)
            if (level === 'critical') riskColor = '#ef4444'; // red
            else if (level === 'high') riskColor = '#f59e0b'; // orange
            else if (level === 'medium') riskColor = '#eab308'; // yellow

            riskScoreChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Risk Score', 'Safe'],
                    datasets: [{
                        data: [score, remaining],
                        backgroundColor: [riskColor, 'rgba(100, 100, 100, 0.2)'],
                        borderColor: ['rgba(0, 0, 0, 0.8)', 'rgba(0, 0, 0, 0.8)'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#e0e0e0',
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '/100';
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function createVulnerabilitySeverityChart(results) {
            const container = document.getElementById('vulnerability-severity-chart');

            if (!container) return;

            container.innerHTML = ''; // Clear

            // Count findings by severity
            let criticalCount = 0;
            let highCount = 0;
            let mediumCount = 0;
            let lowCount = 0;

            // Count from critical findings
            const criticalFindings = results.critical_findings || [];
            criticalFindings.forEach(finding => {
                const severity = (finding.severity || '').toLowerCase();
                if (severity === 'critical') criticalCount++;
                else if (severity === 'high') highCount++;
                else if (severity === 'medium') mediumCount++;
                else lowCount++;
            });

            // Count from port scan results
            const portResults = results.shodan_results || [];
            portResults.forEach(port => {
                const risk = (port.risk || '').toUpperCase();
                if (risk === 'CRITICAL') criticalCount++;
                else if (risk === 'HIGH') highCount++;
                else if (risk === 'MEDIUM') mediumCount++;
                else if (risk === 'LOW') lowCount++;
            });

            const severityCounts = {
                critical: criticalCount,
                high: highCount,
                medium: mediumCount,
                low: lowCount
            };

            const total = Object.values(severityCounts).reduce((a, b) => a + b, 0);

            if (total === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #888;">
                        <p style="font-size: 16px;">No vulnerabilities detected</p>
                        <p style="font-size: 13px; margin-top: 8px; opacity: 0.7;">Run a scan to analyze vulnerability severity</p>
                    </div>
                `;
                return;
            }

            const width = 500;  // INCREASED from ~300
            const height = 400; // INCREASED from ~250
            const radius = Math.min(width, height) / 2 - 40;

            const svg = d3.select('#vulnerability-severity-chart')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width/2}, ${height/2})`);

            const color = d3.scaleOrdinal()
                .domain(['critical', 'high', 'medium', 'low'])
                .range(['#dc3545', '#fd7e14', '#ffc107', '#28a745']);

            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.5)  // Donut chart
                .outerRadius(radius);

            const pieData = pie(
                Object.entries(severityCounts).map(([key, value]) => ({
                    label: key,
                    value: value
                }))
            );

            // Draw slices
            const slices = svg.selectAll('path')
                .data(pieData)
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.label))
                .attr('stroke', '#000')
                .attr('stroke-width', 3)
                .style('filter', 'drop-shadow(0 4px 8px rgba(0,0,0,0.4))')
                .style('cursor', 'pointer')
                .on('mouseenter', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', d3.arc()
                            .innerRadius(radius * 0.5)
                            .outerRadius(radius + 10)
                        );
                })
                .on('mouseleave', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arc);
                });

            // Add labels
            const labelArc = d3.arc()
                .innerRadius(radius * 0.7)
                .outerRadius(radius * 0.7);

            svg.selectAll('text')
                .data(pieData)
                .enter()
                .append('text')
                .attr('transform', d => `translate(${labelArc.centroid(d)})`)
                .attr('text-anchor', 'middle')
                .style('font-size', '18px')  // INCREASED from 14px
                .style('font-weight', '700')
                .style('fill', '#fff')
                .style('text-shadow', '0 0 4px #000, 0 0 8px #000')
                .text(d => d.data.value > 0 ? d.data.value : '');

            // Add legend below chart (moved further down to avoid overlap)
            const legend = svg.append('g')
                .attr('transform', `translate(-${width/2 - 40}, ${height/2 - 30})`);  // CHANGED: -30 instead of -60

            const legendData = [
                { label: 'Critical', color: '#dc3545', value: severityCounts.critical },
                { label: 'High', color: '#fd7e14', value: severityCounts.high },
                { label: 'Medium', color: '#ffc107', value: severityCounts.medium },
                { label: 'Low', color: '#28a745', value: severityCounts.low }
            ];

            legendData.forEach((item, i) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(${i * 120}, 0)`);  // CHANGED: 120 instead of 110 for more spacing

                legendRow.append('rect')
                    .attr('width', 18)  // CHANGED: Slightly larger
                    .attr('height', 18)
                    .attr('fill', item.color)
                    .attr('rx', 3);

                legendRow.append('text')
                    .attr('x', 24)
                    .attr('y', 14)
                    .style('font-size', '15px')
                    .style('font-weight', '600')  // ADD: Bold text
                    .style('fill', '#fff')  // CHANGED: Brighter white
                    .text(item.label);
            });
        }

        function createNetworkDiagram(scanData) {
            console.log('[NETWORK MAP] Building diagram with data:', scanData);

            const container = document.getElementById('network-diagram');

            if (!container) {
                console.error('[NETWORK MAP] Canvas element not found!');
                return;
            }

            console.log('[NETWORK MAP] Canvas found:', container);

            container.innerHTML = ''; // Clear any existing content

            // Check if we have data
            if (!scanData || (!scanData.subdomains && !scanData.shodan_results && !scanData.port_scan_results)) {
                console.log('[NETWORK MAP] No data available for visualization');
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #888;">
                        <div style="text-align: center;">
                            <p style="font-size: 16px; margin-bottom: 8px;">No network data available</p>
                            <p style="font-size: 13px; opacity: 0.7;">Run a scan to visualize asset relationships</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Build proper 3-level hierarchy network structure
            const nodes = [];
            const links = [];
            const addedNodes = new Set();

            console.log('[NETWORK MAP] Building 3-level hierarchy: Root  Subdomains  Services');

            // STEP 1: Add ROOT domain (the scanned domain) - ONLY ONCE
            const rootDomain = scanData.domain;

            if (!addedNodes.has(rootDomain)) {
                nodes.push({
                    id: rootDomain,
                    label: rootDomain,
                    type: 'root',
                    risk: 'high'
                });
                addedNodes.add(rootDomain);
            }

            // STEP 2: Add subdomains (filtered to exclude root)
            const actualSubdomains = scanData.subdomains?.filter(sub => sub.subdomain !== scanData.domain) || [];

            console.log('[NETWORK MAP] Root:', scanData.domain);
            console.log('[NETWORK MAP] Filtered subdomains:', actualSubdomains.map(s => s.subdomain));

            actualSubdomains.forEach(sub => {
                const subName = sub.subdomain;

                if (addedNodes.has(subName)) return;

                nodes.push({
                    id: subName,
                    label: subName,
                    type: 'subdomain',
                    risk: 'medium'
                });
                addedNodes.add(subName);

                links.push({
                    source: scanData.domain,
                    target: subName
                });
            });

            // STEP 3: Add SERVICES (connect each to its subdomain by IP)
            const addedServices = new Set();

            if (scanData.port_scan_results) {
                scanData.port_scan_results.forEach(port => {
                    if (port.risk !== 'CRITICAL' && port.risk !== 'HIGH') return;

                    const serviceId = `${port.ip}:${port.port}`;
                    if (addedServices.has(serviceId)) return;

                    nodes.push({
                        id: serviceId,
                        label: `${port.service}\n${port.port}`,
                        type: 'service',
                        risk: port.risk.toLowerCase()
                    });
                    addedServices.add(serviceId);

                    // Find which subdomain this IP belongs to
                    let connected = false;
                    if (scanData.subdomains) {
                        for (const sub of scanData.subdomains) {
                            if (sub.ips && sub.ips.includes(port.ip)) {
                                links.push({
                                    source: sub.subdomain,
                                    target: serviceId
                                });
                                connected = true;
                                break;
                            }
                        }
                    }

                    // Fallback: connect to root if no subdomain match
                    if (!connected) {
                        links.push({
                            source: rootDomain,
                            target: serviceId
                        });
                    }
                });
            }

            console.log('[NETWORK MAP] Structure:', {
                root: rootDomain,
                nodes: nodes.length,
                links: links.length
            });

            console.log(`[NETWORK MAP] Rendering ${nodes.length} nodes and ${links.length} links`);

            // Create responsive SVG that fits within card
            const width = 800;
            const height = 400;

            console.log('[NETWORK MAP] SVG dimensions:', width, 'x', height);
            console.log('[NETWORK MAP] Nodes:', nodes.length);
            console.log('[NETWORK MAP] Links:', links.length);

            const svg = d3.select('#network-diagram')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`)
                .attr('preserveAspectRatio', 'xMidYMid meet')
                .style('max-width', '100%')
                .style('max-height', '400px')
                .style('background', 'rgba(0,0,0,0.2)')
                .style('border-radius', '8px');

            // Create force simulation
            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links)
                    .id(d => d.id)
                    .distance(d => {
                        // Longer links from root to subdomains
                        if (d.source.type === 'root' || d.target.type === 'root') return 150;
                        // Shorter links from subdomains to services
                        return 80;
                    })
                )
                .force("charge", d3.forceManyBody().strength(-300))
                .force("collision", d3.forceCollide().radius(d => d.radius || 15))
                .force("center", d3.forceCenter(width / 2, height / 2));

            // PIN the root node to the center (CRITICAL FIX)
            nodes.forEach(node => {
                if (node.type === 'root') {
                    node.fx = width / 2;  // Fixed X position (center)
                    node.fy = height / 2;  // Fixed Y position (center)
                }
            });

            // Draw links
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('stroke', 'rgba(255,215,0,0.4)')
                .attr('stroke-width', 2);

            // Draw nodes
            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter()
                .append('circle')
                .attr('r', d => {
                    if (d.type === 'root') return 24;
                    if (d.type === 'subdomain') return 14;
                    if (d.type === 'service') return 12;
                    return 10;
                })
                .attr('fill', d => {
                    if (d.type === 'root') return '#ffd700';
                    if (d.type === 'subdomain') return '#4ade80';
                    if (d.type === 'service') {
                        // Color based on risk level
                        if (d.risk === 'critical') return '#dc3545';
                        if (d.risk === 'high') return '#fd7e14';
                        return '#ffc107';
                    }
                    return '#3b82f6';
                })
                .attr('stroke', '#000')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add labels
            const label = svg.append('g')
                .selectAll('text')
                .data(nodes)
                .enter()
                .append('text')
                .text(d => {
                    // Use custom label if available
                    const text = d.label || d.id;
                    if (text.length > 25) return text.substring(0, 22) + '...';
                    return text;
                })
                .attr('font-size', d => d.type === 'root' ? 12 : 10)
                .attr('fill', '#fff')
                .attr('text-anchor', 'middle')
                .attr('dy', -20)
                .style('pointer-events', 'none')
                .style('text-shadow', '0 0 4px #000');

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => Math.max(30, Math.min(width - 30, d.x)))
                    .attr('cy', d => Math.max(30, Math.min(height - 30, d.y)));

                label
                    .attr('x', d => Math.max(30, Math.min(width - 30, d.x)))
                    .attr('y', d => Math.max(30, Math.min(height - 30, d.y)));
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        function updateRiskScore(score) {
            console.log("updateRiskScore received:", score);

            // Safety checks
            if (score === null || score === undefined) {
                console.error("updateRiskScore: No score provided");
                score = 0;
            }

            // Ensure score is a number and within valid range
            score = parseInt(score) || 0;
            score = Math.max(0, Math.min(100, score));

            console.log("Updating risk score display:", score);

            const scoreElement = document.getElementById('risk-score-number');
            const arcElement = document.getElementById('risk-score-arc');
            const badgeElement = document.getElementById('risk-level-badge');

            // Animate number
            scoreElement.textContent = score;

            // Animate arc (754 = circumference of r=120 circle)
            const circumference = 754;
            const offset = circumference - (score / 100) * circumference;
            arcElement.style.strokeDashoffset = offset;

            // Update badge color and text
            if (score >= 80) {
                badgeElement.style.background = '#dc3545';
                badgeElement.textContent = 'CRITICAL';
                badgeElement.style.boxShadow = '0 4px 12px rgba(220,53,69,0.4)';
            } else if (score >= 60) {
                badgeElement.style.background = '#fd7e14';
                badgeElement.textContent = 'HIGH';
                badgeElement.style.boxShadow = '0 4px 12px rgba(253,126,20,0.4)';
            } else if (score >= 40) {
                badgeElement.style.background = '#ffc107';
                badgeElement.textContent = 'MEDIUM';
                badgeElement.style.boxShadow = '0 4px 12px rgba(255,193,7,0.4)';
            } else {
                badgeElement.style.background = '#28a745';
                badgeElement.textContent = 'LOW';
                badgeElement.style.boxShadow = '0 4px 12px rgba(40,167,69,0.4)';
            }
        }

        // Legacy function for backward compatibility
        function updateRiskGauge(score, level) {
            updateRiskScore(score);
        }

        // Update top banner statistics with scan data
        function updateTopBanner(scanData) {
            const riskScore = scanData.risk_score || 0;
            const subdomainCount = scanData.subdomains ? scanData.subdomains.length : 0;
            const crtSubdomainCount = scanData.crt_subdomains ? scanData.crt_subdomains.length : 0;
            const serviceCount = scanData.port_scan_results ? scanData.port_scan_results.length : 0;

            // Count critical services (not just CVEs)
            console.log('[BANNER DEBUG] ==================');
            console.log('[BANNER DEBUG] scanData.port_scan_results:', scanData.port_scan_results);

            let criticalServices = 0;

            if (scanData.port_scan_results && scanData.port_scan_results.length > 0) {
                console.log('[BANNER DEBUG] Total ports:', scanData.port_scan_results.length);

                // Show first 3 ports as sample
                console.log('[BANNER DEBUG] Sample ports:', scanData.port_scan_results.slice(0, 3).map(p => ({
                    port: p.port,
                    service: p.service,
                    risk_level: p.risk_level,
                    risk: p.risk,
                    severity: p.severity,
                    all_keys: Object.keys(p)
                })));

                // Try different field names
                const byCriticalRiskLevel = scanData.port_scan_results.filter(p => p.risk_level === 'CRITICAL').length;
                const byRisk = scanData.port_scan_results.filter(p => p.risk === 'CRITICAL').length;
                const bySeverity = scanData.port_scan_results.filter(p => p.severity === 'CRITICAL').length;

                console.log('[BANNER DEBUG] Count CRITICAL only by risk_level:', byCriticalRiskLevel);
                console.log('[BANNER DEBUG] Count CRITICAL only by risk:', byRisk);
                console.log('[BANNER DEBUG] Count CRITICAL only by severity:', bySeverity);

                // Count ONLY CRITICAL services (not HIGH) - p.risk contains the correct severity
                criticalServices = scanData.port_scan_results.filter(p => {
                    return p.risk === 'CRITICAL';
                }).length;

                console.log('[BANNER DEBUG] Final critical services count:', criticalServices);
            }

            console.log('[BANNER DEBUG] ==================');

            // Update banner statistics with null safety
            const criticalOnly = scanData.port_scan_results?.filter(p => p.risk === 'CRITICAL').length || 0;

            document.getElementById('subdomain-count').textContent = subdomainCount + crtSubdomainCount;
            document.getElementById('services-count').textContent = serviceCount;

            const criticalElement = document.getElementById('critical-services-count');
            if (criticalElement) {
                criticalElement.textContent = criticalOnly;
            }

            console.log('Banner updated:', { riskScore, subdomains: subdomainCount + crtSubdomainCount, services: serviceCount, critical: criticalServices });
        }

        function buildHeatMap(scanResults) {
            console.log("buildHeatMap received:", scanResults);

            // Safety checks
            if (!scanResults) {
                console.error("No scan results provided to buildHeatMap");
                return;
            }

            const container = document.getElementById('heatmapContent');

            if (!container) return;

            // Collect and filter CRITICAL and HIGH services from port scan results
            const portResults = scanResults.shodan_results || scanResults.port_scan_results || [];
            const filteredServices = [];

            if (Array.isArray(portResults)) {
                portResults.forEach(result => {
                    if (!result) return;

                    // Include services where risk === 'CRITICAL' OR 'HIGH'
                    if (result.risk !== 'CRITICAL' && result.risk !== 'HIGH') return;

                    filteredServices.push(result);
                });
            }

            // Sort: CRITICAL first, then HIGH
            const sortedServices = filteredServices.sort((a, b) => {
                if (a.risk === 'CRITICAL' && b.risk === 'HIGH') return -1;
                if (a.risk === 'HIGH' && b.risk === 'CRITICAL') return 1;
                return 0;
            });

            // Build service objects with vulnerabilities
            const criticalAndHighServices = [];

            sortedServices.forEach(result => {
                const cves = result.cves || result.vulnerabilities || [];
                const vulns = [];

                // Add CVEs
                if (Array.isArray(cves)) {
                    cves.forEach(cve => {
                        const cvss = cve.cvss || 0;
                        const severity = cvss >= 9.0 ? 'CRITICAL' :
                                       cvss >= 7.0 ? 'HIGH' :
                                       cvss >= 4.0 ? 'MEDIUM' : 'LOW';

                        vulns.push({
                            type: cve.id || cve.cve_id || 'Unknown CVE',
                            severity: severity,
                            cvss: cvss,
                            description: cve.description || cve.summary || 'No description available',
                            exploitAvailable: cve.exploit_available || cve.exploitable || false
                        });
                    });
                }

                // Add exposure vulnerabilities based on port
                if (result.port === 3306 || result.port === 5432 || result.port === 27017 || result.port === 6379) {
                    const dbNames = {
                        3306: 'MySQL/MariaDB',
                        5432: 'PostgreSQL',
                        27017: 'MongoDB',
                        6379: 'Redis'
                    };
                    vulns.push({
                        type: 'Database Exposed',
                        severity: 'CRITICAL',
                        description: `${dbNames[result.port] || 'Database'} accessible from internet on port ${result.port}`
                    });
                }

                if (result.port === 23) {
                    vulns.push({
                        type: 'Telnet Exposed',
                        severity: 'CRITICAL',
                        description: 'Telnet service exposes unencrypted credentials'
                    });
                }

                // If no specific vulnerabilities, add generic risk service entry
                if (vulns.length === 0) {
                    vulns.push({
                        type: `${result.risk} Risk Service`,
                        severity: result.risk,
                        description: `${result.service || 'Service'} on port ${result.port} identified as ${result.risk} risk`
                    });
                }

                criticalAndHighServices.push({
                    name: `${result.ip}:${result.port}`,
                    type: result.service || 'Unknown',
                    severity: result.risk,
                    vulnerabilities: vulns
                });
            });

            // Count CRITICAL and HIGH services
            const cardBadgeCount = criticalAndHighServices.length;
            document.getElementById('heatmapCount').textContent = cardBadgeCount;

            if (criticalAndHighServices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #4ade80;">
                        <p style="font-size: 16px;"> No Critical or High Risk Services Detected</p>
                    </div>
                `;
                return;
            }

            // Create table with CRITICAL and HIGH services
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid rgba(255,215,0,0.3);">
                                <th style="padding: 12px; text-align: left; color: #ffd700; font-weight: 600; font-size: 13px;">ASSET NAME</th>
                                <th style="padding: 12px; text-align: left; color: #ffd700; font-weight: 600; font-size: 13px;">TYPE</th>
                                <th style="padding: 12px; text-align: center; color: #ffd700; font-weight: 600; font-size: 13px;">SEVERITY</th>
                                <th style="padding: 12px; text-align: center; color: #ffd700; font-weight: 600; font-size: 13px;">VULNERABILITIES</th>
                                <th style="padding: 12px; text-align: center; color: #ffd700; font-weight: 600; font-size: 13px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${criticalAndHighServices.map((asset, index) => `
                                <tr class="heat-map-row" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td style="padding: 14px; color: #ffd700; font-size: 13px;">${asset.name}</td>
                                    <td style="padding: 14px; color: #ccc; font-size: 13px;">${asset.type}</td>
                                    <td style="padding: 14px; text-align: center;">
                                        <span style="background: ${getSeverityBadgeColor(asset.severity)}; color: ${asset.severity === 'MEDIUM' ? '#000' : '#fff'}; padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: 700;">
                                            ${asset.severity}
                                        </span>
                                    </td>
                                    <td style="padding: 14px; text-align: center; color: #fff; font-weight: 600; font-size: 14px;">
                                        ${asset.vulnerabilities.length}
                                    </td>
                                    <td style="padding: 14px; text-align: center;">
                                        <button class="expand-vulns-btn" data-index="${index}" style="background: rgba(255,215,0,0.2); border: 1px solid rgba(255,215,0,0.4); color: #ffd700; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                            View Details 
                                        </button>
                                    </td>
                                </tr>
                                <tr id="vuln-details-${index}" class="vuln-details-row" style="display: none;">
                                    <td colspan="5" style="padding: 0; background: rgba(0,0,0,0.3);">
                                        <div style="padding: 20px; border-left: 4px solid ${getSeverityBadgeColor(asset.severity)};">
                                            <h4 style="margin: 0 0 12px 0; color: #ffd700; font-size: 14px;">Vulnerabilities for ${asset.name}:</h4>
                                            ${asset.vulnerabilities.map(vuln => `
                                                <div style="padding: 12px; margin-bottom: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid ${getSeverityBadgeColor(vuln.severity)};">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                                        <div style="font-weight: 600; color: #fff; font-size: 13px;">
                                                            ${vuln.type}
                                                            ${vuln.exploitAvailable ? ' <span style="color: #dc3545; font-size: 11px;"> Exploit Available</span>' : ''}
                                                        </div>
                                                        <div style="display: flex; gap: 8px; align-items: center;">
                                                            ${vuln.cvss ? `<span style="background: ${getSeverityBadgeColor(vuln.severity)}; color: ${vuln.severity === 'MEDIUM' ? '#000' : '#fff'}; padding: 2px 8px; border-radius: 3px; font-size: 10px; font-weight: 700;">CVSS ${vuln.cvss}</span>` : ''}
                                                            <span style="background: ${getSeverityBadgeColor(vuln.severity)}; color: ${vuln.severity === 'MEDIUM' ? '#000' : '#fff'}; padding: 2px 8px; border-radius: 3px; font-size: 10px; font-weight: 700;">${vuln.severity}</span>
                                                        </div>
                                                    </div>
                                                    <div style="font-size: 12px; color: #ccc; line-height: 1.5;">
                                                        ${vuln.description}
                                                    </div>
                                                    ${vuln.type.startsWith('CVE-') ? `
                                                        <div style="margin-top: 8px;">
                                                            <a href="https://nvd.nist.gov/vuln/detail/${vuln.type}" target="_blank" style="color: #4ade80; text-decoration: none; font-size: 11px;">
                                                                View in NVD Database 
                                                            </a>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Add click handlers for expand buttons
            document.querySelectorAll('.expand-vulns-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    const detailsRow = document.getElementById(`vuln-details-${index}`);

                    if (detailsRow.style.display === 'none') {
                        detailsRow.style.display = 'table-row';
                        this.textContent = 'Hide Details ';
                    } else {
                        detailsRow.style.display = 'none';
                        this.textContent = 'View Details ';
                    }
                });
            });

            // Store critical and high services for reference
            window.currentAssets = criticalAndHighServices;
        }

        function buildSeverityCategories(results) {
            console.log("buildSeverityCategories received:", results);

            // Safety checks
            if (!results) {
                console.error("buildSeverityCategories: No results provided");
                return;
            }

            // DISABLED - Service Risk Distribution card removed
            // displayAssetRiskDistribution(results);
        }

        function displayAssetRiskDistribution(scanData) {
            console.log('[DISABLED] displayAssetRiskDistribution - card removed');
            return;
        }

        function populateEnhancedAssetList(elementId, assets) {
            const container = document.getElementById(elementId);

            if (!container) return;

            if (assets.length === 0) {
                container.innerHTML = '<div style="padding: 12px; color: #888; font-size: 13px;">No assets in this category</div>';
                return;
            }

            container.innerHTML = assets.map(asset => `
                <div style="padding: 14px; margin-bottom: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid ${getSeverityColor(asset.highestCVSS)};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; color: #ffd700; font-size: 14px; margin-bottom: 4px;">
                                ${asset.ip}
                            </div>
                            <div style="font-size: 12px; color: #aaa;">
                                ${asset.service} (Port ${asset.port})
                            </div>
                        </div>
                        ${asset.highestCVSS > 0 ? `
                            <div style="background: ${getSeverityColor(asset.highestCVSS)}; color: #000; padding: 3px 10px; border-radius: 4px; font-size: 11px; font-weight: 700;">
                                CVSS ${asset.highestCVSS.toFixed(1)}
                            </div>
                        ` : ''}
                    </div>

                    <div style="font-size: 12px; color: #ccc; margin-bottom: 6px;">
                        <strong>Risk Factor:</strong> ${asset.reason}
                    </div>

                    ${asset.cveCount > 0 ? `
                        <div style="display: flex; gap: 8px; align-items: center; font-size: 11px; color: #888;">
                            <span> ${asset.cveCount} CVE(s)</span>
                            ${asset.criticalCVEs.length > 0 ? `<span style="color: #dc3545;"> ${asset.criticalCVEs.length} Critical</span>` : ''}
                            ${asset.highCVEs.length > 0 ? `<span style="color: #fd7e14;"> ${asset.highCVEs.length} High</span>` : ''}
                        </div>
                    ` : ''}

                    ${asset.criticalCVEs.length > 0 ? `
                        <div style="margin-top: 8px; padding: 8px; background: rgba(220,53,69,0.1); border-radius: 4px;">
                            <div style="font-size: 11px; font-weight: 600; color: #dc3545; margin-bottom: 4px;">
                                Top Critical CVE:
                            </div>
                            <div style="font-size: 11px; color: #ccc;">
                                ${asset.criticalCVEs[0].id} (CVSS ${asset.criticalCVEs[0].cvss})
                                ${asset.criticalCVEs[0].description ? `<br><span style="color: #999;">${asset.criticalCVEs[0].description.substring(0, 80)}...</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function getSeverityColor(cvss) {
            if (cvss >= 9.0) return '#dc3545';
            if (cvss >= 7.0) return '#fd7e14';
            if (cvss >= 4.0) return '#ffc107';
            return '#28a745';
        }

        function getSeverityBadgeColor(severity) {
            switch(severity) {
                case 'CRITICAL': return '#dc3545';
                case 'HIGH': return '#fd7e14';
                case 'MEDIUM': return '#ffc107';
                case 'LOW': return '#28a745';
                default: return '#6c757d';
            }
        }

        function toggleSeverityCategory(severity) {
            const content = document.getElementById(`${severity}CategoryContent`);
            const icon = document.getElementById(`${severity}-category-icon`);

            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        let currentSortField = 'severity';
        let currentSortAsc = true;

        function sortHeatMap(field) {
            if (!window.currentAssets) return;

            if (currentSortField === field) {
                currentSortAsc = !currentSortAsc;
            } else {
                currentSortField = field;
                currentSortAsc = true;
            }

            const assets = [...window.currentAssets];

            assets.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                if (field === 'severity') {
                    const order = { 'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
                    aVal = order[aVal];
                    bVal = order[bVal];
                }

                if (field === 'vulnerabilities') {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }

                if (aVal < bVal) return currentSortAsc ? -1 : 1;
                if (aVal > bVal) return currentSortAsc ? 1 : -1;
                return 0;
            });

            // Rebuild table body
            const tbody = document.getElementById('heatmapTableBody');
            let html = '';

            assets.forEach((asset, idx) => {
                const badgeClass = getRiskBadgeClass(asset.severity);
                const statusClass = asset.status === 'Exposed' ? 'status-exposed' :
                                   asset.status === 'Protected' ? 'status-protected' : 'status-monitored';

                html += `
                    <tr onclick="toggleAssetDetails(${idx})" data-asset-index="${idx}">
                        <td class="asset-cell">${asset.name}</td>
                        <td>${asset.type}</td>
                        <td class="severity-cell">
                            <span class="asset-badge ${badgeClass}">${asset.severity}</span>
                        </td>
                        <td class="vuln-count">${asset.vulnerabilities}</td>
                        <td class="status-cell">
                            <span class="status-badge ${statusClass}">${asset.status}</span>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function toggleAssetDetails(index) {
            // Future enhancement: expand row to show full details
            console.log('Asset clicked:', window.currentAssets[index]);
        }

        function displayCriticalFindings(findings) {
            console.log("displayCriticalFindings received:", findings);

            // Safety checks
            if (!findings) {
                console.error("displayCriticalFindings: No findings provided");
                findings = [];
            }

            if (!Array.isArray(findings)) {
                console.error("displayCriticalFindings: findings is not an array");
                findings = [];
            }

            const container = document.getElementById('criticalContent');

            // Filter to ONLY show CRITICAL severity findings
            const criticalOnly = findings.filter(finding => {
                if (!finding) return false;
                const severity = (finding.severity || '').toUpperCase();
                return severity === 'CRITICAL';
            });

            // Limit to top 10 critical findings
            const topFindings = criticalOnly.slice(0, 10);

            document.getElementById('criticalFindingsCount').textContent = topFindings.length;

            if (topFindings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #4ade80;">
                        <p style="font-size: 16px; font-weight: 600;"> No Critical Issues Detected</p>
                        <p style="font-size: 13px; margin-top: 8px; opacity: 0.7;">Great job! No immediate critical vulnerabilities found.</p>
                    </div>
                `;
                return;
            }

            console.log("Displaying", topFindings.length, "CRITICAL findings (filtered from", findings.length, "total)");

            let html = '';
            topFindings.forEach(finding => {
                if (!finding) return;

                const badgeClass = getRiskBadgeClass('CRITICAL');
                html += `
                    <div class="asset-item">
                        <div class="asset-header">
                            <div class="asset-name">${finding.type || 'Unknown Finding'}</div>
                            <span class="asset-badge ${badgeClass}">CRITICAL</span>
                        </div>
                        <div class="asset-details">${finding.description || 'No description available'}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displaySubdomains(subdomains, crtSubdomains) {
            console.log("displaySubdomains received:", { subdomains, crtSubdomains });

            // Safety checks
            if (!subdomains) {
                console.error("displaySubdomains: No subdomains provided");
                subdomains = [];
            }
            if (!crtSubdomains) {
                console.error("displaySubdomains: No crtSubdomains provided");
                crtSubdomains = [];
            }

            if (!Array.isArray(subdomains)) {
                console.error("displaySubdomains: subdomains is not an array");
                subdomains = [];
            }
            if (!Array.isArray(crtSubdomains)) {
                console.error("displaySubdomains: crtSubdomains is not an array");
                crtSubdomains = [];
            }

            const container = document.getElementById('subdomainsContent');
            const total = subdomains.length + crtSubdomains.length;
            document.getElementById('subdomainCount').textContent = total;

            console.log("Displaying subdomains:", { dns: subdomains.length, crt: crtSubdomains.length });

            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><p>No subdomains discovered</p></div>';
                return;
            }

            let html = '';

            // DNS subdomains
            subdomains.forEach(sub => {
                if (!sub) return;

                const subIps = sub.ips || [];
                const ips = subIps.map(ip => `<span class="asset-badge badge-low">${ip || 'N/A'}</span>`).join(' ') || '<span class="asset-badge badge-low">No IP</span>';
                const subdomain = sub.subdomain || 'Unknown';
                const subType = sub.type || 'Unknown';

                html += `
                    <div class="asset-item">
                        <div class="asset-header">
                            <div class="asset-name">
                                <a href="http://${subdomain}" target="_blank">${subdomain}</a>
                            </div>
                            <span class="asset-badge badge-medium">DNS</span>
                        </div>
                        <div class="asset-details">
                            Type: ${subType}<br>
                            IP Addresses: ${ips}
                        </div>
                    </div>
                `;
            });

            // crt.sh subdomains
            crtSubdomains.slice(0, 20).forEach(sub => {
                if (!sub) return;

                const subdomain = sub.subdomain || 'Unknown';
                html += `
                    <div class="asset-item">
                        <div class="asset-header">
                            <div class="asset-name">
                                <a href="http://${subdomain}" target="_blank">${subdomain}</a>
                            </div>
                            <span class="asset-badge badge-low">crt.sh</span>
                        </div>
                        <div class="asset-details">Source: Certificate Transparency</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayCloudAssets(assets) {
            console.log("displayCloudAssets received:", assets);

            // Safety checks
            if (!assets) {
                console.error("displayCloudAssets: No assets provided");
                assets = [];
            }

            if (!Array.isArray(assets)) {
                console.error("displayCloudAssets: assets is not an array");
                assets = [];
            }

            const container = document.getElementById('cloudContent');
            document.getElementById('cloudCount').textContent = assets.length;

            console.log("Displaying", assets.length, "cloud assets");

            if (assets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <p style="font-size: 16px; margin-bottom: 8px;">No cloud assets discovered</p>
                        <p style="font-size: 13px; opacity: 0.7;">S3 buckets, Azure blobs, and GCP storage checked</p>
                    </div>
                `;
                return;
            }

            let html = '';
            assets.forEach(asset => {
                if (!asset) return;

                const assetName = asset.name || 'Unknown';
                const assetUrl = asset.url || '#';
                const assetRisk = asset.risk || 'LOW';
                const assetType = asset.type || 'Unknown';
                const assetStatus = asset.status || 'Unknown';
                const badgeClass = getRiskBadgeClass(assetRisk);

                html += `
                    <div class="asset-item">
                        <div class="asset-header">
                            <div class="asset-name">
                                <a href="${assetUrl}" target="_blank">${assetName}</a>
                            </div>
                            <span class="asset-badge ${badgeClass}">${assetRisk}</span>
                        </div>
                        <div class="asset-details">
                            Type: ${assetType}<br>
                            Status: ${assetStatus}<br>
                            URL: <a href="${assetUrl}" target="_blank">${assetUrl}</a>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayPorts(shodanResults) {
            console.log("displayPorts received:", shodanResults);

            // Safety checks
            if (!shodanResults) {
                console.error("displayPorts: No results provided");
                shodanResults = [];
            }

            if (!Array.isArray(shodanResults)) {
                console.error("displayPorts: shodanResults is not an array");
                shodanResults = [];
            }

            const container = document.getElementById('portsContent');
            document.getElementById('portsCount').textContent = shodanResults.length;

            console.log("Displaying", shodanResults.length, "port scan results");

            if (shodanResults.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><p>No port scan results found</p></div>';
                return;
            }

            // DEBUG: Show first port structure
            console.log('[PORTS DEBUG] First port structure:', shodanResults[0]);
            console.log('[PORTS DEBUG] All keys in first port:', Object.keys(shodanResults[0]));
            console.log('[PORTS DEBUG] risk_level values:', shodanResults.slice(0, 10).map(p => p.risk_level));
            console.log('[PORTS DEBUG] risk values:', shodanResults.slice(0, 10).map(p => p.risk));
            console.log('[PORTS DEBUG] severity values:', shodanResults.slice(0, 10).map(p => p.severity));

            // SORT by risk level: CRITICAL  HIGH  MEDIUM  LOW
            console.log('[PORTS] Before sort:', shodanResults.map(p => `${p.port}:${p.risk || 'UNKNOWN'}`));

            const severityOrder = {
                'CRITICAL': 0,
                'HIGH': 1,
                'MEDIUM': 2,
                'LOW': 3,
                'INFO': 4
            };

            const sortedPorts = [...shodanResults].sort((a, b) => {
                const severityA = severityOrder[a.risk] ?? 5;
                const severityB = severityOrder[b.risk] ?? 5;
                console.log(`[PORTS] Comparing port ${a.port} (${a.risk}=${severityA}) vs port ${b.port} (${b.risk}=${severityB})`);
                return severityA - severityB;
            });

            console.log('[PORTS] After sort:', sortedPorts.map(p => `${p.port}:${p.risk || 'UNKNOWN'}`));
            console.log(`[PORTS] Sorted ${sortedPorts.length} ports by severity`);

            let html = '';
            sortedPorts.forEach(result => {
                if (!result) return;

                const resultIp = result.ip || 'Unknown';
                const resultPort = result.port || '?';
                const resultRisk = result.risk || 'LOW';
                const resultService = result.service || 'Unknown';
                const resultVersion = result.version || '';
                const resultOrg = result.organization || 'N/A';
                const resultLocation = result.location || {};
                const locationCity = resultLocation.city || 'Unknown';
                const locationCountry = resultLocation.country || 'Unknown';
                const resultBanner = result.banner || '';
                const vulnerabilities = result.vulnerabilities || [];

                const badgeClass = getRiskBadgeClass(resultRisk);
                const vulnBadges = vulnerabilities.map(cve =>
                    `<span class="asset-badge badge-critical">${cve || 'Unknown CVE'}</span>`
                ).join(' ');

                html += `
                    <div class="asset-item">
                        <div class="asset-header">
                            <div class="asset-name">
                                <a href="https://www.shodan.io/host/${resultIp}" target="_blank">${resultIp}:${resultPort}</a>
                            </div>
                            <span class="asset-badge ${badgeClass}">${resultRisk}</span>
                        </div>
                        <div class="asset-details">
                            Service: <strong>${resultService} ${resultVersion}</strong><br>
                            Organization: ${resultOrg}<br>
                            Location: ${locationCity}, ${locationCountry}<br>
                            ${vulnerabilities.length > 0 ? `CVEs: ${vulnBadges}<br>` : ''}
                            ${resultBanner ? `Banner: <code>${resultBanner.substring(0, 100)}...</code>` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayDNS(dnsRecords) {
            console.log("displayDNS received:", dnsRecords);

            // Safety checks
            if (!dnsRecords) {
                console.error("displayDNS: No DNS records provided");
                dnsRecords = {};
            }

            if (typeof dnsRecords !== 'object') {
                console.error("displayDNS: dnsRecords is not an object");
                dnsRecords = {};
            }

            const container = document.getElementById('dnsContent');

            let totalRecords = 0;
            for (const recordType in dnsRecords) {
                const records = dnsRecords[recordType];
                if (Array.isArray(records)) {
                    totalRecords += records.length;
                }
            }

            document.getElementById('dnsCount').textContent = totalRecords;

            console.log("Displaying", totalRecords, "DNS records");

            if (totalRecords === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><p>No DNS records found</p></div>';
                return;
            }

            let html = '';

            for (const recordType in dnsRecords) {
                const records = dnsRecords[recordType];

                // Safety check - ensure records is an array
                if (!Array.isArray(records) || records.length === 0) continue;

                records.forEach(record => {
                    if (!record) return;

                    let recordValue = '';
                    if (typeof record === 'string') {
                        recordValue = record;
                    } else if (recordType === 'MX') {
                        const priority = record.priority || 'N/A';
                        const server = record.server || 'N/A';
                        recordValue = `Priority: ${priority}, Server: ${server}`;
                    } else if (recordType === 'SOA') {
                        const mname = record.mname || 'N/A';
                        const rname = record.rname || 'N/A';
                        recordValue = `MNAME: ${mname}, RNAME: ${rname}`;
                    } else {
                        try {
                            recordValue = JSON.stringify(record);
                        } catch (e) {
                            recordValue = 'Invalid record format';
                        }
                    }

                    html += `
                        <div class="asset-item">
                            <div class="asset-header">
                                <span class="asset-badge badge-low">${recordType || 'Unknown'}</span>
                            </div>
                            <div class="asset-details">${recordValue || 'No data'}</div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function exportAsTXT() {
            if (!currentResults) {
                alert('Please run a scan first');
                return;
            }

            let txt = `GHOST ATTACK SURFACE MANAGEMENT REPORT\n`;
            txt += `${'='.repeat(60)}\n\n`;
            txt += `Domain: ${currentResults.domain}\n`;
            txt += `Scan Time: ${currentResults.scan_time}\n`;
            txt += `Risk Score: ${currentResults.risk_score}/100 (${currentResults.risk_level.toUpperCase()})\n`;
            txt += `\n${'='.repeat(60)}\n\n`;

            txt += `CRITICAL FINDINGS (${currentResults.critical_findings.length})\n`;
            txt += `${'-'.repeat(60)}\n`;
            currentResults.critical_findings.forEach((f, i) => {
                txt += `${i + 1}. [${f.severity}] ${f.type}: ${f.description}\n`;
            });

            txt += `\n${'='.repeat(60)}\n\n`;
            txt += `SUBDOMAINS (${currentResults.subdomains.length + currentResults.crt_subdomains.length})\n`;
            txt += `${'-'.repeat(60)}\n`;
            currentResults.subdomains.forEach(sub => {
                txt += `${sub.subdomain} (${sub.ips.join(', ')})\n`;
            });
            currentResults.crt_subdomains.slice(0, 20).forEach(sub => {
                txt += `${sub.subdomain} (crt.sh)\n`;
            });

            txt += `\n${'='.repeat(60)}\n\n`;
            txt += `CLOUD ASSETS (${currentResults.cloud_assets.length})\n`;
            txt += `${'-'.repeat(60)}\n`;
            currentResults.cloud_assets.forEach(asset => {
                txt += `${asset.name} - ${asset.type} (${asset.status}) [${asset.risk}]\n`;
                txt += `  ${asset.url}\n`;
            });

            txt += `\n${'='.repeat(60)}\n\n`;
            txt += `OPEN PORTS & SERVICES (${currentResults.shodan_results.length})\n`;
            txt += `${'-'.repeat(60)}\n`;
            currentResults.shodan_results.forEach(result => {
                txt += `${result.ip}:${result.port} - ${result.service} ${result.version} [${result.risk}]\n`;
                if (result.vulnerabilities.length > 0) {
                    txt += `  CVEs: ${result.vulnerabilities.join(', ')}\n`;
                }
            });

            txt += `\n${'='.repeat(60)}\n`;
            txt += `Report generated by GHOST ASM Scanner\n`;

            // Download
            const blob = new Blob([txt], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `asm-report-${currentResults.domain}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('attackModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Save current tab to localStorage
            localStorage.setItem('nerve_last_tab', tabName);
            console.log(`[TAB] Switched to ${tabName}, saved to localStorage`);

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Auto-run tab actions
            if (tabName === 'lightbox' && currentScanDomain) {
                loadMostRecentLightboxScan(currentScanDomain);
            } else if (tabName === 'vulnerability') {
                onVulnerabilityTabOpen();
            } else if (tabName === 'compliance') {
                initComplianceTab();
            }
        }

        // Load most recent Lightbox scan and populate cards
        async function loadMostRecentLightboxScan(domain) {
            console.log(`[LIGHTBOX] Loading most recent scan for ${domain}`);

            try {
                const response = await fetch(`${API_URL}/api/ghost/lightbox/history/${domain}`);

                if (!response.ok) {
                    console.log('[LIGHTBOX] No history found');
                    await loadLightboxHistory(domain);
                    return;
                }

                const data = await response.json();

                if (data.scans && data.scans.length > 0) {
                    // Get most recent scan (first in array since they're sorted desc)
                    const mostRecent = data.scans[0];

                    console.log('[LIGHTBOX] Found most recent scan:', mostRecent);
                    console.log('[LIGHTBOX] Scan age:', mostRecent.scanned_at);

                    // Update cards with this scan data
                    // Include test_results if available (new comprehensive tracking structure)
                    updateTestCategoryCards({
                        findings: mostRecent.findings,
                        scan_metadata: mostRecent.scan_metadata,
                        test_results: mostRecent.test_results || mostRecent.scan_metadata?.test_results || {},
                        summary: {
                            critical: mostRecent.critical_count,
                            high: mostRecent.high_count,
                            medium: mostRecent.medium_count,
                            low: mostRecent.low_count
                        }
                    });

                    // Show a subtle indicator that this is cached data
                    const scanAge = new Date(mostRecent.scanned_at);
                    const now = new Date();
                    const hoursAgo = Math.round((now - scanAge) / (1000 * 60 * 60));

                    showNotification(` Showing results from ${hoursAgo} hours ago`, 'info');

                    console.log('[LIGHTBOX] Cards populated with cached data');
                } else {
                    console.log('[LIGHTBOX] No previous scans found');
                }

                // Always load history list
                await loadLightboxHistory();

            } catch (error) {
                console.error('[LIGHTBOX] Failed to load recent scan:', error);
                // Fail silently - user can still run new scan
                await loadLightboxHistory();
            }
        }

        // Lightbox Dashboard - Load scan history (uses new API endpoint)
        async function loadLightboxHistory() {
            const container = document.getElementById('lightbox-recent-scans-list');

            if (!container) {
                console.log('[Lightbox] Recent scans container not found');
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/lightbox/history');
                const data = await response.json();

                if (!data.success || !data.history || data.history.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 32px; margin-bottom: 12px;"></div>
                            <p style="color: #888;">No scans run yet</p>
                            <p style="color: #666; font-size: 13px;">Click "Run Lightbox Test" to start your first security test</p>
                        </div>
                    `;
                    return;
                }

                displayLightboxHistory(data.history);

            } catch (error) {
                console.error('[Lightbox] Error loading history:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #dc3545;">Failed to load scan history</p>
                    </div>
                `;
            }
        }

        function displayLightboxHistory(history) {
            const container = document.getElementById('lightbox-recent-scans-list');

            let html = '<div style="display: grid; gap: 12px;">';

            history.forEach(scan => {
                const date = new Date(scan.timestamp);
                const summary = scan.summary || {};
                const passRate = summary.pass_rate || 0;

                let rateColor = '#4caf50';
                if (passRate < 50) rateColor = '#dc3545';
                else if (passRate < 80) rateColor = '#ffd700';

                html += `
                    <div style="
                        background: rgba(0,0,0,0.3);
                        border: 1px solid rgba(255,215,0,0.2);
                        border-radius: 12px;
                        padding: 20px;
                        display: grid;
                        grid-template-columns: 1fr auto;
                        gap: 20px;
                        align-items: center;
                        transition: border-color 0.2s;
                    " onmouseover="this.style.borderColor='rgba(255,215,0,0.5)'"
                       onmouseout="this.style.borderColor='rgba(255,215,0,0.2)'">

                        <div>
                            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 8px;">
                                <h3 style="color: #ffd700; margin: 0; font-size: 18px;">${scan.target}</h3>

                                <!-- Pass Rate Circle -->
                                <div style="position: relative; width: 60px; height: 60px;">
                                    <svg width="60" height="60" style="transform: rotate(-90deg);">
                                        <circle cx="30" cy="30" r="26" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4"/>
                                        <circle cx="30" cy="30" r="26" fill="none" stroke="${rateColor}" stroke-width="4"
                                            stroke-dasharray="${2 * Math.PI * 26}"
                                            stroke-dashoffset="${2 * Math.PI * 26 * (1 - passRate / 100)}"
                                            style="transition: stroke-dashoffset 0.5s;"/>
                                    </svg>
                                    <div style="
                                        position: absolute;
                                        top: 50%;
                                        left: 50%;
                                        transform: translate(-50%, -50%);
                                        font-size: 14px;
                                        font-weight: 700;
                                        color: ${rateColor};
                                    ">${Math.round(passRate)}%</div>
                                </div>
                            </div>

                            <div style="color: #888; font-size: 13px; margin-bottom: 12px;">
                                ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div>
                                    <div style="color: #666; font-size: 11px; text-transform: uppercase;">Total Tests</div>
                                    <div style="color: #ffd700; font-size: 20px; font-weight: 700;">${scan.total_tests || 0}</div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 11px; text-transform: uppercase;">Passed</div>
                                    <div style="color: #4caf50; font-size: 20px; font-weight: 700;">${scan.passed_tests || 0}</div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 11px; text-transform: uppercase;">Failed</div>
                                    <div style="color: #dc3545; font-size: 20px; font-weight: 700;">${scan.failed_tests || 0}</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button onclick="deleteLightboxScan('${scan.scan_id}')" style="
                                background: rgba(220,53,69,0.2);
                                border: 1px solid #dc3545;
                                color: #dc3545;
                                padding: 10px 20px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 600;
                                white-space: nowrap;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='rgba(220,53,69,0.3)'"
                               onmouseout="this.style.background='rgba(220,53,69,0.2)'">
                                 Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Delete a Lightbox scan from history
        async function deleteLightboxScan(scanId) {
            if (!confirm('Delete this scan from history?')) return;

            try {
                const response = await fetch(`http://localhost:5000/api/lightbox/history/${scanId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Scan deleted', 'success');
                    loadLightboxHistory(); // Reload history
                } else {
                    alert('Failed to delete scan');
                }
            } catch (error) {
                console.error('[Lightbox] Error deleting scan:', error);
                alert('Error deleting scan');
            }
        }

        // Display Lightbox findings in results view
        function displayLightboxFindings(findings) {
            const container = document.getElementById('lightbox-findings-display');

            if (!findings || findings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>No security issues found</p>
                    </div>
                `;
                return;
            }

            // Group by severity
            const critical = findings.filter(f => f.severity === 'CRITICAL');
            const high = findings.filter(f => f.severity === 'HIGH');
            const medium = findings.filter(f => f.severity === 'MEDIUM');
            const low = findings.filter(f => f.severity === 'LOW');

            let html = `
                <div class="risk-banner">
                    <div class="risk-score">${findings.length}</div>
                    <div class="risk-label">Total Findings</div>
                    <div class="risk-stats">
                        <div class="risk-stat">
                            <div class="risk-stat-value">${critical.length}</div>
                            <div class="risk-stat-label">Critical</div>
                        </div>
                        <div class="risk-stat">
                            <div class="risk-stat-value">${high.length}</div>
                            <div class="risk-stat-label">High</div>
                        </div>
                        <div class="risk-stat">
                            <div class="risk-stat-value">${medium.length}</div>
                            <div class="risk-stat-label">Medium</div>
                        </div>
                        <div class="risk-stat">
                            <div class="risk-stat-value">${low.length}</div>
                            <div class="risk-stat-label">Low</div>
                        </div>
                    </div>
                </div>

                <div class="results-section">
                    <div class="section-header" onclick="toggleSection('lightboxFindings')">
                        <div class="section-title">
                             Lightbox Findings
                            <span class="expand-icon" id="lightboxFindings-icon"></span>
                        </div>
                        <span class="section-count">${findings.length}</span>
                    </div>
                    <div class="section-content" id="lightboxFindingsContent">
            `;

            findings.forEach(finding => {
                const badgeClass = getRiskBadgeClass(finding.severity);
                html += `
                    <div class="asset-item">
                        <div class="asset-header">
                            <div class="asset-name">${finding.type || finding.finding_type}</div>
                            <span class="asset-badge ${badgeClass}">${finding.severity}</span>
                        </div>
                        <div class="asset-details">
                            <p><strong>Asset:</strong> ${finding.asset}</p>
                            <p><strong>URL:</strong> <a href="${finding.url}" target="_blank">${finding.url}</a></p>
                            ${finding.explanation ? `
                                <div class="explanation" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <strong>Why This Matters:</strong>
                                    <p style="margin-top: 5px;">${finding.explanation}</p>
                                </div>
                            ` : ''}
                            ${finding.exploitable ? `
                                <div class="exploitability" style="margin-top: 10px;">
                                    <strong>Exploitability:</strong> ${finding.exploitable}
                                </div>
                            ` : ''}
                            ${finding.cves && finding.cves.length > 0 ? `
                                <div style="margin-top: 12px; padding: 12px; background: rgba(255,0,0,0.1); border-left: 3px solid #dc3545; border-radius: 4px;">
                                    <strong style="color: #dc3545;">Related Vulnerabilities:</strong><br>
                                    <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${finding.cves.map(cve => `
                                            ${cve.startsWith('CVE-') ? `
                                                <a href="https://nvd.nist.gov/vuln/detail/${cve}" target="_blank"
                                                   style="background: rgba(220,53,69,0.2); border: 1px solid #dc3545; color: #dc3545; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 700; transition: background 0.2s;"
                                                   onmouseover="this.style.background='rgba(220,53,69,0.3)'"
                                                   onmouseout="this.style.background='rgba(220,53,69,0.2)'">
                                                    ${cve} 
                                                </a>
                                            ` : cve.startsWith('CWE-') ? `
                                                <a href="https://cwe.mitre.org/data/definitions/${cve.replace('CWE-', '')}.html" target="_blank"
                                                   style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 700; transition: background 0.2s;"
                                                   onmouseover="this.style.background='rgba(255,215,0,0.3)'"
                                                   onmouseout="this.style.background='rgba(255,215,0,0.2)'">
                                                    ${cve} 
                                                </a>
                                            ` : `
                                                <span style="background: rgba(128,128,128,0.2); border: 1px solid #888; color: #888; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700;">
                                                    ${cve}
                                                </span>
                                            `}
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${finding.credentials ? `
                                <p style="margin-top: 10px; color: #ff4444;"><strong>Credentials:</strong> ${finding.credentials}</p>
                            ` : ''}
                            ${finding.status_code ? `
                                <p style="margin-top: 5px; font-size: 0.9em; opacity: 0.7;">Status Code: ${finding.status_code}</p>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Back to dashboard button
        document.getElementById('back-to-lightbox-dashboard').addEventListener('click', () => {
            console.log('[FINDINGS] Back to dashboard clicked');

            const dashboard = document.getElementById('lightbox-dashboard');
            const resultsView = document.getElementById('lightbox-results-view');
            const findingsDisplay = document.getElementById('lightbox-findings-display');

            // FORCE display using style.display
            if (dashboard) dashboard.style.display = 'block';
            if (resultsView) resultsView.style.display = 'none';
            if (findingsDisplay) findingsDisplay.style.display = 'none';

            console.log('[FINDINGS] Returned to dashboard');
        });

        // Lightbox info button handler
        document.getElementById('lightbox-info-btn').addEventListener('click', () => {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s;
            `;

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
                    border: 2px solid #ffd700;
                    border-radius: 16px;
                    padding: 40px;
                    max-width: 650px;
                    color: #fff;
                    box-shadow: 0 8px 32px rgba(255,215,0,0.3);
                    animation: slideUp 0.3s;
                ">
                    <h2 style="color: #ffd700; margin: 0 0 24px 0; font-size: 28px; text-align: center; text-shadow: 0 2px 4px rgba(255,215,0,0.3);">
                         What is Lightbox Testing?
                    </h2>

                    <p style="margin: 0 0 20px 0; line-height: 1.8; font-size: 15px; color: #ddd;">
                        Lightbox is an <strong style="color: #ffd700;">active security testing module</strong> that probes your web applications
                        for vulnerabilities. Unlike passive reconnaissance, Lightbox actually interacts
                        with your systems to discover security issues.
                    </p>

                    <h3 style="color: #ffd700; margin: 24px 0 16px 0; font-size: 18px; border-bottom: 2px solid rgba(255,215,0,0.3); padding-bottom: 8px;">
                        What it tests:
                    </h3>
                    <ul style="line-height: 2; margin: 0 0 20px 0; padding-left: 24px; color: #ddd;">
                        <li><strong style="color: #4ade80;">HTTP Security:</strong> Missing headers, weak SSL/TLS, insecure cookies</li>
                        <li><strong style="color: #4ade80;">Authentication:</strong> Exposed admin panels, default credentials</li>
                        <li><strong style="color: #4ade80;">Injection Attacks:</strong> XXE, SSRF, file upload vulnerabilities</li>
                        <li><strong style="color: #4ade80;">Data Exposure:</strong> Sensitive files, backup files, configuration leaks</li>
                        <li><strong style="color: #4ade80;">Network Services:</strong> Database exposure, SSH/RDP security, CVE mapping</li>
                        <li><strong style="color: #4ade80;">Advanced Scans:</strong> Nuclei template-based vulnerability detection</li>
                    </ul>

                    <div style="margin: 24px 0; padding: 16px; background: rgba(255,215,0,0.1); border-left: 4px solid #ffd700; border-radius: 6px;">
                        <strong style="color: #ffd700; font-size: 16px;"> Important Note:</strong>
                        <p style="margin: 8px 0 0 0; color: #ddd; line-height: 1.6;">
                            Lightbox testing is <strong>non-destructive</strong> but may trigger
                            security alerts. <strong style="color: #ff6b6b;">Only scan systems you own or have explicit permission to test.</strong>
                        </p>
                    </div>

                    <button onclick="this.closest('div').parentElement.remove()" style="
                        background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
                        border: none;
                        color: #000;
                        padding: 14px 32px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 700;
                        font-size: 15px;
                        width: 100%;
                        box-shadow: 0 4px 12px rgba(255,215,0,0.4);
                        transition: all 0.2s;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255,215,0,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255,215,0,0.4)'">
                        Got it! 
                    </button>
                </div>

                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(30px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                </style>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            // Close on Escape key
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        });

        // Run new Lightbox scan with progress tracking
        document.getElementById('run-lightbox-scan').addEventListener('click', async () => {
            console.log('[LIGHTBOX UI] Button clicked');
            console.log('[LIGHTBOX UI] Current domain:', currentScanDomain);
            console.log('[LIGHTBOX UI] Current scan ID:', currentASMScanId);

            // Check authorization checkbox
            const authCheckbox = document.getElementById('lightbox-auth-checkbox');
            if (!authCheckbox || !authCheckbox.checked) {
                alert(' Authorization Required\n\nYou must confirm you have legal authorization to test this domain before running Lightbox security tests.');
                return;
            }

            if (!currentScanDomain || !currentASMScanId) {
                alert('Please run an XASM scan first!\n\nGo to the "Attack Surface" tab and scan a domain before running Lightbox tests.');
                return;
            }

            const btn = document.getElementById('run-lightbox-scan');
            const progressContainer = document.getElementById('lightbox-progress-container');

            // Show hourglass, hide button
            if (progressContainer) {
                btn.style.display = 'none';
                progressContainer.style.display = 'block';
            } else {
                btn.disabled = true;
                btn.textContent = ' Running test...';
            }

            currentScanKey = `${currentScanDomain}_${Date.now()}`;
            console.log('[LIGHTBOX] Starting scan with key:', currentScanKey);

            try {
                // Start the scan
                const response = await fetch(`${API_URL}/api/ghost/lightbox/scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        domain: currentScanDomain,
                        scan_id: currentASMScanId,
                        scan_key: currentScanKey
                    })
                });

                console.log('[LIGHTBOX] Scan response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Scan failed');
                }

                const data = await response.json();
                console.log('[LIGHTBOX] Scan complete, data:', data);

                // Restore button, hide hourglass
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                    btn.style.display = 'inline-block';
                } else {
                    btn.disabled = false;
                    btn.textContent = ' Run Lightbox Test';
                }

                // Hide old stacked findings view, show dashboard with cards
                const findingsDisplay = document.getElementById('lightbox-findings-display');
                if (findingsDisplay) {
                    findingsDisplay.classList.remove('show');
                    console.log('[LIGHTBOX UI] Hid old findings display');
                }

                const dashboard = document.getElementById('lightbox-dashboard');
                if (dashboard) {
                    dashboard.style.display = 'block';
                    console.log('[LIGHTBOX UI] Showed dashboard');
                }

                // *** CRITICAL: Update test category cards ***
                updateTestCategoryCards(data);
                console.log('[LIGHTBOX] Cards updated, keeping dashboard visible');

                // FORCE dashboard to stay visible
                document.getElementById('lightbox-dashboard').style.display = 'block';
                document.getElementById('lightbox-results-view').style.display = 'none';

                // RELOAD HISTORY (wait for database write to complete)
                setTimeout(async () => {
                    await loadLightboxHistory();
                }, 1000);

                // Show success notification
                showNotification(' Lightbox test completed!', 'success');

            } catch (error) {
                console.error('[LIGHTBOX] Scan failed:', error);

                // Restore button, hide hourglass
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                    btn.style.display = 'inline-block';
                } else {
                    btn.disabled = false;
                    btn.textContent = ' Run Lightbox Test';
                }

                alert('Test failed: ' + error.message);
                showNotification(' Lightbox test failed', 'error');
            }
        });

        // Lightbox Authorization Checkbox Handler - Toggle button state based on consent
        (function() {
            const authCheckbox = document.getElementById('lightbox-auth-checkbox');
            const runLightboxBtn = document.getElementById('run-lightbox-scan');

            if (authCheckbox && runLightboxBtn) {
                authCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        // Enable the button with active styling
                        runLightboxBtn.disabled = false;
                        runLightboxBtn.style.background = 'linear-gradient(135deg, #ffd700 0%, #ff8c00 100%)';
                        runLightboxBtn.style.color = '#000';
                        runLightboxBtn.style.cursor = 'pointer';
                        runLightboxBtn.style.opacity = '1';
                        runLightboxBtn.style.boxShadow = '0 4px 15px rgba(255,215,0,0.3)';
                        runLightboxBtn.textContent = ' Run Lightbox Test';
                    } else {
                        // Disable the button
                        runLightboxBtn.disabled = true;
                        runLightboxBtn.style.background = 'linear-gradient(135deg, #666 0%, #444 100%)';
                        runLightboxBtn.style.color = '#999';
                        runLightboxBtn.style.cursor = 'not-allowed';
                        runLightboxBtn.style.opacity = '0.6';
                        runLightboxBtn.style.boxShadow = 'none';
                        runLightboxBtn.textContent = ' Authorization Required';
                    }
                });
                console.log('[LIGHTBOX] Checkbox handler registered successfully');
            } else {
                console.error('[LIGHTBOX] Could not find checkbox or button elements');
            }
        })();

        // Vulnerability Assessment
        let currentAssessments = null;
        let currentLightboxResults = null;

        async function runVulnAssessment() {
            if (!currentResults) {
                alert('Please run an ASM scan first to discover vulnerabilities');
                return;
            }

            const loadingIndicator = document.getElementById('vulnassessLoadingIndicator');
            const resultsContainer = document.getElementById('vulnassessResultsContainer');
            const errorContainer = document.getElementById('vulnassessErrorContainer');

            loadingIndicator.style.display = 'block';
            resultsContainer.style.display = 'none';
            errorContainer.innerHTML = '';

            try {
                console.log('[VULN ASSESS] Starting AI-powered assessment...');

                // Get Lightbox results if available
                const lightboxResults = currentLightboxResults || { critical: [], high: [], medium: [], low: [] };

                const response = await fetch(`${API_URL}/api/ghost/vuln-assessment/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        xasm_results: currentResults,
                        lightbox_results: lightboxResults
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Vulnerability assessment failed');
                }

                currentAssessments = data.results;
                displayVulnAssessments(data.results);
                console.log('[VULN ASSESS] Assessment complete:', data.results);

            } catch (error) {
                console.error('[VULN ASSESS] Error:', error);
                errorContainer.innerHTML = `
                    <div class="error-message">
                        <strong>Vulnerability Assessment Error:</strong> ${error.message}
                        <br><br>
                        Please ensure Gemini API is configured and try again.
                    </div>
                `;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function displayVulnAssessments(results) {
            const assessments = results.assessments || [];

            // Update stats
            document.getElementById('vulnassessTotalAssessed').textContent = assessments.length;

            const criticalCount = assessments.filter(a => a.severity === 'CRITICAL').length;
            const highCount = assessments.filter(a => a.severity === 'HIGH').length;
            const totalThreatActors = assessments.reduce((sum, a) => sum + (a.threat_actors?.length || 0), 0);

            document.getElementById('vulnassessCritical').textContent = criticalCount;
            document.getElementById('vulnassessHigh').textContent = highCount;
            document.getElementById('vulnassessThreatActors').textContent = totalThreatActors;

            // Display assessments
            const container = document.getElementById('vulnassessmentsList');

            if (assessments.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><p>No critical or high vulnerabilities found</p></div>';
                document.getElementById('vulnassessResultsContainer').style.display = 'block';
                return;
            }

            let html = '';

            assessments.forEach(assessment => {
                const badgeClass = getRiskBadgeClass(assessment.severity);

                html += `
                    <div class="results-section">
                        <div class="section-header" onclick="toggleSection('vuln-${assessment.finding_id}')">
                            <div class="section-title">
                                ${assessment.finding_id}: ${assessment.type}
                                <span class="asset-badge ${badgeClass}" style="margin-left: 10px;">${assessment.severity}</span>
                                <span class="expand-icon" id="vuln-${assessment.finding_id}-icon"></span>
                            </div>
                        </div>
                        <div class="section-content" id="vuln-${assessment.finding_id}Content">
                            <div class="asset-item" style="background: rgba(212, 175, 55, 0.03); border-left: none;">
                                <div class="asset-header">
                                    <div class="asset-name">Asset: ${assessment.asset}</div>
                                    ${assessment.cve ? `<span class="asset-badge badge-critical">${assessment.cve}</span>` : ''}
                                </div>
                                <div class="asset-details">
                                    <strong>Description:</strong> ${assessment.description}<br>
                                    <strong>Source:</strong> ${assessment.source}
                                </div>
                            </div>

                            <div style="padding: 20px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-top: 15px;">
                                <h3 style="color: #D4AF37; margin-bottom: 15px;"> AI-Powered Analysis</h3>
                                <div style="white-space: pre-wrap; line-height: 1.8; color: #e0e0e0;">
                                    ${formatAIAnalysis(assessment.ai_analysis)}
                                </div>
                            </div>

                            ${assessment.threat_actors && assessment.threat_actors.length > 0 ? `
                                <div style="padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-top: 15px; border: 1px solid rgba(239, 68, 68, 0.3);">
                                    <h3 style="color: #ef4444; margin-bottom: 15px;"> Associated Threat Actors</h3>
                                    ${assessment.threat_actors.map(actor => `
                                        <div style="margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                                            <strong style="color: #D4AF37;">${actor.name}</strong> (${actor.country})<br>
                                            <span style="color: #aaa;">Motivation: ${actor.motivation}</span><br>
                                            ${actor.targets && actor.targets.length > 0 ? `<span style="color: #aaa;">Targets: ${actor.targets.slice(0, 3).join(', ')}</span>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('vulnassessResultsContainer').style.display = 'block';
        }

        function formatAIAnalysis(text) {
            // Convert markdown-like formatting to HTML
            return text
                .replace(/### (\d+\. [A-Z\s]+)/g, '<h4 style="color: #D4AF37; margin-top: 20px; margin-bottom: 10px;">$1</h4>')
                .replace(/\*\*(.+?)\*\*/g, '<strong style="color: #fff;">$1</strong>')
                .replace(/^- (.+)$/gm, '<div style="margin-left: 20px; margin-bottom: 5px;"> $1</div>')
                .replace(/\n\n/g, '<br><br>');
        }

        function exportVulnAssessment() {
            if (!currentAssessments || !currentAssessments.assessments || currentAssessments.assessments.length === 0) {
                alert('Please run a vulnerability assessment first');
                return;
            }

            let txt = `AI-POWERED VULNERABILITY ASSESSMENT REPORT\n`;
            txt += `${'='.repeat(80)}\n\n`;
            txt += `Generated: ${new Date().toISOString()}\n`;
            txt += `Total Vulnerabilities Assessed: ${currentAssessments.assessments.length}\n`;
            txt += `${'='.repeat(80)}\n\n`;

            currentAssessments.assessments.forEach(assessment => {
                txt += `\n${'='.repeat(80)}\n`;
                txt += `${assessment.finding_id}: ${assessment.type}\n`;
                txt += `${'='.repeat(80)}\n\n`;

                txt += `Severity: ${assessment.severity}\n`;
                txt += `Asset: ${assessment.asset}\n`;
                txt += `Description: ${assessment.description}\n`;

                if (assessment.cve) {
                    txt += `CVE: ${assessment.cve}\n`;
                }

                txt += `\n${'-'.repeat(80)}\n`;
                txt += `AI ANALYSIS\n`;
                txt += `${'-'.repeat(80)}\n\n`;

                txt += assessment.ai_analysis;
                txt += `\n\n`;

                if (assessment.threat_actors && assessment.threat_actors.length > 0) {
                    txt += `${'-'.repeat(80)}\n`;
                    txt += `ASSOCIATED THREAT ACTORS\n`;
                    txt += `${'-'.repeat(80)}\n\n`;

                    assessment.threat_actors.forEach(actor => {
                        txt += `- ${actor.name} (${actor.country})\n`;
                        txt += `  Motivation: ${actor.motivation}\n`;
                        if (actor.targets && actor.targets.length > 0) {
                            txt += `  Targets: ${actor.targets.slice(0, 3).join(', ')}\n`;
                        }
                        txt += `\n`;
                    });
                }
            });

            txt += `${'='.repeat(80)}\n`;
            txt += `END OF VULNERABILITY ASSESSMENT REPORT\n`;
            txt += `${'='.repeat(80)}\n`;

            // Download
            const blob = new Blob([txt], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `vuln-assessment-${currentResults?.domain || 'report'}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Lightbox results are now loaded from historical scans
        // currentLightboxResults kept for backward compatibility with vuln assessment

        // Update test category cards with scan results
        function updateTestCategoryCards(scanData) {
            console.log('[CARDS] Updating with data:', scanData);

            const findings = scanData.findings || [];
            latestLightboxFindings = findings; // STORE GLOBALLY

            const metadata = scanData.scan_metadata || {};
            const nucleiData = scanData.nuclei_results || {};

            // ================================================================
            // CORRECTLY MAP BACKEND DATA STRUCTURE
            // ================================================================
            // Get test_results from backend (comprehensive tracking structure)
            const test_results = scanData.test_results || {};

            // Create unified results object with proper fallbacks
            const results = {
                http_security: {
                    tests_run: test_results.http_security?.tests_run || metadata.checks_run || 0,
                    findings: []
                },
                authentication: {
                    panels_tested: test_results.authentication?.panels_tested || 0,
                    findings: []
                },
                injection: {
                    tests_run: test_results.injection?.tests_run || 0,
                    findings: []
                },
                data_exposure: {
                    files_checked: test_results.data_exposure?.files_checked || 0,
                    findings: []
                },
                network: {
                    services_tested: test_results.network?.services_tested || 0,
                    findings: []
                },
                api_security: {
                    tests_run: test_results.api_security?.tests_run || 0,
                    findings: []
                },
                business_logic: {
                    tests_run: test_results.business_logic?.tests_run || 0,
                    findings: []
                },
                nuclei: {
                    templates_used: test_results.nuclei?.templates_used || nucleiData.templates_used || metadata.templates_used || 500,
                    findings: nucleiData.findings || []
                }
            };

            // ================================================================
            // CATEGORIZE FINDINGS BY TYPE
            // ================================================================
            const categories = {
                http: ['Missing Security Header', 'Insecure Cookie', 'Cookie Accessible to JavaScript', 'Open Redirect'],
                auth: ['Default Credentials', 'Admin Panel Accessible'],
                injection: ['XXE Vulnerability Possible', 'SSRF Vulnerability Possible', 'File Upload Endpoint', 'Directory Traversal Possible'],
                data: ['Sensitive File Exposed', 'Technology Disclosure'],
                network: ['Database Auth Required (Vulnerable)', 'SSH Password Auth Enabled'],
                api: ['API', 'GraphQL', 'Swagger', 'REST', 'JWT', 'OAuth'],
                logic: ['Rate', 'IDOR', 'Bypass', 'Logic', 'Session', 'Privilege']
            };

            // Populate findings arrays
            results.http_security.findings = findings.filter(f => f && f.type && categories.http.includes(f.type));
            results.authentication.findings = findings.filter(f => f && f.type && categories.auth.includes(f.type));
            results.injection.findings = findings.filter(f => f && f.type && categories.injection.includes(f.type));
            results.data_exposure.findings = findings.filter(f => f && f.type && categories.data.includes(f.type));
            results.network.findings = findings.filter(f => f && f.type && categories.network.includes(f.type));
            results.api_security.findings = findings.filter(f => f && f.type && categories.api.some(keyword => f.type.includes(keyword)));
            results.business_logic.findings = findings.filter(f => f && f.type && categories.logic.some(keyword => f.type.includes(keyword)));

            // ================================================================
            // UPDATE CARD COUNTS USING RESULTS OBJECT
            // ================================================================

            // HTTP Security card
            document.getElementById('http-tests-count').textContent = results.http_security.tests_run;
            document.getElementById('http-findings-count').textContent = results.http_security.findings.length;
            updateStatColor('http-findings-count', results.http_security.findings.length);

            // Authentication card
            document.getElementById('auth-tests-count').textContent = results.authentication.panels_tested;
            document.getElementById('auth-findings-count').textContent = results.authentication.findings.length;
            updateStatColor('auth-findings-count', results.authentication.findings.length);

            // Injection card
            document.getElementById('injection-tests-count').textContent = results.injection.tests_run;
            document.getElementById('injection-findings-count').textContent = results.injection.findings.length;
            updateStatColor('injection-findings-count', results.injection.findings.length);

            // Data Exposure card
            document.getElementById('data-tests-count').textContent = results.data_exposure.files_checked;
            document.getElementById('data-findings-count').textContent = results.data_exposure.findings.length;
            updateStatColor('data-findings-count', results.data_exposure.findings.length);

            // Network card
            document.getElementById('network-tests-count').textContent = results.network.services_tested;
            document.getElementById('network-findings-count').textContent = results.network.findings.length;
            updateStatColor('network-findings-count', results.network.findings.length);

            // API Security card
            document.getElementById('api-tests-count').textContent = results.api_security.tests_run;
            document.getElementById('api-findings-count').textContent = results.api_security.findings.length;
            updateStatColor('api-findings-count', results.api_security.findings.length);

            // Business Logic card
            document.getElementById('logic-tests-count').textContent = results.business_logic.tests_run;
            document.getElementById('logic-findings-count').textContent = results.business_logic.findings.length;
            updateStatColor('logic-findings-count', results.business_logic.findings.length);

            // Advanced Scans (Nuclei) card
            document.getElementById('nuclei-tests-count').textContent = results.nuclei.templates_used;
            document.getElementById('nuclei-findings-count').textContent = results.nuclei.findings.length;
            updateStatColor('nuclei-findings-count', results.nuclei.findings.length);

            // ================================================================
            // DEBUG LOGGING
            // ================================================================
            console.log('[LIGHTBOX] Test Results from backend:', test_results);
            console.log('[LIGHTBOX] Mapped results object:', results);
            console.log('[LIGHTBOX] Card counts:');
            console.log('  HTTP Security:', results.http_security.tests_run, 'tests,', results.http_security.findings.length, 'findings');
            console.log('  Authentication:', results.authentication.panels_tested, 'panels,', results.authentication.findings.length, 'findings');
            console.log('  Injection:', results.injection.tests_run, 'tests,', results.injection.findings.length, 'findings');
            console.log('  Data Exposure:', results.data_exposure.files_checked, 'files,', results.data_exposure.findings.length, 'findings');
            console.log('  Network:', results.network.services_tested, 'services,', results.network.findings.length, 'findings');
            console.log('  API Security:', results.api_security.tests_run, 'tests,', results.api_security.findings.length, 'findings');
            console.log('  Business Logic:', results.business_logic.tests_run, 'tests,', results.business_logic.findings.length, 'findings');
            console.log('  Nuclei:', results.nuclei.templates_used, 'templates,', results.nuclei.findings.length, 'findings');

            // Store findings globally for toggle/click functions
            window.nucleiFindings = results.nuclei.findings;
            window.apiFindings = results.api_security.findings;
            window.logicFindings = results.business_logic.findings;

            // Make finding numbers clickable
            attachCardClickHandlers(findings);
        }

        // Update stat value color based on finding count
        function updateStatColor(elementId, count) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (count === 0) {
                element.style.color = '#4ade80'; // Green - good
            } else if (count <= 5) {
                element.style.color = '#fbbf24'; // Yellow - medium
            } else if (count <= 10) {
                element.style.color = '#fd7e14'; // Orange - high
            } else {
                element.style.color = '#dc3545'; // Red - critical
            }
        }

        // Get severity color for Nuclei findings
        function getNucleiSeverityColor(severity) {
            switch(severity?.toUpperCase()) {
                case 'CRITICAL': return '#8b0000';
                case 'HIGH': return '#dc3545';
                case 'MEDIUM': return '#ffd700';
                case 'LOW': return '#4caf50';
                default: return '#888';
            }
        }

        // Toggle Nuclei findings display
        function toggleNucleiFindings() {
            const findings = window.nucleiFindings || [];
            if (findings.length === 0) {
                showNotification('No Nuclei findings to display', 'info');
                return;
            }
            showCategoryFindings('Advanced Scan Findings (Nuclei)', findings);
        }

        // Attach click handlers to finding numbers
        function attachCardClickHandlers(findings) {
            console.log('[CARDS] ===== ATTACHING CLICK HANDLERS =====');
            console.log('[CARDS] Total findings received:', findings.length);
            console.log('[CARDS] Findings data:', findings);

            // Categorize findings
            const categories = {
                http: ['Missing Security Header', 'Insecure Cookie', 'Cookie Accessible to JavaScript', 'Open Redirect'],
                auth: ['Default Credentials', 'Admin Panel Accessible'],
                injection: ['XXE Vulnerability Possible', 'SSRF Vulnerability Possible', 'File Upload Endpoint', 'Directory Traversal Possible'],
                data: ['Sensitive File Exposed', 'Technology Disclosure'],
                network: ['Database Auth Required (Vulnerable)', 'SSH Password Auth Enabled']
            };

            const categorizedFindings = {
                http: findings.filter(f => f && f.type && categories.http.includes(f.type)),
                auth: findings.filter(f => f && f.type && categories.auth.includes(f.type)),
                injection: findings.filter(f => f && f.type && categories.injection.includes(f.type)),
                data: findings.filter(f => f && f.type && categories.data.includes(f.type)),
                network: findings.filter(f => f && f.type && categories.network.includes(f.type)),
                api: window.apiFindings || [],      // Use globally stored API findings
                logic: window.logicFindings || [],  // Use globally stored Business Logic findings
                nuclei: window.nucleiFindings || [] // Use globally stored nuclei findings
            };

            console.log('[CARDS] Categorized findings:', categorizedFindings);

            // Get all clickable finding elements
            const clickables = document.querySelectorAll('.findings-clickable');

            console.log(`[CARDS] Found ${clickables.length} clickable elements`);

            if (clickables.length === 0) {
                console.error('[CARDS] ERROR: No .findings-clickable elements found in DOM!');
                return;
            }

            clickables.forEach((element, index) => {
                const category = element.getAttribute('data-category');
                const categoryFindings = categorizedFindings[category] || [];

                console.log(`[CARDS] Setting up handler ${index + 1} for category: ${category} (${categoryFindings.length} findings)`);

                // Remove old handler by cloning
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);

                // Add new click handler
                newElement.addEventListener('click', function(e) {
                    e.preventDefault();        // CRITICAL: Prevent default action
                    e.stopPropagation();       // CRITICAL: Stop event bubbling

                    console.log(`[CARDS] ===== CLICK EVENT =====`);
                    console.log(`[CARDS] Category: ${category}`);
                    console.log(`[CARDS] Findings count: ${categoryFindings.length}`);
                    console.log(`[CARDS] Findings:`, categoryFindings);

                    if (categoryFindings.length === 0) {
                        console.log('[CARDS] No findings to display');
                        showNotification(`No ${category} findings`, 'info');
                        return;
                    }

                    const titles = {
                        http: 'HTTP Security Findings',
                        auth: 'Authentication Findings',
                        injection: 'Injection Attack Findings',
                        data: 'Data Exposure Findings',
                        network: 'Network Service Findings',
                        api: 'API Security Findings',
                        logic: 'Business Logic Findings',
                        nuclei: 'Advanced Scan Findings'
                    };

                    console.log(`[CARDS] Calling showCategoryFindings with title: ${titles[category]}`);
                    showCategoryFindings(titles[category], categoryFindings);
                });

                console.log(`[CARDS] Handler attached for ${category}`);
            });

            console.log('[CARDS] Click handlers attached');
        }

        // Show findings for a specific category
        function showCategoryFindings(title, findings) {
            console.log(`[FINDINGS] ===== SHOW CATEGORY FINDINGS =====`);
            console.log(`[FINDINGS] Title: ${title}`);
            console.log(`[FINDINGS] Findings count: ${findings.length}`);
            console.log(`[FINDINGS] Findings:`, findings);

            // Get elements
            const dashboard = document.getElementById('lightbox-dashboard');
            const resultsView = document.getElementById('lightbox-results-view');
            const findingsContainer = document.getElementById('lightbox-findings-display');

            console.log(`[FINDINGS] Dashboard element:`, dashboard);
            console.log(`[FINDINGS] Results view element:`, resultsView);
            console.log(`[FINDINGS] Findings container element:`, findingsContainer);

            if (!dashboard || !resultsView || !findingsContainer) {
                console.error('[FINDINGS] ERROR: Required DOM elements not found!');
                console.error('[FINDINGS] Dashboard:', dashboard);
                console.error('[FINDINGS] ResultsView:', resultsView);
                console.error('[FINDINGS] FindingsContainer:', findingsContainer);
                alert('Error: Cannot display findings. Required elements missing.');
                return;
            }

            console.log('[FINDINGS] All elements found');

            // FORCE display using style.display directly (bypasses inline styles)
            dashboard.style.display = 'none';
            resultsView.style.display = 'block';
            findingsContainer.style.display = 'block';

            console.log('[FINDINGS] Switched views');
            console.log('[FINDINGS] Dashboard display:', dashboard.style.display);
            console.log('[FINDINGS] Results view display:', resultsView.style.display);
            console.log('[FINDINGS] Findings display:', findingsContainer.style.display);

            // Build findings HTML
            const findingsHTML = `
                <h2 style="margin: 0 0 24px 0; color: #ffd700; font-size: 24px;">${title}</h2>
                <p style="margin: 0 0 24px 0; color: #aaa; font-size: 14px;">Showing ${findings.length} finding(s)</p>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    ${findings.map((finding, idx) => {
                        console.log(`[FINDINGS] Rendering finding ${idx + 1}:`, finding);
                        return `
                        <div style="padding: 20px; background: rgba(255,255,255,0.02); border-left: 4px solid ${getSeverityColor(finding.severity)}; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <h3 style="margin: 0; color: #fff; font-size: 18px;">${finding.type || 'Unknown Finding'}</h3>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    ${finding.finding_type ? `
                                        <span style="background: ${getFindingTypeBadgeColor(finding.finding_type).bg}; color: ${getFindingTypeBadgeColor(finding.finding_type).text}; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                            ${getFindingTypeBadgeLabel(finding.finding_type)}
                                        </span>
                                    ` : ''}
                                    <span style="background: ${getSeverityColor(finding.severity)}; color: ${finding.severity === 'MEDIUM' ? '#000' : '#fff'}; padding: 6px 14px; border-radius: 6px; font-size: 12px; font-weight: 700;">
                                        ${finding.severity || 'UNKNOWN'}
                                    </span>
                                </div>
                            </div>

                            ${finding.asset ? `<p style="margin: 0 0 8px 0; color: #aaa; font-size: 14px;"><strong>Asset:</strong> ${finding.asset}</p>` : ''}
                            ${finding.url ? `<p style="margin: 0 0 8px 0; color: #4ade80; font-size: 14px;"><strong>URL:</strong> <a href="${finding.url}" target="_blank" style="color: #4ade80;">${finding.url}</a></p>` : ''}

                            ${finding.explanation ? `
                                <div style="margin: 12px 0; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                    <p style="margin: 0; color: #ccc; font-size: 14px; line-height: 1.6;">${finding.explanation}</p>
                                </div>
                            ` : ''}

                            ${(finding.cves && finding.cves.length > 0) || finding.cve ? `
                                <div style="margin: 12px 0; padding: 12px; background: rgba(255,0,0,0.1); border-left: 3px solid #dc3545; border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong style="color: #dc3545; font-size: 14px;"> Related Vulnerabilities:</strong>
                                        ${finding.cvss ? `<span style="color: #ffd700; font-size: 13px; font-weight: 600;">CVSS: ${finding.cvss}</span>` : ''}
                                    </div>
                                    <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                                        ${finding.cves && finding.cves.length > 0 ? finding.cves.map(cve => `
                                            ${cve.toUpperCase().startsWith('CVE-') ? `
                                                <!-- It's a real CVE - link to NIST -->
                                                <a href="https://nvd.nist.gov/vuln/detail/${cve}"
                                                   target="_blank"
                                                   class="cve-badge"
                                                   style="background: rgba(220,53,69,0.2); border: 1px solid #dc3545; color: #dc3545; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 700; display: inline-block;">
                                                    ${cve} 
                                                </a>
                                            ` : cve.toUpperCase().startsWith('CWE-') ? `
                                                <!-- It's a CWE - link to MITRE CWE -->
                                                <a href="https://cwe.mitre.org/data/definitions/${cve.replace(/CWE-/i, '')}.html"
                                                   target="_blank"
                                                   class="cwe-badge"
                                                   style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 700; display: inline-block;">
                                                    ${cve} 
                                                </a>
                                                <span style="color: #666; font-size: 11px; margin-left: 4px; margin-right: 8px;">(Weakness)</span>
                                            ` : `
                                                <!-- Unknown format - just show as text -->
                                                <span style="background: rgba(128,128,128,0.2); border: 1px solid #888; color: #888; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; display: inline-block;">
                                                    ${cve}
                                                </span>
                                            `}
                                        `).join('') : finding.cve ? `
                                            ${finding.cve.toUpperCase().startsWith('CVE-') ? `
                                                <!-- It's a real CVE - link to NIST -->
                                                <a href="https://nvd.nist.gov/vuln/detail/${finding.cve}"
                                                   target="_blank"
                                                   class="cve-badge"
                                                   style="background: rgba(220,53,69,0.2); border: 1px solid #dc3545; color: #dc3545; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 700; display: inline-block;">
                                                    ${finding.cve} 
                                                </a>
                                            ` : finding.cve.toUpperCase().startsWith('CWE-') ? `
                                                <!-- It's a CWE - link to MITRE CWE -->
                                                <a href="https://cwe.mitre.org/data/definitions/${finding.cve.replace(/CWE-/i, '')}.html"
                                                   target="_blank"
                                                   class="cwe-badge"
                                                   style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 700; display: inline-block;">
                                                    ${finding.cve} 
                                                </a>
                                                <span style="color: #666; font-size: 11px; margin-left: 8px;">(Weakness Category)</span>
                                            ` : `
                                                <!-- Unknown format - just show as text -->
                                                <span style="background: rgba(128,128,128,0.2); border: 1px solid #888; color: #888; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; display: inline-block;">
                                                    ${finding.cve}
                                                </span>
                                            `}
                                        ` : ''}
                                        <span style="color: #888; font-size: 11px; margin-left: 8px;">
                                            ${(finding.cve && finding.cve.startsWith('CVE-')) || (finding.cves && finding.cves.some(c => c.startsWith('CVE-'))) ? 'Specific vulnerability' :
                                              (finding.cve && finding.cve.startsWith('CWE-')) || (finding.cves && finding.cves.some(c => c.startsWith('CWE-'))) ? 'Weakness category' : 'Reference'}
                                        </span>
                                    </div>
                                </div>
                            ` : ''}

                            ${finding.template ? `
                                <div style="margin: 12px 0; display: grid; grid-template-columns: auto 1fr; gap: 8px; font-size: 12px;">
                                    <span style="color: #888;">Template:</span>
                                    <span style="color: #888; font-family: monospace;">${finding.template}</span>
                                    ${finding.matcher_name ? `
                                        <span style="color: #888;">Matcher:</span>
                                        <span style="color: #ccc; font-family: monospace;">${finding.matcher_name}</span>
                                    ` : ''}
                                </div>
                            ` : ''}

                            ${finding.remediation ? `
                                <details style="margin-top: 12px;">
                                    <summary style="cursor: pointer; color: #ffd700; font-weight: 600; font-size: 14px;"> How to Fix</summary>
                                    <div style="margin-top: 12px; padding: 12px; background: rgba(255,215,0,0.05); border-radius: 6px;">
                                        ${typeof finding.remediation === 'string' ? `
                                            <p style="margin: 0; color: #ccc; font-size: 13px; line-height: 1.6;">${finding.remediation}</p>
                                        ` : finding.remediation.fix_steps ? `
                                            <p style="margin: 0 0 8px 0; color: #ccc; font-size: 13px;"><strong>Steps:</strong></p>
                                            <ul style="margin: 0; padding-left: 20px; color: #ccc; font-size: 13px;">
                                                ${finding.remediation.fix_steps.map(step => `<li>${step}</li>`).join('')}
                                            </ul>
                                        ` : ''}
                                        ${typeof finding.remediation === 'object' && finding.remediation.nginx_config ? `
                                            <p style="margin: 12px 0 4px 0; color: #4ade80; font-size: 13px;"><strong>Nginx:</strong></p>
                                            <pre style="background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; overflow-x: auto; color: #4ade80; font-size: 12px;">${finding.remediation.nginx_config}</pre>
                                        ` : ''}
                                        ${typeof finding.remediation === 'object' && finding.remediation.apache_config ? `
                                            <p style="margin: 12px 0 4px 0; color: #fd7e14; font-size: 13px;"><strong>Apache:</strong></p>
                                            <pre style="background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; overflow-x: auto; color: #fd7e14; font-size: 12px;">${finding.remediation.apache_config}</pre>
                                        ` : ''}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                        `;
                    }).join('')}
                </div>
            `;

            console.log('[FINDINGS] Setting innerHTML...');
            findingsContainer.innerHTML = findingsHTML;
            console.log('[FINDINGS] Display updated successfully');
        }

        // Get severity badge color
        function getSeverityColor(severity) {
            const colors = {
                'CRITICAL': '#dc3545',  // Red
                'HIGH': '#fd7e14',       // Orange
                'MEDIUM': '#ffc107',     // Yellow
                'LOW': '#28a745',        // Green
                'INFO': '#17a2b8'        // Blue
            };
            return colors[severity] || '#6c757d';  // Gray for unknown
        }

        // Get finding type badge color
        function getFindingTypeBadgeColor(findingType) {
            const badges = {
                'cve-based': { bg: '#dc3545', text: '#fff' },      // Red
                'config-issue': { bg: '#ffc107', text: '#000' },   // Yellow
                'active-test': { bg: '#fd7e14', text: '#fff' }     // Orange
            };
            return badges[findingType] || { bg: '#6c757d', text: '#fff' };  // Gray default
        }

        // Get finding type badge label
        function getFindingTypeBadgeLabel(findingType) {
            const labels = {
                'cve-based': 'CVE',
                'config-issue': 'Config',
                'active-test': 'Active Test'
            };
            return labels[findingType] || 'Unknown';
        }

        // Show notification helper
        function showNotification(message, type = 'info') {
            // Simple notification - can be enhanced later
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.padding = '16px 24px';
            notification.style.background = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffd700';
            notification.style.color = type === 'success' || type === 'error' ? '#fff' : '#000';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
            notification.style.zIndex = '10000';
            notification.style.fontWeight = '600';
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Clear Lightbox state when domain changes
        function clearLightboxState() {
            console.log('[LIGHTBOX] Clearing all Lightbox results and state');

            // Clear all test category containers
            const testCategories = [
                'http-security-findings',
                'auth-findings',
                'injection-findings',
                'data-exposure-findings',
                'network-findings',
                'advanced-findings'
            ];

            testCategories.forEach(categoryId => {
                const container = document.getElementById(categoryId);
                if (container) {
                    container.innerHTML = '<p style="color: #888; padding: 20px; text-align: center;">No scan run yet for this domain</p>';
                }
            });

            // Reset all test counts to "--"
            const statIds = [
                'http-tests-count', 'http-findings-count',
                'auth-tests-count', 'auth-findings-count',
                'injection-tests-count', 'injection-findings-count',
                'data-tests-count', 'data-findings-count',
                'network-tests-count', 'network-findings-count',
                'api-tests-count', 'api-findings-count',
                'logic-tests-count', 'logic-findings-count',
                'nuclei-tests-count', 'nuclei-findings-count'
            ];

            statIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '--';
                    element.style.color = '#555';
                }
            });

            // Clear "Recent Scans" section - just reload
            loadLightboxHistory();

            // Hide Lightbox findings display
            const findingsDisplay = document.getElementById('lightbox-findings-display');
            if (findingsDisplay) {
                findingsDisplay.classList.remove('show');
                findingsDisplay.innerHTML = '';
            }

            console.log('[LIGHTBOX] State cleared successfully');
        }

        // Initialize card stats to show "--" on page load
        function initializeTestCards() {
            const statIds = [
                'http-tests-count', 'http-findings-count',
                'auth-tests-count', 'auth-findings-count',
                'injection-tests-count', 'injection-findings-count',
                'data-tests-count', 'data-findings-count',
                'network-tests-count', 'network-findings-count',
                'nuclei-tests-count', 'nuclei-findings-count'
            ];

            statIds.forEach(id => {
                const element = document.getElementById(id);
                if (element && element.textContent === '--') {
                    element.style.color = '#555'; // Gray for uninitialized
                }
            });
        }

        // ==========================================
        // XASM SCAN HISTORY FUNCTIONS
        // ==========================================

        function toggleXASMHistory() {
            const dropdown = document.getElementById('xasm-history-dropdown');

            if (dropdown.style.display === 'none') {
                loadXASMHistory();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        async function loadXASMHistory() {
            const container = document.getElementById('xasm-history-list');

            try {
                const response = await fetch('http://localhost:5000/api/xasm/history');
                const data = await response.json();

                if (!data.success || !data.history || data.history.length === 0) {
                    container.innerHTML = `
                        <p style="color: #888; text-align: center; padding: 20px;">
                            No scan history yet
                        </p>
                    `;
                    return;
                }

                // Show last 10 scans
                const recentScans = data.history.slice(0, 10);

                let html = '';
                recentScans.forEach(scan => {
                    const date = new Date(scan.timestamp);
                    const summary = scan.summary || {};

                    html += `
                        <div style="
                            background: rgba(255,255,255,0.05);
                            padding: 12px;
                            border-radius: 6px;
                            margin-bottom: 8px;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onclick="viewXASMScanFromHistory('${scan.scan_id}')"
                           onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                           onmouseout="this.style.background='rgba(255,255,255,0.05)'">

                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                <div>
                                    <div style="color: #ffd700; font-weight: 600; font-size: 15px;">${scan.target}</div>
                                    <div style="color: #888; font-size: 12px;">${date.toLocaleDateString()} at ${date.toLocaleTimeString()}</div>
                                </div>
                                <button onclick="event.stopPropagation(); deleteXASMScan('${scan.scan_id}')" style="
                                    background: rgba(220,53,69,0.2);
                                    border: 1px solid #dc3545;
                                    color: #dc3545;
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 11px;
                                    transition: background 0.2s;
                                " onmouseover="this.style.background='rgba(220,53,69,0.4)'"
                                   onmouseout="this.style.background='rgba(220,53,69,0.2)'">Delete</button>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 13px;">
                                <div>
                                    <span style="color: #666;">Subdomains:</span>
                                    <span style="color: #ffd700; font-weight: 600; margin-left: 4px;">${summary.total_subdomains || 0}</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Services:</span>
                                    <span style="color: #ffd700; font-weight: 600; margin-left: 4px;">${summary.total_services || 0}</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Vulns:</span>
                                    <span style="color: ${(summary.critical_vulns || 0) > 0 ? '#dc3545' : '#ffd700'}; font-weight: 600; margin-left: 4px;">
                                        ${summary.total_vulnerabilities || 0}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('[XASM] Error loading history:', error);
                container.innerHTML = `<p style="color: #dc3545; text-align: center;">Failed to load history</p>`;
            }
        }

        async function viewXASMScanFromHistory(scanId) {
            toggleXASMHistory(); // Close dropdown

            try {
                const response = await fetch(`http://localhost:5000/api/xasm/history/${scanId}`);
                const data = await response.json();

                if (data.success && data.results) {
                    // Set the domain in the input field
                    const target = data.results.target || data.target;
                    if (target) {
                        document.getElementById('domainInput').value = target;
                        window.currentDomain = target;
                        window.currentScanDomain = target;
                    }

                    // Display the results - results is now nested
                    const scanResults = data.results.results || data.results;
                    displayResults(scanResults);

                    // Show results container
                    const resultsContainer = document.querySelector('.results-container');
                    if (resultsContainer) {
                        resultsContainer.style.display = 'block';
                    }

                    // Scroll to results
                    const resultsEl = document.getElementById('results');
                    if (resultsEl) {
                        resultsEl.scrollIntoView({ behavior: 'smooth' });
                    }
                } else {
                    alert('Failed to load scan details');
                }
            } catch (error) {
                console.error('[XASM] Error loading scan:', error);
                alert('Error loading scan details');
            }
        }

        async function deleteXASMScan(scanId) {
            if (!confirm('Delete this scan from history?')) return;

            try {
                const response = await fetch(`http://localhost:5000/api/xasm/history/${scanId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Scan deleted', 'success');
                    loadXASMHistory(); // Reload
                } else {
                    alert('Failed to delete scan');
                }
            } catch (error) {
                console.error('[XASM] Error:', error);
                alert('Error deleting scan');
            }
        }

        // Make risk categories expandable
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[INIT] Page loaded, checking for saved state...');

            // Restore saved state from localStorage
            const savedDomain = localStorage.getItem('nerve_current_domain');
            const savedScanId = localStorage.getItem('nerve_current_scan_id');
            const savedTab = localStorage.getItem('nerve_last_tab');

            if (savedDomain && savedScanId) {
                console.log(`[INIT] Restoring state: ${savedDomain}, scan ${savedScanId}`);

                window.currentDomain = savedDomain;
                window.currentASMScanId = parseInt(savedScanId);

                // Restore domain in input field
                const domainInput = document.getElementById('domain-input');
                if (domainInput) {
                    domainInput.value = savedDomain;
                }

                // Trigger XASM scan to reload data
                console.log('[INIT] Re-running XASM scan to restore data...');
                await runASMScan(savedDomain, false); // false = don't force rescan

                // Switch to saved tab
                if (savedTab) {
                    const tabButton = document.querySelector(`[data-tab="${savedTab}"]`);
                    if (tabButton) {
                        tabButton.click();
                    }
                }
            } else {
                console.log('[INIT] No saved state found');
            }

            // Initialize test cards on page load
            initializeTestCards();

            // Load Lightbox scan history on page load
            loadLightboxHistory();

            // Clear state when going back to main dashboard
            const backButton = document.querySelector('.back-button');
            if (backButton) {
                backButton.addEventListener('click', () => {
                    console.log('[INIT] Clearing saved state on back to dashboard');
                    localStorage.removeItem('nerve_current_domain');
                    localStorage.removeItem('nerve_current_scan_id');
                    localStorage.removeItem('nerve_last_tab');
                });
            }

            document.querySelectorAll('.risk-category-header').forEach(header => {
                header.addEventListener('click', function() {
                    const list = this.nextElementSibling;
                    const btn = this.querySelector('.expand-btn');

                    if (list.style.display === 'none') {
                        list.style.display = 'block';
                        btn.classList.add('expanded');
                    } else {
                        list.style.display = 'none';
                        btn.classList.remove('expanded');
                    }
                });
            });
        });

        // ========================================
        // VULNERABILITY REPORT TAB FUNCTIONS
        // ========================================

        let vulnCompanies = [];
        let currentVulnCompany = null;

        async function loadVulnCompanies() {
            console.log('[AI-VULN] Loading companies...');

            // Reset states
            document.getElementById('vuln-state-no-scans').style.display = 'none';
            document.getElementById('vuln-state-select').style.display = 'none';
            document.getElementById('vuln-state-generating').style.display = 'none';
            document.getElementById('vuln-state-report').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/api/ai/companies`);
                const data = await response.json();

                console.log('[AI-VULN] Companies response:', data);

                if (!data.success || !data.companies || data.companies.length === 0) {
                    document.getElementById('vuln-state-no-scans').style.display = 'block';
                    return;
                }

                vulnCompanies = data.companies;
                document.getElementById('vuln-state-select').style.display = 'block';
                displayVulnCompanies(vulnCompanies);

            } catch (error) {
                console.error('[AI-VULN] Error loading companies:', error);
                document.getElementById('vuln-state-no-scans').style.display = 'block';
            }
        }

        function displayVulnCompanies(companies) {
            const container = document.getElementById('vuln-companies-list');

            let html = '';

            companies.forEach(company => {
                const hasXasm = company.has_xasm;
                const hasLightbox = company.has_lightbox;
                const canGenerate = hasXasm && hasLightbox;

                html += `
                    <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 24px; margin-bottom: 16px; cursor: ${canGenerate ? 'pointer' : 'default'}; transition: border-color 0.2s;"
                         onmouseover="if(${canGenerate}) this.style.borderColor='rgba(255,215,0,0.5)'"
                         onmouseout="this.style.borderColor='rgba(255,215,0,0.2)'"
                         onclick="${canGenerate ? `generateVulnReport('${company.company.replace(/'/g, "\\'")}')` : ''}">

                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 16px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="color: #ffd700; font-size: 20px; font-weight: 700; margin-bottom: 12px;">${company.company}</div>

                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                    <div style="color: ${hasXasm ? '#4caf50' : '#dc3545'}; font-size: 13px;">
                                        ${hasXasm ? '' : ''} XASM Scan
                                    </div>
                                    <div style="color: ${hasLightbox ? '#4caf50' : '#dc3545'}; font-size: 13px;">
                                        ${hasLightbox ? '' : ''} Lightbox Scan
                                    </div>
                                </div>
                            </div>

                            <button
                                style="background: ${canGenerate ? 'linear-gradient(135deg, #ffd700 0%, #ff8c00 100%)' : 'rgba(128,128,128,0.3)'}; border: none; color: ${canGenerate ? '#000' : '#666'}; padding: 12px 32px; border-radius: 8px; cursor: ${canGenerate ? 'pointer' : 'not-allowed'}; font-weight: 700;"
                                ${!canGenerate ? 'disabled' : ''}
                                onclick="event.stopPropagation(); generateVulnReport('${company.company.replace(/'/g, "\\'")}')"
                            >
                                ${canGenerate ? 'Generate Report' : 'Missing Scans'}
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function filterVulnCompanies() {
            const search = document.getElementById('vuln-company-search').value.toLowerCase();
            const filtered = vulnCompanies.filter(c => c.company.toLowerCase().includes(search));
            displayVulnCompanies(filtered);
        }

        async function generateVulnReport(company) {
            currentVulnCompany = company;

            console.log('[AI-VULN] Generating report for:', company);

            // Hide selection, show generating
            document.getElementById('vuln-state-select').style.display = 'none';
            document.getElementById('vuln-state-generating').style.display = 'block';
            document.getElementById('vuln-generating-company').textContent = company;

            // Reset step indicators
            resetVulnSteps();

            // Animate progress steps
            setTimeout(() => updateVulnStep('vuln-step-3', '', '#4caf50'), 2000);
            setTimeout(() => updateVulnStep('vuln-step-4', '', '#ffd700'), 2500);
            setTimeout(() => updateVulnStep('vuln-step-4', '', '#4caf50'), 4000);
            setTimeout(() => updateVulnStep('vuln-step-5', '', '#ffd700'), 4500);
            setTimeout(() => updateVulnStep('vuln-step-5', '', '#4caf50'), 6000);
            setTimeout(() => updateVulnStep('vuln-step-6', '', '#ffd700'), 6500);

            try {
                const response = await fetch(`${API_URL}/api/ai/generate-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company })
                });

                const data = await response.json();

                if (data.success) {
                    // Wait for animations to complete, then show report
                    setTimeout(() => {
                        updateVulnStep('vuln-step-6', '', '#4caf50');
                        displayVulnReport(data.report);
                    }, 8000);
                } else {
                    console.error('[AI-VULN] API Error:', data.error);
                    alert('Failed to generate report: ' + data.error);
                    // Return to company selection
                    document.getElementById('vuln-state-generating').style.display = 'none';
                    document.getElementById('vuln-state-select').style.display = 'block';
                }

            } catch (error) {
                console.error('[AI-VULN] Error:', error);
                alert('Error generating report. Please try again.');
                // Return to company selection
                document.getElementById('vuln-state-generating').style.display = 'none';
                document.getElementById('vuln-state-select').style.display = 'block';
            }
        }

        function resetVulnSteps() {
            document.getElementById('vuln-step-1').textContent = ' Loading XASM scan results';
            document.getElementById('vuln-step-1').style.color = '#4caf50';
            document.getElementById('vuln-step-2').textContent = ' Loading Lightbox scan results';
            document.getElementById('vuln-step-2').style.color = '#4caf50';
            document.getElementById('vuln-step-3').textContent = ' AI analyzing vulnerabilities...';
            document.getElementById('vuln-step-3').style.color = '#888';
            document.getElementById('vuln-step-4').textContent = ' Prioritizing by business risk...';
            document.getElementById('vuln-step-4').style.color = '#666';
            document.getElementById('vuln-step-5').textContent = ' Generating attack scenarios...';
            document.getElementById('vuln-step-5').style.color = '#666';
            document.getElementById('vuln-step-6').textContent = ' Creating remediation plan...';
            document.getElementById('vuln-step-6').style.color = '#666';
        }

        function updateVulnStep(stepId, icon, color) {
            const step = document.getElementById(stepId);
            if (step) {
                const text = step.textContent.substring(2).trim();
                step.textContent = icon + ' ' + text;
                step.style.color = color;
            }
        }

        // Display the generated vulnerability report
        function displayVulnReport(report) {
            // Hide generating, show report
            document.getElementById('vuln-state-generating').style.display = 'none';
            document.getElementById('vuln-state-report').style.display = 'block';

            const container = document.getElementById('vuln-state-report');

            // Determine risk color
            const riskScore = report.risk_score;
            let riskColor = '#4caf50'; // Low
            if (riskScore >= 70) riskColor = '#dc3545'; // Critical/High
            else if (riskScore >= 40) riskColor = '#ffd700'; // Medium

            const html = `
                <!-- Header -->
                <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 32px; margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
                        <div>
                            <h2 style="color: #ffd700; margin: 0 0 8px 0;">Vulnerability Assessment</h2>
                            <p style="color: #888; margin: 0; font-size: 18px;">${report.company}</p>
                            <p style="color: #666; margin: 8px 0 0 0; font-size: 13px;">Generated: ${new Date(report.generated_at).toLocaleString()}</p>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="exportReportPDF()" style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Export PDF
                            </button>
                            <button onclick="loadVulnCompanies(); document.getElementById('vuln-state-report').style.display='none';" style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Back
                            </button>
                        </div>
                    </div>

                    <!-- Risk Score -->
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 32px; align-items: center;">
                        <div style="position: relative; width: 160px; height: 160px;">
                            <svg width="160" height="160" style="transform: rotate(-90deg);">
                                <circle cx="80" cy="80" r="70" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="12"/>
                                <circle cx="80" cy="80" r="70" fill="none" stroke="${riskColor}" stroke-width="12"
                                    stroke-dasharray="${2 * Math.PI * 70}"
                                    stroke-dashoffset="${2 * Math.PI * 70 * (1 - riskScore / 100)}"
                                    style="transition: stroke-dashoffset 1s;"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 36px; font-weight: 700; color: ${riskColor};">${riskScore}</div>
                                <div style="font-size: 12px; color: #888;">/ 100</div>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: ${riskColor}; margin-bottom: 8px;">${report.risk_level} RISK</div>
                            <div style="color: #888; font-size: 14px;">
                                Total Findings: ${report.scan_data.total_findings} |
                                Critical: ${report.findings_by_category.critical} |
                                High: ${report.findings_by_category.high} |
                                Medium: ${report.findings_by_category.medium} |
                                Low: ${report.findings_by_category.low}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 32px; margin-bottom: 24px;">
                    <h3 style="color: #ffd700; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        Executive Summary
                    </h3>
                    <div style="color: #ccc; line-height: 1.8; white-space: pre-wrap;">${report.executive_summary}</div>
                </div>

                <!-- Top 5 Critical Issues -->
                <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 32px; margin-bottom: 24px;">
                    <h3 style="color: #ffd700; margin: 0 0 24px 0; display: flex; align-items: center; gap: 8px;">
                        Top ${report.top_issues.length} Critical Issues
                    </h3>
                    ${report.top_issues.map((issue, idx) => {
                        const severityColor = issue.severity === 'CRITICAL' ? '#dc3545' :
                                             issue.severity === 'HIGH' ? '#ff8c00' :
                                             issue.severity === 'MEDIUM' ? '#ffd700' : '#4caf50';

                        return `
                            <div style="background: rgba(0,0,0,0.2); border-left: 4px solid ${severityColor}; border-radius: 8px; padding: 24px; margin-bottom: 16px;">
                                <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 8px;">
                                            ${idx + 1}. ${issue.title}
                                        </div>
                                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                                            <span style="background: rgba(${severityColor === '#dc3545' ? '220,53,69' : severityColor === '#ff8c00' ? '255,140,0' : severityColor === '#ffd700' ? '255,215,0' : '76,175,80'},0.2); border: 1px solid ${severityColor}; color: ${severityColor}; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 700;">
                                                ${issue.severity}
                                            </span>
                                            ${issue.cvss ? `<span style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 700;">CVSS: ${issue.cvss}</span>` : ''}
                                            ${issue.cve_cwe ? `<span style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 700;">${issue.cve_cwe}</span>` : ''}
                                            <span style="color: #888; font-size: 12px; padding: 4px 0;">Est. ${issue.effort_hours}h to fix</span>
                                        </div>
                                    </div>
                                </div>

                                <div style="color: #ccc; margin-bottom: 12px; line-height: 1.6;">${issue.description}</div>

                                <div style="background: rgba(255,140,0,0.1); border: 1px solid rgba(255,140,0,0.3); border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                                    <div style="color: #ff8c00; font-weight: 700; font-size: 12px; margin-bottom: 4px;">IMPACT</div>
                                    <div style="color: #ccc; font-size: 14px;">${issue.impact}</div>
                                </div>

                                ${issue.affected_assets && issue.affected_assets.length > 0 ? `
                                    <div style="margin-bottom: 12px;">
                                        <div style="color: #888; font-size: 12px; margin-bottom: 6px;">AFFECTED ASSETS:</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                            ${issue.affected_assets.map(asset => `
                                                <span style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 4px; font-size: 12px; color: #888;">${asset}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}

                                <div style="background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 6px; padding: 12px;">
                                    <div style="color: #4caf50; font-weight: 700; font-size: 12px; margin-bottom: 4px;">REMEDIATION</div>
                                    <div style="color: #ccc; font-size: 14px; white-space: pre-wrap;">${issue.remediation}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <!-- Attack Scenarios -->
                ${report.attack_scenarios && report.attack_scenarios.length > 0 ? `
                    <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 32px; margin-bottom: 24px;">
                        <h3 style="color: #ffd700; margin: 0 0 24px 0; display: flex; align-items: center; gap: 8px;">
                            Attack Scenarios
                        </h3>
                        ${report.attack_scenarios.map((scenario, idx) => {
                            const likelihoodColor = scenario.likelihood === 'HIGH' ? '#dc3545' :
                                                   scenario.likelihood === 'MEDIUM' ? '#ffd700' : '#4caf50';

                            return `
                                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 24px; margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                        <div style="font-size: 18px; font-weight: 700; color: #fff;">
                                            Scenario ${idx + 1}: ${scenario.title}
                                        </div>
                                        <span style="background: rgba(${likelihoodColor === '#dc3545' ? '220,53,69' : likelihoodColor === '#ffd700' ? '255,215,0' : '76,175,80'},0.2); border: 1px solid ${likelihoodColor}; color: ${likelihoodColor}; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 700;">
                                            ${scenario.likelihood} LIKELIHOOD
                                        </span>
                                    </div>

                                    <div style="margin-bottom: 16px;">
                                        ${scenario.steps.map((step, stepIdx) => `
                                            <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                                                <div style="background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0;">
                                                    ${stepIdx + 1}
                                                </div>
                                                <div style="color: #ccc; padding-top: 2px;">${step}</div>
                                            </div>
                                        `).join('')}
                                    </div>

                                    <div style="background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.3); border-radius: 6px; padding: 12px;">
                                        <div style="color: #dc3545; font-weight: 700; font-size: 12px; margin-bottom: 4px;">POTENTIAL IMPACT</div>
                                        <div style="color: #ccc; font-size: 14px;">${scenario.impact}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}

                <!-- Remediation Roadmap -->
                <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.2); border-radius: 12px; padding: 32px;">
                    <h3 style="color: #ffd700; margin: 0 0 24px 0; display: flex; align-items: center; gap: 8px;">
                        Prioritized Remediation Roadmap
                    </h3>

                    ${report.remediation_roadmap.immediate && report.remediation_roadmap.immediate.length > 0 ? `
                        <div style="margin-bottom: 32px;">
                            <h4 style="color: #dc3545; margin: 0 0 16px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                IMMEDIATE (Next 24 Hours)
                            </h4>
                            ${report.remediation_roadmap.immediate.map(task => `
                                <div style="background: rgba(220,53,69,0.1); border-left: 3px solid #dc3545; padding: 16px; margin-bottom: 12px; border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="color: #fff; font-weight: 600; flex: 1;">${task.task}</div>
                                        <div style="color: #4caf50; font-size: 12px; font-weight: 700; white-space: nowrap; margin-left: 16px;">
                                            -${task.risk_reduction}% Risk
                                        </div>
                                    </div>
                                    <div style="color: #888; font-size: 13px;">
                                        Effort: ${task.effort_hours}h | Priority: ${'*'.repeat(task.priority)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${report.remediation_roadmap.this_week && report.remediation_roadmap.this_week.length > 0 ? `
                        <div style="margin-bottom: 32px;">
                            <h4 style="color: #ffd700; margin: 0 0 16px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                THIS WEEK
                            </h4>
                            ${report.remediation_roadmap.this_week.map(task => `
                                <div style="background: rgba(255,215,0,0.1); border-left: 3px solid #ffd700; padding: 16px; margin-bottom: 12px; border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="color: #fff; font-weight: 600; flex: 1;">${task.task}</div>
                                        <div style="color: #4caf50; font-size: 12px; font-weight: 700; white-space: nowrap; margin-left: 16px;">
                                            -${task.risk_reduction}% Risk
                                        </div>
                                    </div>
                                    <div style="color: #888; font-size: 13px;">
                                        Effort: ${task.effort_hours}h | Priority: ${'*'.repeat(task.priority)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${report.remediation_roadmap.this_month && report.remediation_roadmap.this_month.length > 0 ? `
                        <div>
                            <h4 style="color: #4caf50; margin: 0 0 16px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                THIS MONTH
                            </h4>
                            ${report.remediation_roadmap.this_month.map(task => `
                                <div style="background: rgba(76,175,80,0.1); border-left: 3px solid #4caf50; padding: 16px; margin-bottom: 12px; border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="color: #fff; font-weight: 600; flex: 1;">${task.task}</div>
                                        <div style="color: #4caf50; font-size: 12px; font-weight: 700; white-space: nowrap; margin-left: 16px;">
                                            -${task.risk_reduction}% Risk
                                        </div>
                                    </div>
                                    <div style="color: #888; font-size: 13px;">
                                        Effort: ${task.effort_hours}h | Priority: ${'*'.repeat(task.priority)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            container.innerHTML = html;
        }

        function exportReportPDF() {
            alert('PDF export will be added in next version! For now, use browser print (Ctrl+P)');
        }

        // Load companies when vulnerability tab is opened
        function onVulnerabilityTabOpen() {
            console.log('[AI-VULN] Tab opened, loading companies...');
            loadVulnCompanies();
        }

        // ============================================
        // COMPLIANCE MANAGER - JavaScript Module
        // ============================================

        const ComplianceManager = {
            currentFramework: null,
            currentAssessmentId: null,
            currentControlId: null,
            assessmentData: null,
            scanAnalysisData: null,
            selectedDomain: null,
            availableDomains: [],

            // Initialize the compliance tab
            async init() {
                await this.loadFrameworks();
            },

            // Load available frameworks
            async loadFrameworks() {
                const grid = document.getElementById('frameworksGrid');
                if (!grid) return;

                try {
                    const response = await fetch('http://localhost:5000/api/compliance/frameworks');
                    const data = await response.json();

                    if (!data.success) throw new Error(data.error);

                    // Check for existing assessments for each framework
                    const frameworksWithProgress = await Promise.all(
                        data.frameworks.map(async (fw) => {
                            try {
                                const assessmentRes = await fetch(`http://localhost:5000/api/compliance/assessment/by-framework/${fw.id}`);
                                const assessmentData = await assessmentRes.json();
                                return { ...fw, existingAssessment: assessmentData.assessment };
                            } catch {
                                return { ...fw, existingAssessment: null };
                            }
                        })
                    );

                    grid.innerHTML = frameworksWithProgress.map(fw => this.renderFrameworkCard(fw)).join('');

                } catch (error) {
                    console.error('Error loading frameworks:', error);
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ef4444; grid-column: 1 / -1;">
                            <p>Failed to load frameworks. Please try again.</p>
                            <button onclick="ComplianceManager.loadFrameworks()" style="margin-top: 16px; padding: 10px 20px; background: #D4AF37; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Retry
                            </button>
                        </div>
                    `;
                }
            },

            // Render a framework card
            renderFrameworkCard(fw) {
                const hasAssessment = fw.existingAssessment !== null;
                const progress = hasAssessment ? fw.existingAssessment.completion_percentage : 0;

                return `
                    <div class="framework-card" onclick="ComplianceManager.selectFramework('${fw.id}')">
                        <div class="framework-card-header">
                            <div class="framework-icon">${fw.icon}</div>
                            <span class="framework-badge">${fw.version}</span>
                        </div>
                        <div class="framework-card-body">
                            <h3 class="framework-name">${fw.name}</h3>
                            <div class="framework-version">${fw.full_name}</div>
                            <p class="framework-description">${fw.description}</p>
                            <div class="framework-stats">
                                <div class="framework-stat">
                                    <span class="framework-stat-value">${fw.control_count}</span>
                                    <span class="framework-stat-label">Controls</span>
                                </div>
                                ${hasAssessment ? `
                                <div class="framework-stat">
                                    <span class="framework-stat-value">${fw.existingAssessment.statistics.compliant}</span>
                                    <span class="framework-stat-label">Compliant</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="framework-card-footer">
                            ${hasAssessment ? `
                            <div class="framework-progress">
                                <div class="framework-progress-header">
                                    <span class="framework-progress-label">Progress</span>
                                    <span class="framework-progress-value">${progress}%</span>
                                </div>
                                <div class="framework-progress-bar">
                                    <div class="framework-progress-fill" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <button class="btn-framework btn-framework-secondary">
                                Continue Assessment
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </button>
                            ` : `
                            <button class="btn-framework btn-framework-primary">
                                Start Assessment
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </button>
                            `}
                        </div>
                    </div>
                `;
            },

            // Select a framework and start/continue assessment
            async selectFramework(frameworkId) {
                this.currentFramework = frameworkId;

                try {
                    // Create or get existing assessment
                    const createRes = await fetch('http://localhost:5000/api/compliance/assessment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ framework_id: frameworkId })
                    });
                    const createData = await createRes.json();

                    if (!createData.success) throw new Error(createData.error);

                    this.currentAssessmentId = createData.assessment_id;

                    // Load assessment details
                    await this.loadAssessment(this.currentAssessmentId);

                    // Switch views
                    document.getElementById('frameworksView').style.display = 'none';
                    document.getElementById('assessmentView').classList.add('active');

                } catch (error) {
                    console.error('Error selecting framework:', error);
                    alert('Failed to load assessment. Please try again.');
                }
            },

            // Load assessment data
            async loadAssessment(assessmentId) {
                try {
                    const response = await fetch(`http://localhost:5000/api/compliance/assessment/${assessmentId}`);
                    const data = await response.json();

                    if (!data.success) throw new Error(data.error);

                    this.assessmentData = data;
                    this.renderAssessment(data);

                } catch (error) {
                    console.error('Error loading assessment:', error);
                }
            },

            // Render assessment dashboard
            renderAssessment(data) {
                const frameworkNames = {
                    'soc2': 'SOC 2 Type II',
                    'iso27001': 'ISO 27001:2022',
                    'gdpr': 'GDPR',
                    'nis2': 'NIS2 Directive'
                };

                // Update header
                document.getElementById('assessmentTitle').textContent = `${frameworkNames[data.assessment.framework] || data.assessment.framework} Assessment`;
                document.getElementById('assessmentSubtitle').textContent = `Started on ${new Date(data.assessment.assessment_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;

                // Update progress circle
                const progress = data.completion_percentage;
                const circle = document.getElementById('progressCircle');
                const circumference = 2 * Math.PI * 80;
                const offset = circumference - (progress / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                document.getElementById('progressValue').textContent = `${Math.round(progress)}%`;

                // Update stats
                document.getElementById('statCompliant').textContent = data.statistics.compliant;
                document.getElementById('statPartial').textContent = data.statistics.partial;
                document.getElementById('statNonCompliant').textContent = data.statistics.non_compliant;
                document.getElementById('statNotTested').textContent = data.statistics.not_tested;

                // Render categories
                this.renderCategories(data.categories);

                // Load scan summary
                this.loadScanSummary();
            },

            // Render control categories
            renderCategories(categories) {
                const container = document.getElementById('categoriesContainer');

                const categoryHtml = Object.entries(categories).map(([catName, controls], index) => {
                    const compliantCount = controls.filter(c => c.status === 'compliant').length;
                    const progress = Math.round((compliantCount / controls.length) * 100) || 0;

                    return `
                        <div class="category-group ${index === 0 ? 'expanded' : ''}" data-category="${catName}">
                            <div class="category-header" onclick="ComplianceManager.toggleCategory(this)">
                                <div class="category-header-left">
                                    <svg class="category-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                    <span class="category-name">${this.formatCategoryName(catName)}</span>
                                </div>
                                <div class="category-header-right">
                                    <div class="category-progress">
                                        <div class="category-progress-bar">
                                            <div class="category-progress-fill" style="width: ${progress}%"></div>
                                        </div>
                                        <span class="category-progress-text">${progress}%</span>
                                    </div>
                                    <span class="category-count">${controls.length} controls</span>
                                </div>
                            </div>
                            <div class="category-content">
                                ${controls.map(ctrl => this.renderControlRow(ctrl)).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = categoryHtml;
            },

            // Format category name for display
            formatCategoryName(name) {
                return name
                    .replace(/([A-Z])/g, ' $1')
                    .replace(/^./, str => str.toUpperCase())
                    .replace(/_/g, ' ')
                    .trim();
            },

            // Render a single control row
            renderControlRow(ctrl) {
                const statusClass = `status-${ctrl.status.replace('_', '-')}`;

                // Determine scan state
                const isScanFlagged = ctrl.scan_source && !ctrl.scan_verified_at;
                const isScanVerified = ctrl.scan_source && ctrl.scan_verified_at;
                const rowClass = isScanFlagged ? 'scan-flagged' : (isScanVerified ? 'scan-verified' : '');

                // Build scan badge HTML
                let scanBadgeHtml = '';
                if (isScanVerified) {
                    scanBadgeHtml = `<span class="scan-badge scan-badge-verified"> Verified</span>`;
                } else if (isScanFlagged) {
                    scanBadgeHtml = `<span class="scan-badge scan-badge-finding"> Scan Finding</span>`;
                } else if (ctrl.status === 'partial' || ctrl.status === 'non_compliant') {
                    scanBadgeHtml = `<span class="scan-badge scan-badge-manual">Manual Review</span>`;
                }

                // Build scan info HTML
                let scanInfoHtml = '';
                if (ctrl.scan_source) {
                    const scanSource = ctrl.scan_source.toUpperCase();
                    const findingType = ctrl.scan_finding_type || 'Unknown';
                    scanInfoHtml = `
                        <div class="scan-info">
                            <span class="scan-domain">${scanSource}: ${findingType}</span>
                        </div>
                    `;
                }

                // Build re-scan button HTML
                let rescanBtnHtml = '';
                if (isScanFlagged && ctrl.scan_domain) {
                    rescanBtnHtml = `
                        <button class="btn-rescan" onclick="event.stopPropagation(); ComplianceManager.verifyFix(${ctrl.id}, '${ctrl.scan_domain}')" title="Re-scan to verify fix">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                            </svg>
                            Re-scan
                        </button>
                    `;
                }

                return `
                    <div class="control-row ${rowClass}" data-control-id="${ctrl.id}">
                        <div class="control-id">
                            ${ctrl.control_id}
                            ${scanBadgeHtml}
                        </div>
                        <div class="control-info">
                            <h5>${ctrl.control_name}</h5>
                            ${scanInfoHtml}
                        </div>
                        <div class="control-status-select">
                            <select class="${statusClass}" onchange="ComplianceManager.updateControlStatus(${ctrl.id}, this.value, this)">
                                <option value="not_tested" ${ctrl.status === 'not_tested' ? 'selected' : ''}>Not Tested</option>
                                <option value="partial" ${ctrl.status === 'partial' ? 'selected' : ''}>In Progress</option>
                                <option value="compliant" ${ctrl.status === 'compliant' ? 'selected' : ''}>Compliant</option>
                                <option value="non_compliant" ${ctrl.status === 'non_compliant' ? 'selected' : ''}>Non-Compliant</option>
                            </select>
                        </div>
                        <div class="control-notes">
                            <input type="text" placeholder="Add notes..." value="${ctrl.remediation_notes || ''}" onchange="ComplianceManager.updateControlNotes(${ctrl.id}, this.value)">
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            ${rescanBtnHtml}
                            <button class="btn-evidence" onclick="ComplianceManager.openEvidenceModal(${ctrl.id}, '${ctrl.control_id}', '${ctrl.control_name.replace(/'/g, "\\'")}')">
                                <span>Evidence</span>
                            </button>
                        </div>
                    </div>
                `;
            },

            // Toggle category expansion
            toggleCategory(header) {
                const group = header.closest('.category-group');
                group.classList.toggle('expanded');
            },

            // Update control status
            async updateControlStatus(controlId, status, selectEl) {
                try {
                    const response = await fetch(`http://localhost:5000/api/compliance/control/${controlId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });

                    const data = await response.json();
                    if (!data.success) throw new Error(data.error);

                    // Update select styling
                    selectEl.className = `status-${status.replace('_', '-')}`;

                    // Refresh assessment to update stats
                    await this.loadAssessment(this.currentAssessmentId);

                } catch (error) {
                    console.error('Error updating control:', error);
                    alert('Failed to update control status');
                }
            },

            // Update control notes
            async updateControlNotes(controlId, notes) {
                try {
                    await fetch(`http://localhost:5000/api/compliance/control/${controlId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ remediation_notes: notes })
                    });
                } catch (error) {
                    console.error('Error updating notes:', error);
                }
            },

            // Filter controls by search
            filterControls(query) {
                const rows = document.querySelectorAll('.control-row');
                const lowerQuery = query.toLowerCase();

                rows.forEach(row => {
                    const id = row.querySelector('.control-id').textContent.toLowerCase();
                    const name = row.querySelector('.control-info h5').textContent.toLowerCase();
                    const matches = id.includes(lowerQuery) || name.includes(lowerQuery);
                    row.style.display = matches ? '' : 'none';
                });
            },

            // Open evidence modal
            async openEvidenceModal(controlId, controlCode, controlName) {
                this.currentControlId = controlId;

                document.getElementById('evidenceControlId').textContent = controlCode;
                document.getElementById('evidenceControlName').textContent = controlName;

                // Clear form
                document.getElementById('evidenceTitle').value = '';
                document.getElementById('evidenceDescription').value = '';
                document.getElementById('evidenceType').value = 'document';
                document.getElementById('evidenceFile').value = '';

                // Load existing evidence
                await this.loadEvidence(controlId);

                document.getElementById('evidenceModal').classList.add('active');
            },

            // Close evidence modal
            closeEvidenceModal() {
                document.getElementById('evidenceModal').classList.remove('active');
                this.currentControlId = null;
            },

            // Load evidence for a control
            async loadEvidence(controlId) {
                const listContainer = document.getElementById('evidenceList');

                try {
                    const response = await fetch(`http://localhost:5000/api/compliance/evidence/${controlId}`);
                    const data = await response.json();

                    if (!data.success) throw new Error(data.error);

                    if (data.evidence.length === 0) {
                        listContainer.innerHTML = `
                            <div class="evidence-list-header">
                                <h4>Uploaded Evidence</h4>
                            </div>
                            <p style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
                                No evidence uploaded yet
                            </p>
                        `;
                        return;
                    }

                    listContainer.innerHTML = `
                        <div class="evidence-list-header">
                            <h4>Uploaded Evidence (${data.evidence.length})</h4>
                        </div>
                        ${data.evidence.map(ev => `
                            <div class="evidence-item">
                                <div class="evidence-item-left">
                                    <div class="evidence-item-icon">${this.getEvidenceIcon(ev.evidence_type)}</div>
                                    <div class="evidence-item-info">
                                        <h5>${ev.title}</h5>
                                        <p>${ev.evidence_type} &bull; ${new Date(ev.created_at).toLocaleDateString()}</p>
                                    </div>
                                </div>
                                <button class="btn-evidence-delete" onclick="ComplianceManager.deleteEvidence(${ev.id})">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    `;

                } catch (error) {
                    console.error('Error loading evidence:', error);
                    listContainer.innerHTML = `<p style="color: #ef4444;">Failed to load evidence</p>`;
                }
            },

            // Get icon for evidence type
            getEvidenceIcon(type) {
                const icons = {
                    'document': '',
                    'screenshot': '',
                    'scan': '',
                    'log': '',
                    'note': ''
                };
                return icons[type] || '';
            },

            // Save evidence
            async saveEvidence() {
                const title = document.getElementById('evidenceTitle').value.trim();
                const description = document.getElementById('evidenceDescription').value.trim();
                const evidenceType = document.getElementById('evidenceType').value;

                if (!title) {
                    alert('Please enter a title for the evidence');
                    return;
                }

                try {
                    const response = await fetch('http://localhost:5000/api/compliance/evidence', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            control_id: this.currentControlId,
                            title,
                            description,
                            evidence_type: evidenceType
                        })
                    });

                    const data = await response.json();
                    if (!data.success) throw new Error(data.error);

                    // Reload evidence list
                    await this.loadEvidence(this.currentControlId);

                    // Clear form
                    document.getElementById('evidenceTitle').value = '';
                    document.getElementById('evidenceDescription').value = '';

                } catch (error) {
                    console.error('Error saving evidence:', error);
                    alert('Failed to save evidence');
                }
            },

            // Delete evidence
            async deleteEvidence(evidenceId) {
                if (!confirm('Are you sure you want to delete this evidence?')) return;

                try {
                    const response = await fetch(`http://localhost:5000/api/compliance/evidence/${evidenceId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    if (!data.success) throw new Error(data.error);

                    // Reload evidence list
                    await this.loadEvidence(this.currentControlId);

                } catch (error) {
                    console.error('Error deleting evidence:', error);
                    alert('Failed to delete evidence');
                }
            },

            // Show frameworks view
            showFrameworks() {
                document.getElementById('assessmentView').classList.remove('active');
                document.getElementById('frameworksView').style.display = 'block';
                this.loadFrameworks();
            },

            // Export report
            async exportReport() {
                try {
                    const response = await fetch(`http://localhost:5000/api/compliance/export/${this.currentAssessmentId}`);
                    const data = await response.json();

                    if (!data.success) throw new Error(data.error);

                    // Create downloadable JSON
                    const blob = new Blob([JSON.stringify(data.export, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `compliance-report-${this.currentFramework}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                } catch (error) {
                    console.error('Error exporting report:', error);
                    alert('Failed to export report');
                }
            },

            // ============================================
            // SCAN INTEGRATION METHODS
            // ============================================

            // Load scan summary for the current assessment
            async loadScanSummary() {
                if (!this.currentAssessmentId) return;

                try {
                    const response = await fetch(`http://localhost:5000/api/compliance/scan-summary/${this.currentAssessmentId}`);
                    const data = await response.json();

                    if (!data.success) return;

                    const card = document.getElementById('scanSummaryCard');
                    // API returns: total_flagged, verified, unverified, by_finding_type, by_severity
                    const flaggedCount = data.total_flagged || 0;
                    const verifiedCount = data.verified || 0;

                    if (flaggedCount > 0 || verifiedCount > 0) {
                        card.style.display = 'flex';
                        document.getElementById('scanFlaggedCount').textContent = flaggedCount;
                        document.getElementById('scanVerifiedCount').textContent = verifiedCount;

                        // Extract finding types for display
                        const findingTypes = Object.keys(data.by_finding_type || {});
                        if (findingTypes.length > 0) {
                            const typeNames = findingTypes.slice(0, 3).map(t => {
                                const info = data.by_finding_type[t];
                                return info.name || t;
                            });
                            document.getElementById('scanSummaryText').textContent =
                                `Scan findings: ${typeNames.join(', ')}${findingTypes.length > 3 ? ` +${findingTypes.length - 3} more` : ''}`;
                        }
                    } else {
                        card.style.display = 'none';
                    }

                } catch (error) {
                    console.error('Error loading scan summary:', error);
                }
            },

            // Open the import from scans modal
            async openImportModal() {
                const modal = document.getElementById('importScanModal');
                const select = document.getElementById('importDomainSelect');

                // Reset modal state
                document.getElementById('importPreview').style.display = 'none';
                document.getElementById('importResults').style.display = 'none';
                document.getElementById('importAnalyzeBtn').style.display = 'inline-flex';
                document.getElementById('importConfirmBtn').style.display = 'none';
                this.scanAnalysisData = null;

                // Load available domains from XASM and Lightbox scans
                try {
                    const response = await fetch('http://localhost:5000/api/xasm/cached-domains');
                    const data = await response.json();

                    if (data.success && data.domains && data.domains.length > 0) {
                        this.availableDomains = data.domains;
                        select.innerHTML = `
                            <option value="">Select a domain...</option>
                            ${data.domains.map(d => {
                                const scanTypes = [];
                                if (d.has_xasm) scanTypes.push('XASM');
                                if (d.has_lightbox) scanTypes.push('Lightbox');
                                return `<option value="${d.domain}">${d.domain} (${scanTypes.join(' + ')})</option>`;
                            }).join('')}
                        `;
                    } else {
                        select.innerHTML = '<option value="">No scanned domains found</option>';
                    }

                } catch (error) {
                    console.error('Error loading domains:', error);
                    select.innerHTML = '<option value="">Error loading domains</option>';
                }

                modal.classList.add('active');
            },

            // Close the import modal
            closeImportModal() {
                document.getElementById('importScanModal').classList.remove('active');
                this.scanAnalysisData = null;
                this.selectedDomain = null;
            },

            // Analyze scans for selected domain
            async analyzeDomain() {
                const select = document.getElementById('importDomainSelect');
                const domain = select.value;

                if (!domain) {
                    alert('Please select a domain to analyze');
                    return;
                }

                this.selectedDomain = domain;
                const analyzeBtn = document.getElementById('importAnalyzeBtn');
                const previewDiv = document.getElementById('importPreview');
                const previewContent = document.getElementById('importPreviewContent');

                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<span class="compliance-spinner" style="width: 14px; height: 14px; margin-right: 6px;"></span> Analyzing...';

                try {
                    // Call the analyze-scan endpoint
                    const response = await fetch('http://localhost:5000/api/compliance/analyze-scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            domain: domain,
                            framework: this.currentFramework,
                            assessment_id: this.currentAssessmentId
                        })
                    });

                    const data = await response.json();

                    if (!data.success) throw new Error(data.error);

                    this.scanAnalysisData = data;

                    // Show preview
                    const affectedCount = data.affected_controls ? data.affected_controls.length : 0;
                    const vulnCount = data.vulnerabilities_found ? data.vulnerabilities_found.length : 0;

                    previewContent.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 12px;">
                            <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">${vulnCount}</div>
                                <div style="font-size: 11px; color: #888;">Vulnerabilities Found</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: 700; color: #ef4444;">${affectedCount}</div>
                                <div style="font-size: 11px; color: #888;">Controls to Flag</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: 700; color: #22c55e;">${data.evidence_items || 0}</div>
                                <div style="font-size: 11px; color: #888;">Evidence Items</div>
                            </div>
                        </div>
                        ${data.vulnerabilities_found && data.vulnerabilities_found.length > 0 ? `
                        <div style="margin-top: 8px;">
                            <strong style="color: #fff;">Findings:</strong>
                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                ${data.vulnerabilities_found.slice(0, 5).map(v => `<li>${v}</li>`).join('')}
                                ${data.vulnerabilities_found.length > 5 ? `<li style="color: #888;">...and ${data.vulnerabilities_found.length - 5} more</li>` : ''}
                            </ul>
                        </div>
                        ` : '<p>No security findings detected in recent scans.</p>'}
                    `;

                    previewDiv.style.display = 'block';

                    // Show confirm button if there are controls to flag
                    if (affectedCount > 0) {
                        document.getElementById('importConfirmBtn').style.display = 'inline-flex';
                    }

                } catch (error) {
                    console.error('Error analyzing domain:', error);
                    previewContent.innerHTML = `<p style="color: #ef4444;">Error analyzing scans: ${error.message}</p>`;
                    previewDiv.style.display = 'block';

                } finally {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        Analyze Scans
                    `;
                }
            },

            // Confirm import and flag controls
            async confirmImport() {
                if (!this.scanAnalysisData || !this.selectedDomain) {
                    alert('Please analyze a domain first');
                    return;
                }

                const confirmBtn = document.getElementById('importConfirmBtn');
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="compliance-spinner" style="width: 14px; height: 14px; margin-right: 6px;"></span> Importing...';

                try {
                    const response = await fetch('http://localhost:5000/api/compliance/flag-from-scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            domain: this.selectedDomain,
                            framework: this.currentFramework,
                            assessment_id: this.currentAssessmentId
                        })
                    });

                    const data = await response.json();

                    if (!data.success) throw new Error(data.error);

                    // Show results
                    document.getElementById('importPreview').style.display = 'none';
                    document.getElementById('importResults').style.display = 'block';
                    document.getElementById('importResultsText').textContent =
                        `Successfully flagged ${data.controls_flagged} controls and added ${data.evidence_added} evidence items.`;

                    // Hide buttons
                    document.getElementById('importAnalyzeBtn').style.display = 'none';
                    document.getElementById('importConfirmBtn').style.display = 'none';

                    // Reload assessment after a short delay
                    setTimeout(async () => {
                        await this.loadAssessment(this.currentAssessmentId);
                        this.closeImportModal();
                    }, 2000);

                } catch (error) {
                    console.error('Error importing findings:', error);
                    alert('Failed to import findings: ' + error.message);
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/>
                            <polyline points="15 3 21 3 21 9"/>
                            <line x1="10" y1="14" x2="21" y2="3"/>
                        </svg>
                        Import & Flag Controls
                    `;
                }
            },

            // Verify a fix by re-scanning
            async verifyFix(controlId, domain) {
                if (!confirm(`This will trigger a re-scan of ${domain} to verify the fix. Continue?`)) {
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:5000/api/compliance/verify-fix/${controlId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ domain })
                    });

                    const data = await response.json();

                    if (!data.success) throw new Error(data.error);

                    if (data.verified) {
                        alert('Fix verified! The vulnerability was not detected in the latest scan.');
                    } else {
                        alert('Fix not verified. The vulnerability is still present in the latest scan.');
                    }

                    // Reload assessment to update UI
                    await this.loadAssessment(this.currentAssessmentId);

                } catch (error) {
                    console.error('Error verifying fix:', error);
                    alert('Failed to verify fix: ' + error.message);
                }
            }
        };

        // Initialize compliance tab when switching to it
        function initComplianceTab() {
            ComplianceManager.init();
        }
    
        // XASM Filter Functions
        function filterFindings(severity) {
            // Update active button state
            document.querySelectorAll('.xasm-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === severity) {
                    btn.classList.add('active');
                }
            });

            // Filter the findings cards
            document.querySelectorAll('.dashboard-card, .xasm-finding-card').forEach(card => {
                if (severity === 'all') {
                    card.style.display = '';
                } else {
                    const cardSeverity = card.dataset?.severity || '';
                    card.style.display = cardSeverity.toLowerCase() === severity ? '' : 'none';
                }
            });
        }

        function searchFindings(query) {
            const lowerQuery = query.toLowerCase();
            document.querySelectorAll('.dashboard-card, .xasm-finding-card').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(lowerQuery) ? '' : 'none';
            });
        }

        function sortFindings(sortBy) {
            console.log('Sorting by:', sortBy);
            // Sorting would require more complex DOM manipulation
            // This is a placeholder for the sorting functionality
        }

        // Export functions (placeholders)
        function exportAsPDF() {
            alert('PDF export feature coming soon!');
        }

        function exportAsCSV() {
            alert('CSV export feature coming soon!');
        }

    </script>
</body>
</html>
